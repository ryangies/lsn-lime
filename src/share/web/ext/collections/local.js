// 

js.extend('ext.collections.model',function(js){var CFilesystemNode=js.ext.share.filesystem.Node;var CNode=this.Node=function(data,tree){CFilesystemNode.apply(this,arguments);this.schema=null;};var _proto=this.Node.prototype=js.lang.createMethods(CFilesystemNode);_proto.createNode=function(data){js.lang.assert(this!==this.rootNode);return this.rootNode.createNode.apply(this.rootNode,arguments);};_proto.sortCompare=function(a,b){if(!(js.util.defined(a)&&js.util.defined(b)))return;var av=a.data.getIndex();var bv=b.data.getIndex();var rv=av-bv;return rv;};_proto.canDisplay=function(){return this.data&&this.data.isDataContainer();};_proto.canExpand=function(){return false;};_proto.getName=function(){var schema=this.getSchema();var fieldName=schema.nameField.getName();return this.data.getValue(fieldName);};_proto.getIconPath=function(){return this.getSchema().getIconPath();};_proto.getType=function(){return this.data.getValue('schema');};_proto.getTargetAddress=function(){return this.data.getDataNode().getAddress();};_proto.getCrumbPath=function(){var name=[];var node=this;while(node&&node!==this.rootNode){name.unshift(node.getName());node=node.parentNode;}
return name.join(' > ');};_proto.getAppendage=function(){return this.getTarget();};_proto.getSchema=function(){return this.schema;};_proto.getTarget=function(){return this.data.getDataNode();};_proto.getTargetSchema=function(){return this.schema;};_proto.getChildSchema=function(name){return this.getAvailableSchemas()[0];};_proto.getAvailableChildSchemas=function(){var manifest=this.getSchema().getChildManifest();return manifest?manifest.schemas:[];};});js.extend('ext.collections.model',function(js){var _package=this;var CNode=_package.Node;_package.CollectionList=function(){CNode.apply(this,arguments);this.schema=env.schemas.fetch("collection-list");};var _proto=_package.CollectionList.prototype=js.lang.createMethods(CNode);_proto.populate=function(){this.target=this.data.getValue('items');this.target.addActionListener('*',this.onDataAction,this);this.populateValues(this.target);};_proto.canExpand=function(){return true;};_proto.createNode=function(data){var ctor=js.ext.collections.model.factory.get('collection');return new ctor(data,this.tree);};_proto.getAppendage=function(){return this.getDataNode().getValue('items');};_proto.getAvailableChildSchemas=function(){return[env.schemas.fetch('collection-definition')];};_proto.getType=function(){return'collection-list';};});js.extend('ext.collections.model',function(js){var _package=this;var CBaseNode=_package.Node;_package.CollectionDefinition=function(data,tree){CBaseNode.apply(this,arguments);this.schema=env.schemas.fetch("collection-definition");this.target=null;this.targetSchema=null;};var _proto=_package.CollectionDefinition.prototype=js.lang.createMethods(CBaseNode);_proto.createNode=function(data){var ctor=js.ext.collections.model.factory.get('item');return new ctor(data,this.tree);};_proto.populate=function(){if(!this.target)return;if(this.target.isDirectory()){var commands=[];this.target.iterate(function(name,dnode){commands.push(['fetch',dnode.getAddress()]);},this);env.hub.batch(commands,[function(response){this.populateValues(this.target);},this]);}else{this.populateValues(this.target);}};_proto.canExpand=function(){return true;};_proto.loadChildren=function(cb){if(this.target){this.populateChildren();this.target.reload(cb);}};_proto.onAdopted=function(action){this.preload();};_proto.preload=function(){var commands=[['fetch',this.data.getString('storage')],['fetch',this.data.getString('schema')]];this.data.getDataBridge().batch(commands,[this.onPreload,this]);};_proto.onPreload=function(commands){this.setup(commands[0].getResult(),commands[1].getResult());};_proto.setup=function(dnodeStorage,dnodeSchema,cb){var schema=dnodeSchema||dnodeStorage.get('schema');env.schemas.fetch(schema,[this.onLoadSchema,this,[dnodeStorage,cb]]);};_proto.onLoadSchema=function(schema,dnodeStorage,cb){var manifest=schema.getChildManifest();var dnodeTarget=manifest&&manifest.name?dnodeStorage.get(manifest.name):dnodeStorage;this.target=dnodeTarget||dnodeStorage;this.target.addActionListener('*',this.onDataAction,this);this.targetSchema=schema;this.populate();if(cb)js.lang.callback(cb);};_proto.getType=function(){return'collection-definition';};_proto.getTarget=function(){return this.target;};_proto.getTargetSchema=function(){return this.targetSchema;};_proto.getChildSchema=function(name){if(name){return env.schemas.fetch(this.targetSchema.getDataNode().getStorage().getValue(name));}
return this.targetSchema;};_proto.getAvailableChildSchemas=function(){return[this.targetSchema];};});js.extend('ext.collections.model',function(js){var _package=this;var CNode=_package.Node;_package.ItemNode=function(data,tree){CNode.apply(this,arguments);this.target=null;this.defaultIcon=null;this.isCategory=false;};var _proto=_package.ItemNode.prototype=js.lang.createMethods(CNode);_proto.onAdopted=function(){try{var manifest=this.getSchema().getChildManifest();if(manifest){this.isCategory=true;this.target=this.getDataNode().getValue(manifest.name);this.target.addActionListener('*',this.onDataAction,this);}}catch(ex){js.console.log('Could not provide storage for child nodes');}};_proto.createNode=function(data){var ctor=js.ext.collections.model.factory.get('item');return new ctor(data,this.tree);};_proto.getSchema=function(){if(!this.schema){var name=this.getTarget().getString('schema');this.schema=this.parentNode.getChildSchema(name);}
return this.schema;};_proto.populate=function(){this.populateValues(this.target);};_proto.getAppendage=function(){return this.target||this.data;};_proto.canExpand=function(){return this.isCategory;};_proto.getType=function(){return this.isCategory?'category':this.data.getValue('schema');};_proto.getChildSchema=function(name){if(name)return this.parentNode.getChildSchema(name);var manifest=this.getSchema().getChildManifest();return manifest.schemas[0];};});js.extend('ext.collections.model',function(js){var _package=this;_package.factory=new js.ext.share.ObjectFactory();_package.factory.set('collections',js.ext.collections.model.CollectionList);_package.factory.set('collection-list',js.ext.collections.model.CollectionList);_package.factory.set('collection',js.ext.collections.model.CollectionDefinition);_package.factory.set('collection-definition',js.ext.collections.model.CollectionDefinition);_package.factory.set('item',js.ext.collections.model.ItemNode);env.schemas.load(js.data.fromObject({"collection-list":{"label":"List of Collections","icon":"/res/icons/16x16/emblems/database.png","fields":[{"name":"name","type":"text"}],"children":{"name":"items","type":"array","schema":"collection-definition"}},"collection-definition":{"label":"Collection Definition","icon":"/res/icons/16x16/emblems/library.png","fields":[{"name":"name","label":"Name","type":"text"},{"name":"storage","label":"Storage","type":"text"},{"name":"schema","label":"Schema","type":"text"},]}}));});js.extend('ext.collections.target',function(js){var _package=this;_package.DataListener=function(selection){this.dataListeners=this.als||[];this.addActionListener('onAdopted',this.attachDataListener,this);this.addActionListener('onOrphaned',this.detachDataListener,this);};var _proto=_package.DataListener.prototype=js.lang.createMethods();_proto.detachDataListener=function(){for(var i=0,al;al=this.dataListeners[i];i++){al.remove();}
this.dataListeners=[];};_proto.attachDataListener=function(){var al=this.data.addActionListener('*',this.onDataAction,this);this.dataListeners.push(al);};_proto.onDataAction=function(action,dnode){var args=js.util.args(arguments);switch(action.name){case'create':try{this.insertChild(dnode);}catch(ex){}
break;case'usercreate':this.select();break;case'update':if(action.updated.order){this.sort();}
this.dispatchAction(action,dnode);break;case'remove':if(dnode===this.getDataNode()){try{if(this.isSelected()){var newSelection=this.nextSibling||this.previousSibling;if(newSelection){newSelection.select();}else{this.deselect();}}}catch(ex){js.error.reportError(ex);}finally{this.parentNode.removeChild(this);}}
break;case'change':this.dispatchAction('onUpdate',this);break;}};});js.extend('ext.collections.target',function(js){var _package=this;var CNodeBase=js.data.Node;var CDataListener=js.ext.collections.target.DataListener;_package.Node=function(data){CNodeBase.apply(this,arguments);CDataListener.apply(this);};var _proto=_package.Node.prototype=js.lang.createPrototype(CNodeBase,CDataListener);_proto.createNode=function(data){return new _package.Node(data);};_proto.sortCompare=function(a,b){if(!(js.util.defined(a)&&js.util.defined(b)))return;var av=a.data.getIndex();var bv=b.data.getIndex();var rv=av-bv;return rv;};_proto.canDisplay=function(){return true;};_proto.getName=function(){return this.data.getKey();};_proto.getType=function(){return this.data.getType();};_proto.getIconPath=function(){return this.data.getIcon();};_proto.getTargetAddress=function(){return this.data.getAddress();};_proto.getCrumbPath=function(){return this.getTargetAddress();};});js.extend('ext.collections.target',function(js){var CNodeBase=js.ext.collections.target.Node;var CSelectable=js.ext.share.data.model.Selectable;var CNode=this.Item=function(dnode){CNodeBase.apply(this,arguments);CSelectable.apply(this);this.super=CNodeBase.prototype;this.schema=null;this.defaultIcon='/res/icons/16x16/emblems/directory-object.png';};var _proto=this.Item.prototype=js.lang.createMethods(CNodeBase,CSelectable);_proto.onAdopted=function(){var schema=this.getSchema();this.nameFieldName=schema&&schema.nameField?schema.nameField.getName():null;};_proto.createNode=function(data){};_proto.getSchema=function(name){if(!this.schema){var myName=this.getDataNode().getString('schema');this.schema=this.parentNode.getSchema(myName);}
return name?this.schema.getSchema(name):this.schema;};_proto.getIconPath=function(){return this.getSchema().getIconPath();};_proto.getName=function(){return this.nameFieldName?this.data.get(this.nameFieldName):this.data.getKey();};});js.extend('ext.collections.target',function(js){var CNodeBase=js.ext.collections.target.Node;var CSelection=js.ext.share.Selection;this.Collection=function(storage,schema){CSelection.call(this);CNodeBase.call(this);this.schema=schema;this.load(storage);};var _proto=this.Collection.prototype=js.lang.createMethods(CSelection,CNodeBase);_proto.CNode=js.ext.collections.target.Item;_proto.setDataNode=function(dnode){this.unload();this.data=dnode;this.attachDataListener();};_proto.getDataNode=function(){return this.data;};_proto.getSchema=function(name){return name?this.schema.getSchema(name):this.schema;};_proto.createNode=function(dnode){var node=new this.CNode(dnode);node.addActionListener('onclick',function(action,node){this.dispatchAction('onItemClick',node);},this);return node;};_proto.load=function(itemsNode){this.setDataNode(itemsNode);var items=itemsNode.values();for(var i=0,item;item=items[i];i++){item.load([this.insertChild,this]);}};_proto.unload=function(){this.detachDataListener();this.removeAllChildren();this.data=null;};_proto.canDisplay=function(){return false;};});js.extend('ext.collections.view',function(js){var CTreeView=js.ext.share.filesystem.view.SelectView;var CTreeViewLayer=js.ext.share.filesystem.view.SelectViewLayer;this.TreeView=function(name,tree){CTreeView.apply(this,arguments);};var _proto=this.TreeView.prototype=js.lang.createMethods(CTreeView);_proto.Layer=function(node,name,view){CTreeViewLayer.apply(this,arguments);};var Layer=_proto.Layer.prototype=js.lang.createMethods(CTreeViewLayer);Layer.extendUI=function(){this.svName=this.node.getName();this.svName.tie(this.uiName,['innerHTML']);};Layer.onClick=function(event){js.dom.stopEvent(event);this.node.setAsCwd();this.node.select();};});js.extend('ext.collections.view',function(js){var CBaseCrumbView=js.ext.share.filesystem.view.CrumbView;var CBaseCrumbViewLayer=js.ext.share.filesystem.view.CrumbView.prototype.Layer;this.CrumbView=function(name,tree){CBaseCrumbView.apply(this,arguments);};var CrumbView=this.CrumbView.prototype=js.lang.createMethods(CBaseCrumbView);CrumbView.Layer=function(node,name,view){CBaseCrumbViewLayer.apply(this,arguments);};var Layer=CrumbView.Layer.prototype=js.lang.createMethods(CBaseCrumbViewLayer);Layer.extendUI=function(){this.svName=this.node.getName();this.svName.tie(this.uiName,['innerHTML']);};Layer.updateUI=function(){var addr=this.node.getTargetAddress();js.dom.setAttribute(this.uiAnchor,'href',addr);js.dom.setAttribute(this.uiAnchor,'title',addr);js.dom.setAttribute(this.uiIcon,'src',this.node.getIconPath());};Layer.onClick=function(event){CBaseCrumbViewLayer.prototype.onClick.apply(this,arguments);this.node.select();}});js.extend('ext.collections.view',function(js){var _package=this;var CView=js.ext.share.ui.View;var CFactory=js.ext.share.ObjectFactory;_package.EditView=function(tree){CView.apply(this);this.factory=new CFactory();this.editor=null;this.editors={};this.factory.set('summary',js.ext.collections.Editor,true);this.factory.set('hash',js.ext.editors.hash.Editor);if(tree)this.setModel(tree);};var _proto=_package.EditView.prototype=js.lang.createMethods(CView);_proto.setModel=function(tree){js.lang.assert(!this.tree);this.tree=tree;this.tree.addActionListener('onSelect',this.onSelectNode,this);this.tree.addActionListener('onDeselect',this.onDeselectNode,this);};_proto.createElements=function(){this.uiEditMenu=js.dom.createElement('DIV.editors-menu');this.uiEditArea=js.dom.createElement('DIV.editors-area');return[this.uiEditArea];};_proto.getMenuElements=function(){return[this.uiEditMenu];};_proto.onDeselectNode=function(action,mnode){if(this.editor){this.editor.hide();this.editor=null;js.dom.scrollTo(this.uiEditArea);js.dom.removeChildren(this.uiEditMenu);}};_proto.onSelectNode=function(action,mnode){this.editor=this.getEditor(mnode);if(this.editor){this.editor.load(mnode);this.editor.show(this.uiEditArea);try{var menu=this.editor.getMenu();if(menu)js.dom.replaceChildren(this.uiEditMenu,menu.getElements());}catch(ex){js.error.reportError(ex);}}};_proto.getEditor=function(mnode){try{if(js.util.isa(mnode,js.ext.collections.model.CollectionList))return;var type=mnode.canExpand()?'summary':'hash';var schemaId=mnode.getTargetSchema().getId();if(!schemaId)throw new Error('Schema does not have an ID');var id=type+':'+schemaId;var editor=this.editors[id];if(!editor){editor=this.factory.createObject(type,id);editor.setOption('autoCommit',true);this.editors[id]=editor;}
return editor;}catch(ex){js.error.reportError(ex);}};});js.extend('ext.collections.view',function(js){var _package=this;var COverlayView=js.ext.share.ui.Overlay;var CPropertiesView=_package.PropertiesView=function(){COverlayView.apply(this,arguments);this.editor=null;this.editors={};};var _proto=CPropertiesView.prototype=js.lang.createPrototype(COverlayView);_proto.onDialogShow=function(mnode){this.editor=this.vivifyEditor(mnode);if(this.editor){this.editor.load(mnode.getDataNode());this.editor.show(this.getElementById('content'));}};_proto.onDialogHide=function(){js.dom.removeChildren(this.getElementById('content'));};_proto.vivifyEditor=function(mnode){try{var schema=mnode.getSchema();var id=schema.getId();var editor=this.editors[id];if(!editor){if(!schema)throw new Error('No schema available');this.editors[id]=editor=new js.ext.editors.hash.Editor(id,schema);editor.setOption('autoCommit',true);}
return editor;}catch(ex){js.console.log(ex);}};});js.extend('ext.collections.view',function(js){var _package=this;var CBaseView=js.ext.share.ui.Dialog;var CCreateView=_package.CreateView=function(){CBaseView.apply(this,arguments);this.editor=null;this.editors={};};var _proto=CCreateView.prototype=js.lang.createPrototype(CBaseView);_proto.onDialogShow=function(schema,cb){this.editor=this.vivifyEditor(schema);if(this.editor){this.cb=cb;this.editor.view.setup();this.editor.show(this.getElementById('content'));}};_proto.onDialogHide=function(){this.cb=null;this.editor=null;js.dom.removeChildren(this.getElementById('content'));};_proto.invokeCallback=function(){if(this.cb)js.lang.callback(this.cb,this,[this.getValues()]);};_proto.getValues=function(){return this.editor.view.form.getValues();};_proto.vivifyEditor=function(schema){try{var id=schema.getId();var editor=this.editors[id];if(!editor){if(!schema)throw new Error('No schema available');this.editors[id]=editor=new js.ext.editors.hash.Editor(id,schema);editor.setOption('autoCommit',true);}
return editor;}catch(ex){js.console.log(ex);}};});js.extend('ext.collections.view',function(js){var CBaseView=js.ext.share.ui.View;this.SummaryView=function(tree,schema){CBaseView.apply(this);this.layerName='ext-collections-summary-view'+'-'+schema.getId();this.action='ext-collections-edit-item';this.rootLayer=null;this.model=tree.rootNode;this.schema=schema;this.model.addLayer(this.layerName,this);this.createHeaders();};var _proto=this.SummaryView.prototype=js.lang.createMethods(CBaseView);_proto.unload=function(){this.model.removeLayer(this.layerName);this.rootLayer=null;CBaseView.prototype.unload.call(this);};_proto.onPopulationChange=function(action,layerNode){js.dom.toggleClassName(this.table,'empty',!(this.rootLayer&&this.rootLayer.hasChildNodes()));};_proto.createLayer=function(node,name){if(node===this.model){this.rootLayer=new js.data.NodeLayer(node,name);this.rootLayer.addActionListener('onAdopt',this.onPopulationChange,this);this.rootLayer.addActionListener('onOrphan',this.onPopulationChange,this);return this.rootLayer;}
if(node.canDisplay()){try{if(node.getSchema().getId()==this.schema.getId()){return new js.ext.collections.view.SummaryViewItem(node,name,this);}}catch(ex){js.console.log('Could not create item',name);}}};_proto.createElements=function(){this.tbody=js.dom.createElement('TBODY');this.thead=js.dom.createElement('THEAD');this.table=js.dom.createElement('TABLE.tree-list-view.empty',[this.thead,this.tbody]);return[this.table];};_proto.getSchema=function(){return this.schema;};_proto.createHeaders=function(){var headers=[];headers.push(js.dom.createElement('TH.icon'));var fields=this.schema.getSummaryFields();for(var i=0,field;field=fields[i];i++){headers.push(js.dom.createElement('TH='+field.getLabelText()));}
js.dom.appendChild(this.thead,js.dom.createElement('TR',headers));};_proto.getAppendage=function(){return this.tbody;};_proto.getAction=function(){return this.action;};_proto.setAction=function(action){return this.action=action;};});js.extend('ext.collections.view',function(js){var CNodeLayer=js.data.NodeLayer;this.SummaryViewItem=function(node,name,view){CNodeLayer.call(this,node,name);this.view=view;this.schema=node.getSchema().clone();this.nameSwitching=true;this.events=[];this.selectEvent=null;};var _proto=this.SummaryViewItem.prototype=js.lang.createMethods(CNodeLayer);_proto.onAdopted=function(){this.createUI();js.dom.appendChildren(this.view.getAppendage(),this.getElements());};_proto.onOrphaned=function(){this.removeUI();};function _false(event){js.dom.stopEvent(event);return false;}
_proto.getElements=function(){return[this.tr];};_proto.onUpdate=function(action,node){this.updateUI();};_proto.createUI=function(){this.node.addActionListener('onSelect',this.onSelect,this);this.node.addActionListener('onDeselect',this.onDeselect,this);this.node.addActionListener('onUpdate',this.onUpdate,this);this.columns=this.createColumns();this.tr=js.dom.createElement('TR',this.columns);this.events.push(new js.dom.EventListener(this.tr,'click',this.onUserSelect,this),new js.dom.EventListener(this.tr,'dblclick',this.onUserExpand,this),new js.dom.EventListener(this.tr,'select',_false),new js.dom.EventListener(this.tr,'selectstart',_false),new js.dom.EventListener(this.tr,'dragstart',_false));this.uiIcon=js.dom.createElement('IMG.icon',{'width':'16','height':'16'});this.nameLinked=js.dom.createElement('A',{'onClick':[this.invokeAction,this]});this.nameStatic=js.dom.createElement('SPAN');var name=this.nameStatic;this.uiNameArea=js.dom.createElement('SPAN.name',[name]);js.dom.replaceChildren(this.tdIcon,[this.uiIcon]);js.dom.replaceChildren(this.tdName,[this.uiNameArea]);this.extendUI();this.updateUI();};_proto.createColumns=function(){var columns=[];this.tdIcon=js.dom.createElement('TD.icon');this.tdName=js.dom.createElement('TD.name');columns.push(this.tdIcon);columns.push(this.tdName);var fields=this.schema.getSummaryFields();for(var i=1,field;field=fields[i];i++){columns.push(js.dom.createElement('TD'));}
return columns;};_proto.extendUI=function(){var fields=this.schema.getSummaryFields();var nameField=fields[0];if(nameField.data.summary=='edit'){this.nameSwitching=false;}
var dnode=this.node.getDataNode();var iBegin=this.nameSwitching?1:0;for(var i=iBegin,field;field=fields[i];i++){var key=field.getName();this.setCellValue(i,dnode,key,field);}};_proto.updateUI=function(){var fields=this.schema.getSummaryFields();var dnode=this.node.getDataNode();if(this.nameSwitching){var nameField=fields[0];var addr=this.node.getTargetAddress();var innerHTML=dnode.getValue(nameField.getName());js.dom.setAttribute(this.nameLinked,'href',addr);js.dom.setAttribute(this.nameLinked,'title',addr);js.dom.setAttribute(this.nameLinked,'innerHTML',innerHTML);js.dom.setAttribute(this.nameStatic,'innerHTML',innerHTML);}
var icon=this.node.getIconPath();js.dom.setAttribute(this.uiIcon,'src',icon);};_proto.setCellValue=function(i,dnode,key,field){var td=this.columns[i+1];var elements=[];if(field.data.summary=='edit'){field.tieValue(dnode,key,true);elements=field.getElements();}else{field.tieValue(dnode,key);elements=field.getDisplayElements();}
js.dom.replaceChildren(td,elements);};_proto.onReordered=function(){CNodeLayer.prototype.onReordered.call(this);this.insertUI();};_proto.insertUI=function(){try{if(this.nextSibling){js.dom.insertBefore(this.tr,this.nextSibling.tr);}else if(this.previousSibling){js.dom.insertAfter(this.tr,this.previousSibling.tr);}else{this.view.getAppendage().appendChild(this.tr);}}catch(ex){js.error.reportError(ex);}finally{this.updateUI();}};_proto.removeUI=function(){js.dom.removeElements(this.getElements());};_proto.onSelect=function(action,node){js.dom.addClassName(this.tr,'selected');if(this.nameSwitching){js.dom.replaceChildren(this.uiNameArea,[this.nameLinked]);}
if(!this.selectEvent)js.dom.scrollTo(this.tr);this.selectEvent=null;};_proto.onDeselect=function(action,node){js.dom.removeClassName(this.tr,'selected');if(this.nameSwitching)
js.dom.replaceChildren(this.uiNameArea,[this.nameStatic]);};_proto.onUserSelect=function(event){js.dom.stopEvent(event);this.selectEvent=event;if(!js.dom.hasClassName(this.tr,'selected')){this.node.select();}
this.node.getDataNode().fetch();};var _ignoreDoubleClickTags=['INPUT','BUTTON','TEXTAREA','SELECT','A'];_proto.onUserExpand=function(event){if(js.util.grep(event.target.tagName,_ignoreDoubleClickTags))return;this.invokeAction(event);};_proto.invokeAction=function(event){js.dom.stopEvent(event);var action={'name':this.view.getAction(),'event':event}
env.invokeHandler(action,this.node);};});js.extend('ext.collections',function(js){var _package=this;var _strings={"missing_collections":"Collections list not found","on_abandon":"Your changes to will be lost","on_saved":"<b>Saved</b>","on_notsaved":"<b>Changes could not be saved!</b><br><br>It is likely that the file has been modified on the other end.","on_conflict":"<b>Conflict detected.</b><br><br>The file has been modified outside of this editor.<br><br>Discard changes and reload?","on_overwrite":"<b>overwrite this modified file</b>?","on_discard":"<b>Discard changes</b>?"};var COptions=js.impl.Options;var CAction=js.action.ActionDispatcher;var CView=js.ext.share.ui.View;var CEditor=_package.Editor=function(name){COptions.call(this,{'autoCommit':true});CAction.apply(this);CView.apply(this);this.name=name;this.itemMenu=null;this.views=[];};var _proto=CEditor.prototype=js.lang.createMethods(COptions,CAction,CView);_proto.createElements=function(){this.uiRoot=js.dom.createElement('DIV#ext-collections-editor');return[this.uiRoot];};_proto.close=function(){this.unload();this.hide();this.executeClassAction('onClose',this);};_proto.getName=function(){return this.name;};_proto.getTitle=function(){return this.name;};_proto.show=function(appendTo,cb){js.dom.appendChildren(appendTo,this.getElements());this.executeClassAction('onShow',this);if(cb)js.lang.callback(cb);};_proto.hide=function(cb){js.dom.removeElements(this.getElements());this.executeClassAction('onHide',this);if(cb)js.lang.callback(cb);};_proto.load=function(mnode){this.unload();var itemsData=mnode.getAppendage();var itemsSchemas=mnode.getAvailableChildSchemas();this.tree=new js.ext.collections.target.Collection(itemsData,itemsSchemas[0]);for(var i=0;i<itemsSchemas.length;i++){this.createView(itemsSchemas[i],'ext-collections-select-item');}
this.createMenu();this.executeClassAction('onLoad',this);this.executeClassAction('onReady',this);};_proto.loadDataAndSchema=function(itemsData,itemsSchema){this.unload();this.tree=new js.ext.collections.target.Collection(itemsData,itemsSchema);this.createView(itemsSchema);this.createMenu();this.executeClassAction('onLoad',this);this.executeClassAction('onReady',this);};_proto.createView=function(schema,action){var view=new js.ext.collections.view.SummaryView(this.tree,schema);if(action)view.setAction(action);this.views.push(view);js.dom.appendChildren(this.uiRoot,view.getElements());};_proto.reload=function(){this.executeClassAction('onReady',this);};_proto.unload=function(){try{CView.prototype.unload.apply(this);while(this.views.length){this.views.pop().unload();}
if(this.tree)this.tree.deselect();js.dom.removeChildren(this.uiRoot);this.executeClassAction('onUnload',this);}catch(ex){js.console.log(ex);}};_proto.createMenu=function(){var menuData={"items":[{"type":"category","target":"selection","heading":"Selected Item","items":[{"type":"item","text":"Edit","tooltip":"Edit the current item","target":"selection","action":"ext-collections-edit-item","icon":"/res/icons/16x16/emblems/pen.png"},{"type":"item","text":"Change Id","tooltip":"Change this item's key","target":"selection","action":"do-file-rename","icon":"/res/icons/16x16/emblems/key.png"},{"type":"item","text":"Move up","target":"selection","tooltip":"Change the order in which this item appears","action":"data-reorder-previous","icon":"/res/icons/16x16/actions/arrowUp.png","matchTypes":["^data-"]},{"type":"item","text":"Move down","target":"selection","tooltip":"Change the order in which this item appears","action":"data-reorder-next","icon":"/res/icons/16x16/actions/arrowDown.png","matchTypes":["^data-"]},{"type":"item","text":"Delete","tooltip":"Remove permanently","target":"selection","action":"ext-collections-delete-item","icon":"/res/icons/16x16/actions/edit-delete2.png"},]}]};if(this.itemMenu){this.itemMenu.setSelector(this.tree);}else{this.itemMenu=new js.ext.share.ui.menu.PanelMenu(env,this.tree);this.itemMenu.load(menuData);}};_proto.getMenu=function(){return this.itemMenu;};_proto.getStorage=function(){return this.tree?this.tree.getDataNode():null;};_proto.getSchema=function(){return this.tree?this.tree.getSchema():null;};_proto.onUserCreate=function(dnode){var tnode=this.tree.getNodeByData(dnode);if(tnode)tnode.select();};});js.extend('ext.collections',function(js){var CScreen=js.ext.share.Screen;var CRootNode=js.ext.collections.model.CollectionList;var CCrumbView=js.ext.collections.view.CrumbView;var CTreeView=js.ext.collections.view.TreeView;var CEditView=js.ext.collections.view.EditView;var CPanelMenu=js.ext.share.ui.menu.PanelMenu;this.Screen=function(props,target){CScreen.apply(this,[props]);this.hasLoaded=false;this.tree=null;this.menu=null;this.crumbView=null;this.treeView=null;this.target=target;};var _proto=this.Screen.prototype=js.lang.createMethods(CScreen);_proto.load=function(params){if(this.hasLoaded)return;env.showLoading();env.hub.fetch(this.target,[function(dnode){env.hideLoading();if(dnode){this.tree=new js.ext.share.filesystem.Tree(dnode,CRootNode);this.crumbView=new CCrumbView('ext-collections-crumb-view',this.tree);this.treeView=new CTreeView('ext-collections-select-view',this.tree);this.editView=new CEditView(this.tree);this.menu=new CPanelMenu(env,this.tree);this.menu.load({"items":[{"type":"category","heading":"Collections","target":"cwd","items":[{"type":"item","text":"New Collection","tooltip":"Create a new collection","action":"ext-collections-new-collection","icon":"/res/icons/16x16/emblems/library.png","matchTypes":["^collection-list$"]}]},{"type":"category","heading":"Current Collection","target":"cwd","items":[{"type":"item","text":"New Item","tooltip":"Create a new item","action":"ext-collections-new-child","icon":"/res/icons/16x16/categories/book-marks.png","matchTypes":["^collection-definition$","^collection$",]},{"type":"item","text":"Properties&hellip;","tooltip":"Properties","action":"ext-collections-item-properties","icon":"/res/icons/16x16/di/settings.png","matchTypes":["^collection-definition$","^collection$",]},]},{"type":"category","heading":"Current Category","target":"cwd","items":[{"type":"item","text":"New Item","tooltip":"Create a new item","action":"ext-collections-new-child","icon":"/res/icons/16x16/categories/book-marks.png","matchTypes":["^category$"]},{"type":"item","text":"Properties&hellip;","tooltip":"View and update properties of this sitemap item","action":"ext-collections-item-properties","icon":"/res/icons/16x16/di/settings.png","matchTypes":["^category$"]},{"type":"item","text":"Delete Entire Category","target":"selection","tooltip":"Remove the currently selected category and all its items","action":"ext-collections-delete-item","icon":"/res/icons/16x16/actions/edit-delete2.png","matchTypes":["^category$"]},]},]});js.dom.replaceChildren('ext-collections-area3',this.crumbView.getElements());js.dom.replaceChildren('ext-collections-area2',this.treeView.getElements());js.dom.replaceChildren('ext-collections-area5',this.editView.getElements());js.dom.replaceChildren('ext-collections-area6',this.menu.getElements());js.dom.appendChildren('ext-collections-area6',this.editView.getMenuElements());this.tree.rootNode.populate();this.tree.rootNode.setAsCwd();this.tree.rootNode.expand();this.hasLoaded=true;}else{js.dom.replaceChildren('ext-collections-area5',js.dom.createElements('P',{'innerHTML':'Collections list not found'},'TT',{'innerHTML':this.target}));}},this]);};_proto.getModel=function(){return this.tree;};});js.extend('ext.collections',function(js){env.registerHandler('ext-collections-new-collection',function(action,cwd){var schema=cwd.getAvailableChildSchemas()[0];var storage=cwd.getAppendage();env.dialogs.get('ext-collections-create').show(schema,function(values){var addr=js.data.addr_join(storage.getAddress(),'<next>');var manifest=schema.getChildManifest();if(manifest){var subkey=manifest.name;if(!subkey){throw new Error('Child manifest does not specify items subkey');}
values[subkey]=manifest.type=='array'?[]:{};}
env.hub.store(addr,values,function(dnode){if(dnode)dnode.dispatchAction('onUserCreate');});});});function _createItem(storage,schema,key,bEmbedSchemaName){if(!key){key=storage.isDataArray()?'<next>':js.util.rand4()+js.util.rand4();}
var addr=js.data.addr_join(storage.getAddress(),key);var value=schema.getDefaultValues();if(bEmbedSchemaName){value.schema=schema.getName();}
var manifest=schema.getChildManifest();if(manifest){var subkey=manifest.name;if(!subkey){throw new Error('Child manifest does not specify items subkey');}
value[subkey]=manifest.type=='array'?[]:{};}
env.hub.store(addr,value,function(dnode){if(dnode)dnode.dispatchAction('onUserCreate');});}
env.registerHandler('ext-collections-new-item',function(action,editor){_createItem(editor.getStorage(),editor.getSchema());});env.registerHandler('ext-collections-new-child',function(action,cwd){var target=cwd.getTarget();if(target.isDirectory()){var schema=cwd.getTargetSchema();var manifest=schema.getChildManifest();if(!manifest&&js.util.isa(cwd,js.ext.collections.model.CollectionDefinition)){manifest=cwd.getDataNode().toObject();}
var type=manifest.type||'file-text';var params={'type':type,'name':js.util.rand4()+js.util.rand4(),'target':target.getAddress()};if(type!='directory'){params['name']+='.'+(manifest.ext||'hf');params['value']=schema.getDefaultValues();}
env.hub.create(params,function(dnode){if(dnode)dnode.dispatchAction('onUserCreate');});}else{var childSchemas=cwd.getAvailableChildSchemas();function onSelectSchema(action,values){var itemSchema=childSchemas[values.choice];if(!itemSchema)return;_createItem(cwd.getAppendage(),itemSchema,values.id,true);}
if(childSchemas.length>1){var options=[];for(var i=0;i<childSchemas.length;i++){var itemSchema=childSchemas[i];options.push({'value':i,'text':itemSchema.getDataValue('label')});}
var id=js.util.rand4()+js.util.rand4();env.dialogs.get('ext-share-dialog-select').run({'schema':{'fields':[{'name':'choice','label':'Type','type':'select','input':{'options':options}},{'name':'id','label':'Unique identifier','type':'text','value':id}]}},onSelectSchema);}else{_createItem(cwd.getAppendage(),childSchemas[0],null,true);}}});env.registerHandler('ext-collections-select-node-by-data',function(action,dnode,cwd){var node=cwd.getNodeByAddress(dnode.getAddress());node.select();});env.registerHandler('ext-collections-item-properties',function(action,mnode){env.dialogs.get('ext-collections-properties').show(mnode);});env.registerHandler('ext-collections-delete-item',function(action,mnode){var dnode=mnode.getDataNode();var addr=dnode.getAddress();if(confirm('Are you sure you want to delete: '+addr)){dnode.getDataBridge().remove(addr);}});env.registerHandler('ext-collections-select-item',function(action,tnode){var screen=env.screens.get('/ext/collections/');var cwd=screen.tree.getCwd();var mnode=cwd.getNodeByData(tnode.getDataNode());if(mnode){mnode.setAsCwd();mnode.select();}});env.registerHandler('ext-collections-edit-item',function(action,tnode){env.dialogs.get('ext-collections-properties').show(tnode);});});