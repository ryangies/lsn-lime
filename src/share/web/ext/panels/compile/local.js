// 

js.extend('local',function(js){var _input_tags=['INPUT','SELECT','BUTTON','TEXTAREA'];this.Main=function(){this.settings=new js.local.Settings();this.view=new js.local.View();};var _proto=this.Main.prototype=js.lang.createMethods();_proto.attachSimpleButtons=function(elem){js.dom.appendChildren(elem,js.dom.createElements('div',['button=Compile',{'onClick':[this.submitAction,this,['compile']]},'INPUT',{'id':'cbox-toggle','type':'checkbox','onChange':[this.toggleAutohide,this]},'LABEL=Hide excluded and ignored items',{'for':'cbox-toggle'}]));};_proto.attachOutput=function(elem){elem.appendChild(this.view.getRootElement());};_proto.attachAdvancedButtons=function(elem){js.dom.appendChildren(elem,js.dom.createElements('div',['button=Query Local (query)',{'onClick':[this.submitAction,this,['query_local']]},'button=Compile (clean, query, compile)',{'onClick':[this.submitAction,this,['compile']]},'button=Rsync (rsync)',{'onClick':[this.submitAction,this,['rsync']]},]));};_proto.attachSettings=function(elem){elem.appendChild(this.settings.getRootElement());js.dom.appendChildren(elem,js.dom.createElements('div',['button=Save Settings',{'onClick':[this.submitAction,this,['set_config']]},]));};_proto.toggleAutohide=function(event){var checkbox=js.dom.getEventTarget(event);this.view.setAutohide(checkbox.checked);};_proto.submitAction=function(event,name){var req=new js.http.Stream('[#`./module.pm`]/'+name);req.addActionListener('onReceive',this.onReceive,this);req.addEventListener('onCreate',this.onCreate,this);req.addEventListener('onComplete',this.onComplete,this);req.submit(this.settings.getChangedValues());};_proto.onCreate=function(req){var ctrls=js.dom.getElementsByTagName(js.dom.getBody(),_input_tags);for(var i=0,ctrl;ctrl=ctrls[i];i++){js.dom.setAttribute(ctrl,'disabled','disabled');}
this.view.clear();};_proto.onReceive=function(action,data){this.view.updateUI(data);};_proto.onComplete=function(req){var ctrls=js.dom.getElementsByTagName(js.dom.getBody(),_input_tags);for(var i=0,ctrl;ctrl=ctrls[i];i++){js.dom.removeAttribute(ctrl,'disabled');}};});js.extend('local',function(js){var CPerlModule=js.http.PerlModule;this.PerlModule=function(){CPerlModule.call(this,'[#`./module.pm`]');this.mask=new js.lsn.Mask();this.mask.getElement().appendChild(js.dom.createElement('h1=Working...',{'style':{'margin':'5em'}}));};var _proto=this.PerlModule.prototype=js.lang.createMethods(CPerlModule);_proto.onSend=function(req){this.mask.show();};_proto.onRecv=function(req){this.mask.hide();};});js.extend('local',function(js){var CForm=js.lsn.forms.Form;this.Settings=function(){CForm.call(this,[#:js:var ./settings.hf],[#:js:var ./module.pm/get_config]);};var _proto=this.Settings.prototype=js.lang.createMethods(CForm);});js.extend('local',function(js){this.View=function(){this.rows=[];};var _proto=this.View.prototype=js.lang.createMethods();_proto.getRootElement=function(){return this.uiRoot||this.createUI();};_proto.createUI=function(){this.uiStatus=js.dom.createElement('P.status');this.uiOutput=js.dom.createElement('DIV.output');this.uiBody=js.dom.createElement('TBODY');this.uiRoot=js.dom.createElement('DIV',[this.uiStatus,'TABLE.results',[this.uiBody],this.uiOutput]);return this.uiRoot;};_proto.updateStatus=function(value){var status=js.dom.getValue(this.uiStatus);if(status)status+=" &raquo ";status+=value;js.dom.setValue(this.uiStatus,status);};_proto.setAutohide=function(state){var toggle=state?js.dom.addClassName:js.dom.removeClassName;toggle(this.uiRoot,'autohide');};_proto.clear=function(){var table=this.getRootElement();this.rows=[];js.dom.removeChildren(this.uiBody);js.dom.removeChildren(this.uiOutput);js.dom.removeChildren(this.uiStatus);this.updateStatus('Initial');};_proto.updateUI=function(data){var part=data.toObject();switch(part.type){case'update':this.updateResults(part.args);break;case'error':alert(part.args[0]);break;case'status':this.updateStatus(part.args[0]);break;case'output':this.updateOutput(part.args[0]);break;default:throw'Unknown response data';}};_proto.updateOutput=function(line){var uiLine=js.dom.createElement('PRE');js.dom.appendChild(this.uiOutput,uiLine);js.dom.setValue(uiLine,line);};_proto.updateResults=function(args){var addr=args[0];var status=args[1]||'Unknown';var table=this.getRootElement();var tr;if(!this.rows[addr]){tr=js.dom.createElement('tr',['td.col2='+addr,'td.col1='+status]);this.uiBody.appendChild(tr);this.rows[addr]=tr;}else{tr=this.rows[addr];tr.childNodes[1].innerHTML+=' &raquo; '+status;}
js.dom.addClassName(tr,status);};});