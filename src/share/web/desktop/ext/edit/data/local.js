// Livesite (c) Livesite Networks, LLC 2010.

[#:http:header 'Cache-Control' 'no-store']
js.extend('desktop.ext.edit.data',function(js){var _css=null;function _initStyles(){if(_css)return;_css=js.dom.include.style({'href':'[#`./layout.css`]'});};this.Main=function(){this.node=undefined;this.uiRoot=this.createUI();}
var _proto=this.Main.prototype=js.lang.createMethods();_proto.reset=function(){this.node=undefined;js.dom.removeChildren(this.uiRoot);};_proto.load=function(node){this.node=node;this.populate(node,this.getUI());};_proto.getUI=function(){return this.uiRoot;};_proto.createUI=function(){return js.dom.createElement('div.lde');};_proto.populate=function(node,ce){_initStyles();if(node.isDataContainer()){var w1=js.dom.getWidth(this.getUI());var lbls=[];var ctrls=[];node.iterate(function(k,v){var wrap=this.createWrap(k,v);ce.appendChild(wrap);var lbl=undefined;if(node.getType()!='data-array'){lbl=this.createLabel(k,v);wrap.appendChild(lbl);}
if(v.getType()=='data-hash'||v.getType()=='data-array'){if(lbl)wrap.appendChild(js.dom.createElement('br',{'class':'clear'}));this.populate(v,wrap);}else{if(lbl)lbls.push(lbl);var ctrl=this.createControl(k,v);wrap.appendChild(ctrl);ctrls.push(ctrl);}},this);var width=0;for(var i=0;i<lbls.length;i++){width=Math.max(width,js.dom.getWidth(lbls[i].firstChild));}
for(var i=0;i<lbls.length;i++){js.dom.setStyle(lbls[i],'width',width+'px');}
for(var i=0;i<ctrls.length;i++){var psib=ctrls[i].previousSibling;var rt=js.dom.getRight(psib);var width=w1-30-rt-16;var elems=js.dom.getElementsByClassName(ctrls[i],'wide');for(var j=0,elem;elem=elems[j];j++){js.dom.setStyle(elem,'width',width+'px');}
if(js.dom.getStyle(psib,'float')=='left'){var ml=js.dom.getWidth(psib);ml+=js.util.asInt(js.dom.getStyle(psib,'margin-right'));js.dom.setStyle(ctrls[i],'margin-left',ml+'px');}}}else{ce.appendChild(this.createControl(node.getAddress(),node));}};_proto.createWrap=function(key,node){var parts=node.getType().split('-');var dtype=parts.length>2?parts.pop():undefined;var type=parts[0]+'-'+parts[1];return js.dom.createElement('div',{'class':'wrap'},['img',{'class':'beg',src:'/res/icons/16x16/nodes/mpe-'+type+'.png'},'img',{'class':'end',src:'/res/icons/16x16/nodes/mpe-end.png'}]);};_proto.createLabel=function(key,node){return js.dom.createElement('div',{'class':'lbl'},['span',{innerHTML:key}]);};_proto.createControl=function(key,node){var parts=node.getType().split('-');var dtype=parts.length>2?parts.pop():undefined;var type=parts[0]+'-'+parts[1];var ctrl=js.dom.createElement('div',{'class':'ctrl'});var klass=dtype=='txt'?js.desktop.ext.edit.data.InputTextarea:dtype=='html'?js.desktop.ext.edit.data.InputTextarea:js.desktop.ext.edit.data.InputText;var input=new klass(node);js.dom.appendChildren(ctrl,input.getUI());return ctrl;};});js.extend('desktop.ext.edit.data',function(js){var CInput=js.lsn.forms.InputText;this.InputText=function(node){CInput.apply(this,[js.dom.createElement('input.wide')]);this.node=node;this.deserialize(node.getValue());this.si=new js.desktop.ext.edit.data.StatusIcon();this.ui=[this.elem].concat(this.si.getUI());};var _proto=this.InputText.prototype=js.lang.createMethods(CInput);_proto.getUI=function(){return this.ui;};_proto.sync=function(){this.read();this.write();this.save();return this;};_proto.save=function(){this.node.setValue(this.serialize());js.dom.setAttribute(this.elem,'disabled','disabled');this.si.showActive();js.hubb.getInstance().store(this.node.getAddress(),this.node.getValue(),[this.onSaveComplete,this]);};_proto.onSaveComplete=function(){js.dom.removeAttribute(this.elem,'disabled');this.si.showComplete();};});js.extend('desktop.ext.edit.data',function(js){var CInput=js.lsn.forms.InputTextarea;this.InputTextarea=function(node){CInput.apply(this,[js.dom.createElement('textarea.wide')]);this.node=node;this.deserialize(node.getValue());this.si=new js.desktop.ext.edit.data.StatusIcon();this.rszta=new js.desktop.ext.edit.data.ResizeTextarea(this.elem);this.ui=[this.elem].concat(this.si.getUI()).concat(this.rszta.getUI());};var _proto=this.InputTextarea.prototype=js.lang.createMethods(CInput);_proto.getUI=function(){return this.ui;};_proto.sync=function(){this.read();this.write();this.save();return this;};_proto.save=function(){this.node.setValue(this.serialize());js.dom.setAttribute(this.elem,'disabled','disabled');this.si.showActive();js.hubb.getInstance().store(this.node.getAddress(),this.node.getValue(),[this.onSaveComplete,this]);};_proto.onSaveComplete=function(){js.dom.removeAttribute(this.elem,'disabled');this.si.showComplete();};});js.extend('desktop.ext.edit.data',function(js){var _proto={};this.ResizeTextarea=function(textarea){this.textarea=js.dom.getElement(textarea);this.mask=new js.lsn.Mask({opacity:0,cursor:'s-resize'});this.dims={h:undefined};this.elem=js.dom.createElement('div.rszta.wide');this.handle=new js.lsn.DragHandle(this.elem,{'onMouseMove':[this.onMouseMove,this],'onMouseDown':[this.onMouseDown,this],'onMouseUp':[this.onMouseUp,this]});this.ui=[this.elem]};this.ResizeTextarea.prototype=_proto;_proto.getUI=function(){return this.ui;};_proto.onMouseMove=function(event,dh){js.dom.stopEvent(event);var h=Math.max(this.dims.h+dh.delta_y,60);js.dom.setStyle(this.textarea,'height',h+'px');};_proto.onMouseDown=function(event,dh){js.dom.stopEvent(event);this.dims.h=js.dom.getHeight(this.textarea);this.mask.show();};_proto.onMouseUp=function(event,dh){js.dom.stopEvent(event);this.mask.hide();};});js.extend('desktop.ext.edit.data',function(js){var _imgReady='[#`./images/blank.gif`]';var _imgActive='[#`./images/saving.gif`]';var _imgComplete='[#`./images/checkmark.gif`]';this.StatusIcon=function(node){this.elem=js.dom.createElement('img',{'src':_imgReady,'width':16,'height':16,'border':0});this.ui=[this.elem];this.fade=new js.fx.effects.Opacify(this.elem,1,.25,1000);};var _proto=this.StatusIcon.prototype=js.lang.createMethods();_proto.getUI=function(){return this.ui;};_proto.showActive=function(){js.dom.setOpacity(this.elem,1);js.dom.setAttribute(this.elem,'src',_imgActive);};_proto.showComplete=function(){js.dom.setOpacity(this.elem,1);js.dom.setAttribute(this.elem,'src',_imgComplete);js.dom.setTimeout(this.fade.start,1000,this.fade);};_proto.showReady=function(){js.dom.setOpacity(this.elem,1);js.dom.setAttribute(this.elem,'src',_imgReady);};});