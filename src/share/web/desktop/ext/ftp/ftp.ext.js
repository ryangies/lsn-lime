// 

js.extend('ext.ftp',function(js){this.Main=function(){this.settings=new js.ext.ftp.Settings();this.view=new js.ext.ftp.View();};var _proto=this.Main.prototype=js.lang.createMethods();_proto.attachSimpleButtons=function(elem){js.dom.appendChildren(elem,js.dom.createElements('div',['button=Publish',{'onClick':[this.submitAction,this,['publish']]},'INPUT',{'id':'cbox-toggle','type':'checkbox','onChange':[this.toggleAutohide,this]},'LABEL=Hide not-modified and excluded items',{'for':'cbox-toggle'}]));};_proto.attachOutput=function(elem){elem.appendChild(this.view.getRootElement());};_proto.attachAdvancedButtons=function(elem){js.dom.appendChildren(elem,js.dom.createElements('div',['button=Query',{'onClick':[this.submitAction,this,['query']]},'button=Export',{'onClick':[this.submitAction,this,['export']]},'button=Prepare',{'onClick':[this.submitAction,this,['prepare']]},'button=Compare',{'onClick':[this.submitAction,this,['compare']]},'button=Upload',{'onClick':[this.submitAction,this,['upload']]},'button=Clean',{'onClick':[this.submitAction,this,['clean']]},'button=Download remote (overwrite working files!)',{'onClick':[this.submitAction,this,['download']]},]));};_proto.attachSettings=function(elem){elem.appendChild(this.settings.getRootElement());js.dom.appendChildren(elem,js.dom.createElements('div',['button=Save Settings',{'onClick':[this.submitAction,this,['set_config']]},]));};_proto.toggleAutohide=function(event){var checkbox=js.dom.getEventTarget(event);this.view.setAutohide(checkbox.checked);};_proto.submitAction=function(event,name){var req=new js.http.Stream('[#`./module.pm`]/'+name);req.addActionListener('onReceive',this.onReceive,this);req.addEventListener('onCreate',this.onCreate,this);req.addEventListener('onComplete',this.onComplete,this);req.submit(this.settings.getChangedValues());};_proto.onCreate=function(req){var ctrls=js.dom.getElementsByTagName(js.dom.getBody(),['INPUT','SELECT','BUTTON']);for(var i=0,ctrl;ctrl=ctrls[i];i++){js.dom.setAttribute(ctrl,'disabled','disabled');}
this.view.clear();};_proto.onReceive=function(action,data){this.view.updateUI(data);};_proto.onComplete=function(req){var ctrls=js.dom.getElementsByTagName(js.dom.getBody(),['INPUT','SELECT','BUTTON']);for(var i=0,ctrl;ctrl=ctrls[i];i++){js.dom.removeAttribute(ctrl,'disabled');}};});js.extend('ext.ftp',function(js){var CPerlModule=js.http.PerlModule;this.PerlModule=function(){CPerlModule.call(this,'[#`./module.pm`]');this.mask=new js.lsn.Mask();this.mask.getElement().appendChild(js.dom.createElement('h1=Working...',{'style':{'margin':'5em'}}));};var _proto=this.PerlModule.prototype=js.lang.createMethods(CPerlModule);_proto.onSend=function(req){this.mask.show();};_proto.onRecv=function(req){this.mask.hide();};});js.extend('ext.ftp',function(js){var CForm=js.lsn.forms.Form;this.Settings=function(){CForm.call(this,[#:js:var ./settings.hf],[#:js:var ./module.pm/get_config]);};var _proto=this.Settings.prototype=js.lang.createMethods(CForm);});js.extend('ext.ftp',function(js){this.View=function(){this.rows=[];};var _proto=this.View.prototype=js.lang.createMethods();_proto.getRootElement=function(){return this.uiRoot||this.createUI();};_proto.createUI=function(){this.uiRoot=js.dom.createElement('table',{'class':'results'},['tbody']);this.updateResults(['STATUS','Initial']);return this.uiRoot;};_proto.setAutohide=function(state){var toggle=state?js.dom.addClassName:js.dom.removeClassName;toggle(this.uiRoot,'autohide');};_proto.clear=function(){var table=this.getRootElement();var tbody=table.firstChild;this.rows=[];js.dom.removeChildren(tbody);};_proto.updateUI=function(data){var part=data.toObject();if(part.type=='update'){this.updateResults(part.args);}else if(part.type=='error'){alert(part.args[0]);}else{throw'Unknown response data';}}
_proto.updateResults=function(args){var addr=args[0];var status=args[1]||'Unknown';var table=this.getRootElement();var tbody=table.firstChild;var tr;if(!this.rows[addr]){tr=js.dom.createElement('tr',['td.col2='+addr,'td.col1='+status]);tbody.appendChild(tr);this.rows[addr]=tr;}else{tr=this.rows[addr];tr.childNodes[1].innerHTML+=' &raquo; '+status;}
js.dom.addClassName(tr,status);};});