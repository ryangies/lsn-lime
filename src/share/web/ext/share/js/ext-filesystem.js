// Livesite (c) Livesite Networks, LLC.

js.extend('ext.filesystem.view',function(js){var _package=this;var BaseListView=js.ext.share.filesystem.view.ListView;_package.ListView=function(name,tree){this.super=BaseListView.prototype;BaseListView.apply(this,arguments);};var ListView=_package.ListView.prototype=js.lang.createMethods(BaseListView);ListView.createHeaders=function(){var headers=this.super.createHeaders.call(this);return headers.concat(js.dom.createElements('TH.detail.size=Size','TH.detail.date=Date','TH.detail.time=Time','TH.detail.type=Type'));};var BaseListViewLayer=BaseListView.prototype.Layer;ListView.Layer=function(node,name,view){this.super=BaseListViewLayer.prototype;BaseListViewLayer.apply(this,arguments);this.action='fs-open';};var Layer=ListView.Layer.prototype=js.lang.createMethods(BaseListViewLayer);Layer.createColumns=function(){var cols1=this.super.createColumns.call(this);var cols2=[this.tdSize=js.dom.createElement('TD.detail.size'),this.tdDate=js.dom.createElement('TD.detail.date'),this.tdTime=js.dom.createElement('TD.detail.time'),this.tdType=js.dom.createElement('TD.detail.type')];return cols1.concat(cols2);};Layer.updateUI=function(){this.super.updateUI.call(this);var data=this.node.data;this.tdSize.innerHTML=data.getFilesize();this.tdDate.innerHTML=js.date.format(data.getDate(),'mediumDate');this.tdTime.innerHTML=js.date.format(data.getDate(),'shortTime');this.tdType.innerHTML=data.getType();};Layer.onStatus=function(action,node,stats){this.super.onStatus.apply(this,arguments);this.updateUI();var percent=stats.percent||0;this.tdSize.innerHTML=percent+'%';};});js.extend('ext.filesystem.view',function(js){var CTreeView=js.ext.share.filesystem.view.TreeView;var CTreeViewLayer=js.ext.share.filesystem.view.TreeViewLayer;this.CrumbView=function(name,tree){this.div=js.dom.createElement('DIV.'+name);CTreeView.apply(this,arguments);};var CrumbView=this.CrumbView.prototype=js.lang.createMethods(CTreeView);CrumbView.getElements=function(){return[this.div];};CrumbView.Layer=function(node,name,view){CTreeViewLayer.apply(this,arguments);};var Layer=CrumbView.Layer.prototype=js.lang.createMethods(CTreeViewLayer);Layer.createUI=function(){this.parentElement=this.parentNode?this.parentNode.dd:this.view.div;this.dt=js.dom.createElement('DT');this.dd=js.dom.createElement('DD');this.dl=js.dom.createElement('DL',[this.dt,this.dd]);this.updateUI();};Layer.updateUI=function(){var data=this.node.data;var addr=data.getAddress();var name=this.node.getName();js.dom.replaceChildren(this.dt,js.dom.createElements('A',{'href':addr,'title':addr,'onClick':[this.onClick,this],'onMouseOver':[this.onMouseOver,this],'onMouseOut':[this.onMouseOut,this]},['IMG.icon',{'src':data.getIcon()},'SPAN.name='+name]));};Layer.removeUI=function(){js.dom.removeElement(this.dl);};Layer.onSelectCwd=function(){this.walk(function(child){child.setState('inactive');});this.show();};Layer.show=function(){this.setState('active');js.dom.replaceChildren(this.parentElement,[this.dl]);if(this.parentNode)this.parentNode.show();};Layer.setState=function(state){switch(state){case'inactive':js.dom.addClassName(this.dl,'inactive');js.dom.setOpacity(this.dt,.25);break;default:js.dom.removeClassName(this.dl,'inactive');js.dom.setOpacity(this.dt,1);}};Layer.onClick=function(event){js.dom.stopEvent(event);this.node.setAsCwd();this.node.expand();};Layer.onMouseOver=function(event){};Layer.onMouseOut=function(event){};});js.extend('ext.filesystem',function(js){var CScreen=js.ext.share.Screen;this.Screen=function(){CScreen.apply(this,arguments);this.tree=null;this.rootAddress=null;this.menuConfig=[#:json /ext/filesystem/menu.hf];this.popupConfig=[#:json /ext/filesystem/popup.hf];};var _proto=this.Screen.prototype=js.lang.createMethods(CScreen);_proto.load=function(params){if(!this.rootAddress){var openTo=params&&params.addr?params.addr:env.getPreference('ext-filesystem','last-cwd');params=js.util.overlay({'addr':'/'},params);this.rootAddress=params.addr;env.showLoading();env.hub.fetch(this.rootAddress,[function(dnode){this.tree=new js.ext.share.filesystem.Tree(dnode);this.tree.addActionListener('onChangeDirectory',this.onChangeDirectory,this);this.crumbView=new js.ext.filesystem.view.CrumbView('crumb-view',this.tree);this.listView=new js.ext.filesystem.view.ListView('list-view',this.tree);this.listMenu=new js.ext.share.ui.menu.PanelMenu(env,this.tree);this.listMenu.load(this.menuConfig);env.initiators.addLayer('fs-list-menu',this.listMenu.lastChild);var contextMenu=new js.ext.share.ui.menu.PanelMenu(env,this.tree);contextMenu.load(this.popupConfig);env.initiators.addLayer('fs-context-menu',contextMenu.firstChild);env.dialogs.register('ext-filesystem-context-menu',js.ext.share.ui.menu.PopupMenu,[function(){this.setContent(contextMenu.getElements());},null,[contextMenu]]);js.dom.replaceChildren('fs-crumb-view',this.crumbView.getElements());js.dom.replaceChildren('fs-list-view',this.listView.getElements());js.dom.replaceChildren('fs-menu-view',this.listMenu.getElements());this.tree.rootNode.populate();this.tree.rootNode.setAsCwd();if(openTo){this.tree.selectCwdByAddress(openTo,function(){env.hideLoading();});}else{this.tree.rootNode.expand();env.hideLoading();}},this]);}else if(params&&params.addr){this.tree.expandNodeByAddress(params.addr);}};_proto.onChangeDirectory=function(action,cwd){env.setPreference('ext-filesystem','last-cwd',cwd.data.getAddress());};});js.extend('ext.filesystem',function(js){env.registerHandler('fs-open',function(action,node,event){if(node.data.isDirectory()){node.setAsCwd();node.expand();return true;}});env.registerHandler('fs-open',function(action,node,event){env.dialogs.get('ext-filesystem-context-menu').show(action.event);return false;var matches=[];env.initiators.walk(function(child){var initiator=child.data;if(initiator.type=='file-action'&&initiator.match(node.data)){matches.push(initiator);}});switch(matches.length){case 0:return false;case 1:env.invokeHandler(matches[0].action,node);return true;default:js.console.log('Multiple options');env.dialogs.get('ext-filesystem-context-menu').show(action.event);return false;}});env.dialogs.register('ext-filesystem-new-folder',js.hubb.ui.NewDirectoryDialog);env.registerHandler('ext-filesystem-show-create-folder',function(action,node){env.dialogs.get('ext-filesystem-new-folder').show(node.data);});env.dialogs.register('ext-filesystem-new-file',js.hubb.ui.NewFileDialog);env.registerHandler('ext-filesystem-show-create-file',function(action,node){env.dialogs.get('ext-filesystem-new-file').show(node.data);});env.dialogs.register('ext-filesystem-upload',js.hubb.ui.UploadDialog);env.registerHandler('ext-filesystem-show-upload-file',function(action,node){env.dialogs.get('ext-filesystem-upload').show(node.data);});env.dialogs.register('ext-filesystem-download',js.hubb.ui.DownloadDialog);env.registerHandler('ext-filesystem-show-fetch-file',function(action,node){env.dialogs.get('ext-filesystem-download').show(node.data);});env.dialogs.register('ext-filesystem-copy',js.hubb.ui.CopyDialog);env.registerHandler('ext-filesystem-show-copy',function(action,node){env.dialogs.get('ext-filesystem-copy').show(node.data);});env.dialogs.register('ext-filesystem-move',js.hubb.ui.MoveDialog);env.registerHandler('ext-filesystem-show-move',function(action,node){env.dialogs.get('ext-filesystem-move').show(node.data);});env.registerHandler('ext-filesystem-show-delete',function(action,node){var addr=node.data.getAddress();if(confirm('Are you sure you want to delete: '+addr)){env.hub.remove(addr);}});});