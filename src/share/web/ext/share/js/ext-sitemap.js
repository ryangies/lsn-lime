// Livesite (c) Livesite Networks, LLC.

js.extend('ext.sitemap.menu',function(js){var _package=this;var CActionNode=js.ext.share.ui.menu.ActionNode;_package.WebpageActionNode=function(){CActionNode.apply(this,arguments);};var _proto=_package.WebpageActionNode.prototype=js.lang.createMethods(CActionNode)
_proto.canDisplay=function(target){try{return target.data.data['.type']=='webpage';}catch(ex){return false;}};});js.extend('ext.sitemap',function(js){var CFilesystemNode=js.ext.share.filesystem.Node;var CNode=this.Node=function(){CFilesystemNode.apply(this,arguments);};var _proto=this.Node.prototype=js.lang.createMethods(CFilesystemNode);_proto.createNode=function(data){return new CNode(data,this.tree);};_proto.sortCompare=function(a,b){if(!(js.util.defined(a)&&js.util.defined(b)))return;var av=a.data.getIndex();var bv=b.data.getIndex();var rv=av-bv;return rv;};_proto.canDisplay=function(){return this.data&&this.data.isDataContainer();};_proto.canExpand=function(){return this.getType()=='category';};_proto.getName=function(){return this.data.getValue('.name');};_proto.getIconPath=function(){var type=this.data.getValue('.type')||'category';return'/res/icons/16x16/sitemap/'+type+'.png';};_proto.getType=function(){return this.data.getValue('.type')||'category';};_proto.getTargetAddress=function(){var result=[];var node=this;while(node&&node!==node.rootNode){result.push(node.data.getKey());node=node.parentNode;}
result.push('/');return js.data.addr_join(result.reverse());};_proto.getCrumbPath=function(){var name=[];var node=this;while(node&&node!==this.rootNode){name.unshift(node.getName());node=node.parentNode;}
return name.join(' > ');};});js.extend('ext.sitemap.view',function(js){var _package=this;var BaseListView=js.ext.share.filesystem.view.ListView;_package.ListView=function(name,tree){this.super=BaseListView.prototype;BaseListView.apply(this,arguments);};var ListView=_package.ListView.prototype=js.lang.createMethods(BaseListView);ListView.createHeaders=function(){return js.dom.createElements('TH.icon','TH.name=Name','TH=Location');};var BaseListViewLayer=BaseListView.prototype.Layer;ListView.Layer=function(node,name,view){this.super=BaseListViewLayer.prototype;BaseListViewLayer.apply(this,arguments);this.action='ext-sitemap-expand';};var Layer=ListView.Layer.prototype=js.lang.createMethods(BaseListViewLayer);Layer.createColumns=function(){var cols1=this.super.createColumns.call(this);var cols2=js.dom.createElements(this.tdAddr=js.dom.createElement('TD.addr.w50'));return cols1.concat(cols2);};Layer.extendUI=function(){this.uiAddr=js.dom.createElement('SPAN.addr');js.dom.replaceChildren(this.tdAddr,[this.uiAddr]);this.svName=this.node.data.getValue('.name');this.svAddr=this.node.data.getValue('.addr');this.svName.tie(this.nameStatic,['innerHTML']);this.svName.tie(this.nameLinked,['innerHTML']);if(this.svAddr){this.svAddr.tie(this.uiAddr,['innerHTML']);}};Layer.updateUI=function(){var addr=this.node.getTargetAddress();js.dom.setAttribute(this.nameLinked,'href',addr);js.dom.setAttribute(this.nameLinked,'title',addr);js.dom.setAttribute(this.uiIcon,'src',this.node.getIconPath());if(!this.svAddr){js.dom.setValue(this.uiAddr,addr);}};});js.extend('ext.sitemap.view',function(js){var CTreeView=js.ext.share.filesystem.view.TreeView;var CTreeViewLayer=js.ext.share.filesystem.view.TreeViewLayer;this.CrumbView=function(name,tree){this.div=js.dom.createElement('DIV.'+name);CTreeView.apply(this,arguments);};var CrumbView=this.CrumbView.prototype=js.lang.createMethods(CTreeView);CrumbView.getElements=function(){return[this.div];};CrumbView.Layer=function(node,name,view){CTreeViewLayer.apply(this,arguments);};var Layer=CrumbView.Layer.prototype=js.lang.createMethods(CTreeViewLayer);Layer.createUI=function(){this.parentElement=this.parentNode?this.parentNode.dd:this.view.div;this.uiIcon=js.dom.createElement('IMG.icon',{'width':16,'height':16});this.uiName=js.dom.createElement('SPAN.name');this.uiAnchor=js.dom.createElement('A',{'onClick':[this.onClick,this],'onMouseOver':[this.onMouseOver,this],'onMouseOut':[this.onMouseOut,this]},[this.uiIcon,this.uiName]);this.dt=js.dom.createElement('DT',[this.uiAnchor]);this.dd=js.dom.createElement('DD');this.dl=js.dom.createElement('DL',[this.dt,this.dd]);this.svName=this.node.data.getValue('.name');this.svName.tie(this.uiName,['innerHTML']);this.updateUI();};Layer.updateUI=function(){var addr=this.node.getTargetAddress();js.dom.setAttribute(this.uiAnchor,'href',addr);js.dom.setAttribute(this.uiAnchor,'title',addr);js.dom.setAttribute(this.uiIcon,'src',this.node.getIconPath());};Layer.removeUI=function(){js.dom.removeElement(this.dl);};Layer.onSelectCwd=function(){this.walk(function(child){child.setState('inactive');});this.show();};Layer.show=function(){this.setState('active');js.dom.replaceChildren(this.parentElement,[this.dl]);if(this.parentNode)this.parentNode.show();};Layer.setState=function(state){switch(state){case'inactive':js.dom.addClassName(this.dl,'inactive');js.dom.setOpacity(this.dt,.25);break;default:js.dom.removeClassName(this.dl,'inactive');js.dom.setOpacity(this.dt,1);}};Layer.onClick=function(event){js.dom.stopEvent(event);this.node.setAsCwd();};Layer.onMouseOver=function(event){};Layer.onMouseOut=function(event){};});js.extend('ext.sitemap.view',function(js){var CSelectView=js.ext.share.filesystem.view.SelectView;var CSelectViewLayer=js.ext.share.filesystem.view.SelectViewLayer;this.SelectView=function(name,tree){CSelectView.apply(this,arguments);};var _proto=this.SelectView.prototype=js.lang.createMethods(CSelectView);_proto.Layer=function(node,name,view){CSelectViewLayer.apply(this,arguments);};var Layer=_proto.Layer.prototype=js.lang.createMethods(CSelectViewLayer);});js.extend('ext.sitemap.input',function(js){var _package=this;var CSelectBase=js.ext.share.filesystem.input.Select;var CSelect=_package.Select=function(params){if(!params)params={};params.rootAddress=params.category?'/web/data/sitemap.hf'+params.category:'/web/data/sitemap.hf';CSelectBase.apply(this,[params]);};var _proto=CSelect.prototype=js.lang.createMethods(CSelectBase);js.ext.share.input.factory.set('select-sitemap-entry',CSelect);_proto.constructTree=function(dnode){return new js.ext.share.filesystem.Tree(dnode,js.ext.sitemap.Node);};_proto.constructView=function(layerName,tree){return new js.ext.sitemap.view.SelectView(layerName,tree);};_proto.localizeAddress=function(addr){var parts=addr.match(/^uuid:(.*)/);if(parts){var uuid=parts[1];var node=this.tree.rootNode.walk(function(n){var dnode=n.getDataNode();if(dnode.isDataContainer()&&dnode.getString('.uuid')===uuid){return n;}});return node?node.getDataNode().getAddress():addr;}else{return CSelectBase.prototype.localizeAddress.apply(this,arguments);}};});js.extend('ext.sitemap',function(js){var CScreen=js.ext.share.Screen;this.Screen=function(props,smAddr){CScreen.apply(this,[props]);this.hasLoaded=false;this.tree=null;this.menu=null;this.crumbView=null;this.listView=null;this.smAddr=smAddr;};var _proto=this.Screen.prototype=js.lang.createMethods(CScreen);_proto.load=function(params){if(this.hasLoaded)return;env.showLoading();env.hub.fetch(this.smAddr,[function(dnode){if(dnode){this.tree=new js.ext.share.filesystem.Tree(dnode,js.ext.sitemap.Node);this.crumbView=new js.ext.sitemap.view.CrumbView('crumb-view',this.tree);this.listView=new js.ext.sitemap.view.ListView('list-view',this.tree);this.menu=new js.ext.share.ui.menu.PanelMenu(env,this.tree);this.menu.factory['webpage-action']=js.ext.sitemap.menu.WebpageActionNode;this.menu.load([#:json /ext/sitemap/menu.hf]);js.dom.replaceChildren('ext-sitemap-area2',this.menu.getElements());js.dom.replaceChildren('ext-sitemap-area3',this.crumbView.getElements());js.dom.replaceChildren('ext-sitemap-area4',this.listView.getElements());this.tree.rootNode.populate();this.tree.rootNode.setAsCwd();this.tree.rootNode.expand();this.hasLoaded=true;}
env.hideLoading();},this]);};});js.extend('ext.sitemap',function(js){env.registerHandler('ext-sitemap-expand',function(action,node){var type=node.data.getValue('.type');if(type&&type=='category'){node.setAsCwd();node.expand();return true;}else{env.invokeHandler('ext-sitemap-edit-live',node);}});env.registerHandler('ext-sitemap-edit-properties',function(action,node){var dnode=node.data;var type=dnode.getString('.type');env.dialogs.get('ext-sitemap-edit-'+type).show(dnode);});env.registerHandler('ext-sitemap-move-up',function(action,targetNode){var previousNode;var node=targetNode.previousSibling;while(node&&!previousNode){if(node.canDisplay())previousNode=node;node=node.previousSibling;}
if(!previousNode)return;var parentNode=targetNode.parentNode;var indexes=[];var child=parentNode.firstChild;while(child){if(child===previousNode){indexes.push(targetNode.data.getKey());indexes.push(previousNode.data.getKey());child=targetNode.nextSibling;}else{indexes.push(child.data.getKey());child=child.nextSibling;}}
var db=parentNode.data.getDataBridge();var addr=parentNode.data.getAddress();env.showLoading();db.reorder(addr,indexes,function(){env.hideLoading();});});env.registerHandler('ext-sitemap-move-down',function(action,targetNode){var nextNode;var node=targetNode.nextSibling;while(node&&!nextNode){if(node.canDisplay())nextNode=node;node=node.nextSibling;}
if(!nextNode)return;var parentNode=targetNode.parentNode;var indexes=[];var child=parentNode.firstChild;while(child){if(child===targetNode){indexes.push(nextNode.data.getKey());indexes.push(targetNode.data.getKey());child=nextNode.nextSibling;}else{indexes.push(child.data.getKey());child=child.nextSibling;}}
var db=parentNode.data.getDataBridge();var addr=parentNode.data.getAddress();env.showLoading();db.reorder(addr,indexes,function(){env.hideLoading();});});env.registerHandler('ext-sitemap-edit-live',function(action,node){var addr=[];var n=node;while(n&&n!==n.rootNode){addr.unshift(n.data.getKey());n=n.parentNode;}
addr.unshift('');var targetAddress=js.data.addr_join(addr);var screen=env.screens.get('/ext/editors/live/');if(screen){env.screens.select(screen,{'addr':targetAddress});}});});