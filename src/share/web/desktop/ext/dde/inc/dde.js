// Livesite (c) Livesite Networks, LLC 2008-2011.

ECMAScript.Extend('lsn.ext.dde',function(ecma){this.parseAttributes=function(str){var attrs=new ecma.data.HashList();if(!str)str=new String();var parts=str.split(';');for(var j=0,part;part=parts[j];j++){if(!part)continue;var kv=part.split('=');var key=kv[0];var val=kv[1].replace(/^'|'$/g,'');attrs.set(key,val);}
return attrs;};});ECMAScript.Extend('lsn.ext.dde',function(ecma){var URL_ELEMS={'A':['href'],'IMG':['src'],'OBJECT':['src']};this.ReplaceText=function(substr,newSubstr){this.substr=substr;this.newSubstr=newSubstr;};var _proto=this.ReplaceText.prototype=ecma.lang.createMethods();_proto.perform=function(elem,scope){if(!this.substr)return;var bURLs=scope?scope=='urls'||scope=='both':false;var bText=scope?scope=='both'||scope=='text':true;var node=elem.firstChild;while(node){var next=node.nextSibling;switch(node.nodeType){case ecma.dom.constants.ELEMENT_NODE:if(bURLs&&URL_ELEMS[node.tagName]){for(var i=0,attr;attr=URL_ELEMS[node.tagName][i];i++){var attrValue=ecma.dom.getAttribute(node,attr);if(attrValue&&typeof(attrValue.replace=='function')){ecma.dom.setAttribute(node,attr,attrValue.replace(this.substr,this.newSubstr));}}}
this.perform(node,scope);break;case ecma.dom.constants.TEXT_NODE:if(bText){node.nodeValue=node.nodeValue.replace(this.substr,this.newSubstr);}
default:break;}
node=next;}
return elem;};});ECMAScript.Extend('lsn.ext.dde',function(ecma){var _watchInterval=50;var _maxWatchCount=10;var proto={};this.Clipboard=function(cc,editor){this.cc=cc;this.editor=editor;this.target=null;this.pasteEvent=null;};this.Clipboard.prototype=proto;proto.attach=function(elem){this.target=elem;this.pasteEvent=new ecma.dom.EventListener(this.target,'paste',this.onPaste,this);};proto.detach=function(){if(this.pasteEvent)this.pasteEvent.remove();};proto.onPaste=function(event){new PasteFilter(this);};function PasteFilter(clipboard){this.cc=clipboard.cc;this.editor=clipboard.editor;this.target=clipboard.target;this.watchCount=0;this.watchId=null;this.scrubber=new ecma.dom.Scrubber(ecma);this.cursor=null;this.begin();}
PasteFilter.prototype.begin=function(){this.editor.stopMonitor();this.cursor=ecma.dom.createElement('#comment=PASTE');this.cc.insertElement(this.cursor);this.bucket=ecma.dom.createElement('div',{'contentEditable':'true','style':{'position':'fixed','top':'0'}});ecma.dom.setOpacity(this.bucket,0);ecma.dom.getBody().appendChild(this.bucket);this.bucket.focus();this.beginWatch();};PasteFilter.prototype.afterPaste=function(){try{this.scrubber.scrub(this.bucket);var last=null;while(this.bucket.hasChildNodes()){var node=this.bucket.firstChild;try{if(node===last)throw'Element not inserted';ecma.dom.insertBefore(node,this.cursor);last=node;}catch(ex){if(this.bucket.firstChild===node){ecma.dom.removeElementOrphanChildren(this.bucket.firstChild);}}}}catch(ex){}finally{this.scrubber.collapse(this.target);this.endPaste();}};PasteFilter.prototype.endPaste=function(){try{this.editor.focus();this.cc.focusBefore(this.cursor);}catch(ex){}finally{ecma.dom.removeElements(this.bucket,this.cursor);this.editor.startMonitor();}};PasteFilter.prototype.hasChanged=function(){return this.bucket.hasChildNodes();};PasteFilter.prototype.watchForPaste=function(){if(this.watchCount<_maxWatchCount){this.watchCount++;if(!this.hasChanged()){this.watchId=ecma.dom.setTimeout(this.watchForPaste,_watchInterval,this);return;}}
ecma.dom.setTimeout(this.endWatch,_watchInterval,this);};PasteFilter.prototype.beginWatch=function(){this.watchCount=0;this.watchId=ecma.dom.setTimeout(this.watchForPaste,_watchInterval,this);};PasteFilter.prototype.endWatch=function(){ecma.dom.clearTimeout(this.watchId);try{if(!this.hasChanged()){this.endPaste();}else{this.afterPaste();}}finally{this.watchCount=0;this.watchId=null;}};});ECMAScript.Extend('lsn.ext.dde',function(ecma){var CComboBox=ecma.hubb.ui.ComboBox;var proto=ecma.lang.createMethods(CComboBox);this.FileCombo=function(){CComboBox.apply(this);};this.FileCombo.prototype=proto;proto.canExpand=function(tnode){return tnode.data.isDirectory();};});ECMAScript.Extend('lsn.ext.dde',function(ecma){var CComboBox=ecma.hubb.ui.ComboBox;var proto=ecma.lang.createMethods(CComboBox);this.ImageCombo=function(){CComboBox.apply(this);};this.ImageCombo.prototype=proto;proto.canExpand=function(tnode){return tnode.data.isDirectory();};});ECMAScript.Extend('lsn.ext.dde',function(ecma){this.MenuButton=ecma.lang.createConstructor();this.MenuButton.prototype={construct:function(dde,props){this.dde=dde;this.props=props;this.on=false;if(props.label){this.elem=ecma.dom.createElement('#text',{'nodeValue':props.label});}else if(props.elem){this.elem=ecma.dom.getElement(props.elem);}else if(props.cmd){var className=props['class'];if(!className)className='button';var onClick=props.target&&props.target=='editor'?function(event){ecma.dom.stopEvent(event);if(dde.editor)dde.editor.exec(props.cmd);if(dde.editor)dde.editor.focus();}:function(event){ecma.dom.stopEvent(event);dde.exec(props.cmd);};var stopEvent=function(event){ecma.dom.stopEvent(event);};this.elem=ecma.dom.createElement('img',{'class':className,'src':props.icon,'alt':props.alt,'title':props.alt,'onClick':onClick,'onFocus':stopEvent,'onMouseDown':stopEvent,'onMouseUp':stopEvent,'style':{'cursor':'pointer'}});}else if(props.icon){this.elem=ecma.dom.createElement('img',{'class':'static','src':props.icon,'alt':props.alt});}
if(props.obj){var klass=ecma.util.evar(props.obj);if(!klass)throw'Undefined button object: '+props.obj;this.obj=new klass(this,this.elem);this.elem=this.obj.getElement();}},getElement:function(){return this.elem;},onShow:function(args){if(this.obj)this.obj.onShow(args);if(this.props.state)this.setState(args);},setState:function(args){var elem=args[0];var stack=args[1];var cmd=args[2];if(cmd&&cmd==this.props.cmd){this.on=!this.on;}else{var state=this.props.state;this.on=ecma.util.grep(function(node){return node.tagName==state;},stack);}
if(this.on){ecma.dom.addClassName(this.elem,'on');}else{ecma.dom.removeClassName(this.elem,'on');}}};});ECMAScript.Extend('lsn.ext.dde',function(ecma){this.MenuBar=ecma.lang.createConstructor();this.MenuBar.prototype={construct:function(dde,props){this.dde=dde;this.props=props;this.buttons=[];for(var i=0,button;button=this.props['buttons'][i];i++){var btn=new ecma.lsn.ext.dde.MenuButton(this.dde,button);this.buttons.push(btn);}},getElements:function(){var elems=[];for(var i=0;i<this.buttons.length;i++){elems.push(this.buttons[i].getElement());}
return elems;},onShow:function(args){for(var i=0;i<this.buttons.length;i++){this.buttons[i].onShow(args);}}};});ECMAScript.Extend('lsn.ext.dde',function(ecma){var _defs=[#:json ./menubar.hf];this.MenuManager=ecma.lang.createConstructor();this.MenuManager.prototype={construct:function(dde,ce){this.dde=dde;this.active=null;this.mb=null;this.ce=ce;this.groups={};for(var id in _defs){var props=_defs[id];this.groups[id]=new ecma.lsn.ext.dde.MenuBar(dde,props);}},show:function(id){var args=ecma.util.args(arguments);args.shift();if(this.active!=id){this.mb=this.groups[id];if(!this.mb)throw'no such menubar';ecma.dom.replaceChildren(this.ce,this.mb.getElements());this.active=id;}
this.mb.onShow(args);},hide:function(){ecma.dom.removeElement(this.mb);this.mb=null;}};});ECMAScript.Extend('lsn.ext.dde',function(ecma){function _isElem(node){return node&&node.nodeType==ecma.dom.constants.ELEMENT_NODE;}
function _isText(node){return node&&node.nodeType==ecma.dom.constants.TEXT_NODE;}
var proto={};this.ContentController=function(){this.target=undefined;};this.ContentController.prototype=proto;proto.attach=function(elem){this.target=elem;this.exec('useCSS',true);};proto.detach=function(){this.target=undefined;};proto.isHome=function(){var sel=this.getSelection();if(sel.rangeCount==0)return false;var range=sel.getRangeAt(0);return range.startContainer===this.target&&range.startOffset===this.target&&range.endContainer==0&&range.endOffset==0?true:false;};proto.getFocusElement=function(){var sel=this.getSelection();var range=sel.getRangeAt(0);var endNode=ecma.dom.node.isElement(range.endContainer)?range.endOffset?range.endContainer.childNodes[range.endOffset-1]:range.endContainer:ecma.dom.node.isText(range.endContainer)?range.endContainer.parentNode:range.endContainer;if(!ecma.dom.isChildOf(endNode,this.target)){return null;}
while(endNode&&!_isElem(endNode)&&endNode!==this.target){endNode=endNode.parentNode;}
return endNode;};proto.getElementStack=function(elem){var result=[];if(elem){if(!ecma.dom.isChildOf(elem,this.target))return result;}else{elem=this.getFocusElement();}
while(elem){if(_isElem(elem))result.push(elem);if(elem===this.target)break;elem=elem.parentNode;}
return result;};proto.getContainerStack=function(){var result=[];var elem=this.target;while(elem){if(_isElem(elem))result.push(elem);elem=elem.parentNode;}
return result;};proto.getContainingParagraph=function(){var stack=this.getElementStack();var elem=null;for(var i=0,node;node=stack[i];i++){if(node.tagName.match(/^(p|h[1-6]|div|t[dh])$/i)){elem=node;break;}}
return elem;};proto.getElementsByTagName=function(tagName){var result=[];var stack=this.getElementStack();for(var i=0,elem;elem=stack[i];i++){if(elem.tagName.toLowerCase()==tagName.toLowerCase()){result.push(elem);}}
return result;};proto.insertElement=function(elem){var range=this.getRange();if(!range.collapsed)range.deleteContents()
if(!range.collapsed)throw'Could not collapse range for insertion';var container=range.startContainer;var offset=range.startOffset;switch(container.nodeType){case ecma.dom.constants.ELEMENT_NODE:var currentNode=container.childNodes[offset]||container;if(currentNode===this.target){if(currentNode.childNodes.length>0){currentNode.insertBefore(elem,currentNode.childNodes[0]);}else{currentNode.appendChild(elem);}}else{ecma.dom.insertBefore(elem,currentNode);}
break;case ecma.dom.constants.TEXT_NODE:var prefix=container.nodeValue.substr(0,offset);var suffix=container.nodeValue.substr(offset);var nextNode=ecma.dom.createElement('#text',{'nodeValue':suffix});container.nodeValue=prefix;ecma.dom.insertChildrenAfter(container,[elem,nextNode]);break;default:throw'No implementation for selected nodeType';}
this.focusEnd(elem);};proto.selectNodeContents=function(elem){if(!ecma.dom.isChildOf(elem,this.target)){throw'Element outside of target';}
var sel=this.getSelection();sel.removeAllRanges();var range=this.createRange();range.selectNodeContents(elem);sel.addRange(range);return sel;};proto.selectNode=function(elem){if(!ecma.dom.isChildOf(elem,this.target)){throw'Element outside of target';}
var range=this.createRange();range.selectNode(elem);var sel=this.getSelection();sel.removeAllRanges();sel.addRange(range);return sel;};proto.selectElement=proto.selectNode;proto.selectElementContents=proto.selectNodeContents;proto.focusStart=function(elem){try{var sel=this.selectElement(elem);var range=sel.getRangeAt(0);range.collapse(true);this.setRange(range);}catch(ex){}};proto.focusEnd=function(elem){try{var sel=this.selectElement(elem);var range=sel.getRangeAt(0);range.collapse(false);this.setRange(range);}catch(ex){}};proto.focusBefore=function(elem){try{var node=elem.previousSibling;if(!node){node=elem.parentElement;if(!node||(node==this.target)){this.target.focus();}else if(ecma.dom.isChildOf(node,this.target)){this.focusStart(node);}
return;}else{while(node.hasChildNodes()){node=node.lastChild;}}
if(ecma.dom.node.isElement(node)&&node.tagName=='BR'){this.focusBefore(node);}else{this.focusEnd(node);}}catch(ex){}};proto.focusAfter=function(elem){try{var node=elem.nextSibling;if(!node){node=elem.parentElement;if(!node||(node==this.target)){this.focusEnd(this.target);}else if(ecma.dom.isChildOf(node,this.target)){this.focusEnd(node);}
return;}else{this.focusStart(node);}}catch(ex){}};proto.insertHTML=function(html){this.exec('insertHTML',html);};proto.exec=function(cmd,value){if(this.isTargetSelected())this.selectContents();if(cmd=='createLink'){if(!value)return;var sel=this.getSelection();var a=ecma.dom.createElement('a',{'href':value});if(sel.isCollapsed){ecma.dom.setAttribute(a,'innerHTML',value);this.insertElement(a);}else{var range=this.getSelection().getRangeAt(0);range.surroundContents(a);}
this.selectElement(a);}else{ecma.document.execCommand(cmd,false,value);}};proto.isTargetSelected=function(){var sel=this.getSelection();return!sel.isCollapsed&&sel.anchorNode===this.target&&sel.anchorOffset==0&&sel.focusNode===this.target&&sel.focusOffset==this.target.childNodes.length;};proto.selectContents=function(){this.getSelection().selectAllChildren(this.target);};proto.focus=function(){var sel=this.getSelection();if(sel.rangeCount==0||!sel.anchorNode||!sel.focusNode||!(sel.anchorNode===this.target||ecma.dom.isChildOf(sel.anchorNode,this.target))||!(sel.focusNode===this.target||ecma.dom.isChildOf(sel.focusNode,this.target))){this.target.focus();sel=ecma.window.getSelection();try{sel.collapseToStart();}catch(ex){}}
if(sel.rangeCount==0)throw'cannot obtain focus';return sel;};proto.getSelection=function(){if(!this.target)throw'not attached';var sel=ecma.window.getSelection();if(!sel.anchorNode){this.target.focus();sel=ecma.window.getSelection();try{sel.collapseToStart();}catch(ex){}}
if(sel.rangeCount>1){for(var i=1;i<sel.rangeCount;i++){sel.removeRange(sel.getRangeAt(i));}}
return sel;};proto.getRange=function(){var sel=this.getSelection();var range=sel.getRangeAt(0);var trunk=range.commonAncestorContainer;if(!trunk||(trunk!==this.target&&!ecma.dom.isChildOf(trunk,this.target))){throw'Selection outside of target';}
return range;};proto.setRange=function(range){var sel=this.getSelection();sel.removeAllRanges();sel.addRange(range);return sel;};proto.createRange=function(){return ecma.document.createRange();};proto.getRanges=function(){var ranges=[]
var sel=this.getSelection();for(var i=0;i<sel.rangeCount;i++){var range=sel.getRangeAt(i);ranges.push([range.startContainer,range.startOffset,range.endContainer,range.endOffset]);}
return ranges;};proto.setRanges=function(ranges){var sel=this.getSelection();sel.removeAllRanges();for(var i=0;i<ranges.length;i++){var range=this.createRange();range.setStart(ranges[i][0],ranges[i][1]);range.setEnd(ranges[i][2],ranges[i][3]);sel.addRange(range);}
return sel;};proto.getCursorStack=function(){var result=[];var range=this.getRange();range.collapse(true);result.push(range);var elem=range.startContainer;while(elem){result.push(elem);if(elem===this.target)break;elem=elem.parentNode;}
return result;};proto.setCursor=function(cursorStack){var range=cursorStack[0];if(range.startContainer&&range.startContainer.parentNode){var sel=this.getSelection();sel.removeAllRanges();sel.addRange(range);}else{for(var i=1,node;node=cursorStack[i];i++){if(node.parentNode){this.selectNode(node).collapseToStart();break;}}}};proto.deleteRangeElements=function(range){if(range.collapsed)return range;var startNode=null;var previousNode=null;var startContainer=range.startContainer;var startOffset=range.startOffset;if(ecma.dom.node.isElement(startContainer)){startNode=startContainer.childNodes[startOffset];previousNode=startNode.previousSibling;}else if(ecma.dom.node.isText(startContainer)){var prefix=startContainer.nodeValue.substr(0,startOffset);var suffix=startContainer.nodeValue.substr(startOffset);startContainer.nodeValue=prefix;startNode=ecma.dom.createElement('#text',{'nodeValue':suffix});previousNode=startContainer;ecma.dom.insertAfter(startNode,startContainer);}else{throw('Unhandled node type');}
var endNode=null;var nextNode=null;var endContainer=range.endContainer;var endOffset=range.endOffset;if(ecma.dom.node.isElement(endContainer)){endNode=endContainer.childNodes[endOffset];nextNode=endNode.nextSibling;}else if(ecma.dom.node.isText(endContainer)){var prefix=endContainer.nodeValue.substr(0,endOffset);var suffix=endContainer.nodeValue.substr(endOffset);endContainer.nodeValue=prefix;endNode=endContainer;nextNode=ecma.dom.createElement('#text',{'nodeValue':suffix});ecma.dom.insertAfter(nextNode,endNode);}else{throw('Unhandled node type');}
function removeUntil(node,endNode){var next=null;while(node){while(node.hasChildNodes()){var stop=removeUntil(node.firstChild,endNode);if(stop)return true;}
next=node.nextSibling||node.parentElement.nextSibling;ecma.dom.removeElement(node);if(node===endNode)return true;node=next;}
return false;}
removeUntil(startNode,endNode);var range=this.createRange();if(previousNode){range.setStart(previousNode,0);range.setEnd(previousNode,this.getEndOffset(previousNode));range.collapse(false);}else if(nextNode){range.setStart(nextNode,0);range.setEnd(nextNode,this.getEndOffset(nextNode));range.collapse(true);}else{range.setStart(startContainer,0);range.setEnd(startContainer,this.getEndOffset(startContainer));range.collapse(true);}
return range;};proto.getEndOffset=function(node){if(ecma.dom.node.isElement(node)){return node.hasChildNodes()?node.childNodes.length-1:0;}else if(ecma.dom.node.isText(node)){return node.nodeValue.length-1;}else{return 0;}};});ECMAScript.Extend('lsn.ext.dde',function(ecma){this.Editor=function(dde,marker){this.dde=dde;this.marker=null;this.target=null;if(marker)this.setMarker(marker);};var Editor=this.Editor.prototype=ecma.lang.createMethods();Editor.exec=function(cmd){};Editor.setMarker=function(marker){this.marker=marker;this.target=marker.elem;return this.marker;};Editor.recordChanges=function(data){throw ecma.error.abstract();};});ECMAScript.Extend('lsn.ext.dde',function(ecma){var CEditor=ecma.lsn.ext.dde.Editor;this.TextEditor=function(dde){if(ecma.dom.browser.isIE)throw'Unsupported browser';CEditor.apply(this,arguments);this.focusElement=undefined;this.attached=false;this.placeholders=[];this.dlgs={};this.cc=new dde.js.lsn.ext.dde.ContentController();this.scrubber=new dde.js.dom.Scrubber(this.dde.js);this.clipboard=new dde.js.lsn.ext.dde.Clipboard(this.cc,this);this.kp=new dde.js.dom.KeyPress({'trace':false});for(var type in this.input){this.kp.setHandler(type,this.input[type],this);}
this.submarkers=new ecma.lsn.ext.dde.MarkerList(dde,ecma.lsn.ext.dde.markers.InlineMarker);this.hrefPopup=new ecma.lsn.ext.dde.popups.Href(dde,this);};var TextEditor=this.TextEditor.prototype=ecma.lang.createMethods(CEditor);TextEditor.setMarker=function(marker){this.marker=marker;this.target=marker.elem;return this.marker;};TextEditor.resize=function(){this.dde.refreshMasks();};TextEditor.begin=function(cmd){this.target.contentEditable='true';this.originalValue=this.target.innerHTML;this.originalHref=this.target.tagName=='A'?this.dde.js.dom.getAttribute(this.target,'href'):undefined;this.focus();this.attach();this.selectFirst();if(cmd)this.exec(cmd);};TextEditor.end=function(){this.removePlaceholders();this.target.blur();this.dde.js.dom.removeAttribute(this.target,'contentEditable');this.detach();this.unmarkImages();this.submarkers.clear();if(this.target.innerHTML!=this.originalValue){this.recordChanges();}else if(this.target.tagName=='A'){var href=this.dde.js.dom.getAttribute(this.target,'href');if(this.originalHref!=href){this.recordChanges();}}
this.dde.status.clear();if(this.hrefPopup.isActive())this.hrefPopup.hide();};TextEditor.recordChanges=function(){var elem=this.target;var attrs=this.marker.getAttributes();var names=attrs.keys();for(var j=0,name;name=names[j];j++){var ds=attrs.get(name);var raw=ecma.dom.getAttribute(elem,name);var val=ecma.data.entities.decode(raw);var re=new RegExp('\\['+'#','g');val=val.replace(re,'[&#35;');this.dde.deltas.addDelta('store',ds,val);}};TextEditor.attach=function(){this.kp.attach(this.target);this.cc.attach(this.target);this.clipboard.attach(this.target);this.attached=true;this.startMonitor();};TextEditor.detach=function(){this.attached=false;this.stopMonitor();this.kp.detach(this.target);this.cc.detach(this.target);this.clipboard.detach(this.target);};TextEditor.markImages=function(){this.submarkers.clear();var imgList=this.target.getElementsByTagName('img');for(var i=0,img;img=imgList[i];i++){this.dde.js.dom.setAttribute(img,'contentEditable','false');this.submarkers.add(img);}};TextEditor.unmarkImages=function(){var imgList=this.target.getElementsByTagName('img');for(var i=0,img;img=imgList[i];i++){this.dde.js.dom.removeAttribute(img,'contentEditable');}};TextEditor.focus=function(){this.dde.frame.focus();if(this.target)this.target.focus();};TextEditor.startMonitor=function(){if(this.monitorId)return;this.monitorId=ecma.dom.setInterval(this.monitorCallback,250,this);this.monitorCallback();};TextEditor.stopMonitor=function(){ecma.dom.clearInterval(this.monitorId);this.monitorId=null;};TextEditor.monitorCallback=function(){if(!this.attached)return;try{var sel=this.cc.getSelection();var value=this.target.innerHTML;if(value!=this.lastCheckedValue){this.updateDisplay();}
if(sel.anchorNode!==this.last_anchorNode||sel.anchorOffset!=this.last_anchorOffset||sel.focusNode!==this.last_focusNode||sel.focusOffset!=this.last_focusOffset){this.updateUI();}
this.lastCheckedValue=value;this.last_anchorNode=sel.anchorNode;this.last_anchorOffset=sel.anchorOffset;this.last_focusNode=sel.focusNode;this.last_focusOffset=sel.focusOffset;}catch(ex){}};TextEditor.updateDisplay=function(){this.dde.refreshMasks();this.markImages();};TextEditor.updateUI=function(cmd){this.focusElement=this.cc.getFocusElement()||this.target;var stack=this.cc.getElementStack(this.focusElement);var menuId='text';var menuElem=this.focusElement;var spath=[];var isAnchor=false;for(var i=0,elem;elem=stack[i];i++){spath.unshift(elem.tagName);if(elem.tagName=='A'){if(elem===this.target&&!ecma.util.grep('href',this.marker.attrs.keys())){menuId='empty';menuElem=null;isAnchor=true;}else{if(this.hrefPopup.isActive()){if(this.hrefPopup.target!=elem)this.hrefPopup.show(elem);isAnchor=true;}else{var imgs=elem.getElementsByTagName('img');if(imgs.length==0){this.hrefPopup.show(elem);isAnchor=true;menuElem=elem;}}}}}
if(!isAnchor&&this.hrefPopup.isActive())this.hrefPopup.hide();var pathMenu=[];var lastIdx=spath.length-1;for(var i=0,tagName;tagName=spath[i];i++){var elem=ecma.dom.createElement('span='+tagName);if(i>0){elem.appendChild(ecma.dom.createElement('a',{'onClick':[this.onSplice,this,[lastIdx-i]],'title':'Unwrap this node (remove it but not its children)','href':'#','style':{'color':'red','text-decoration':'none'}},['sub=(x)']));}
pathMenu.push(elem);if(spath[i+1])pathMenu.push(ecma.dom.createElement('#text= > '));}
this.dde.status.setChildren(pathMenu);this.dde.mm.show(menuId,menuElem,stack,cmd);};TextEditor.exec=function(cmd){var spec=cmd.split(':');var name=spec.shift();if(this[name]instanceof Function){this[name].apply(this,spec);}else if(name=='removeLink'){var anchors=this.cc.getElementsByTagName('A');for(var i=0,a;a=anchors[i];i++){this.dde.js.dom.removeElementOrphanChildren(a);}
this.cc.exec('unlink');}else if(name=='editHTML'){var dlg=new ecma.lsn.Dialog('[#`./dlg-edit-html.html`]',{'refetch':false});dlg.show({'js':this.dde.js,'target':this.target,'editor':this});}else if(name=='replaceText'){this.showDialog('[#`./dlg-edit-find-replace.html`]');}else if(name=='scrubHTML'){var cursorStack=this.cc.getCursorStack();this.scrubber.scrub(this.target);if(this.marker.getOption('paras')=='enforce'){this.forceParagraphs();}
this.cc.setCursor(cursorStack);}else if(name.match(/^justify/)){this.setParagraphJustification(name);}else{this.cc.exec(name);}
this.updateUI(name);};TextEditor.showDialog=function(url){if(!this.dlgs[url]){this.dlgs[url]=new ecma.lsn.Dialog(url,{'refetch':false});}
this.dlgs[url].show({'js':this.dde.js,'target':this.target,'editor':this});};TextEditor.onSplice=function(event,idx){ecma.dom.stopEvent(event);var stack=this.cc.getElementStack(this.focusElement);var elem=stack[idx];ecma.console.log('splice',idx,elem);this.dde.js.dom.removeElementOrphanChildren(elem);this.updateUI();this.focus();};TextEditor.setAttribute=function(name,value){if(!this.focusElement)return;this.dde.js.dom.setAttribute(this.focusElement,name,value);};TextEditor.selectFirst=function(){this.target.focus();if(this.target.hasChildNodes()){var fc=this.target.firstChild;if(fc&&ecma.dom.node.isElement(fc)&&fc.tagName=='BR'&&ecma.dom.hasClassName(fc,'stub')){this.placeholders.push(fc);}else{var textNode=ecma.dom.findNode(this.target,function(n){return ecma.dom.node.isText(n);});if(textNode)this.cc.focusStart(textNode);}}else{this.insertPlaceholder();}
this.updateUI();};TextEditor.jumpForward=function(){if(this.hrefPopup&&this.hrefPopup.isActive()){this.hrefPopup.focus();}else{this.dde.selectNext();}};TextEditor.jumpBackward=function(){this.dde.selectPrevious();};TextEditor.forceParagraphs=function(){var node=this.target.firstChild;var orphans=[];function adoptOrphans(orphans){if(!orphans.length)return;var para=js.dom.createElement('P');js.dom.insertBefore(para,orphans[0]);js.dom.appendChildren(orphans,para);}
while(node){if(!js.dom.node.isElement(node)||node.tagName!='P'){orphans.push(node);}else{adoptOrphans(orphans);orphans=[];}
node=node.nextSibling;}
adoptOrphans(orphans);};TextEditor.insert=function(spec){var elem;var br=this.dde.js.dom.createElement('br');switch(spec){case'ol(li(br))':elem=this.dde.js.dom.createElement('ol',{},['li',[br]]);break;case'ul(li(br))':elem=this.dde.js.dom.createElement('ul',{},['li',[br]]);break;}
if(elem){this.cc.insertElement(elem);this.cc.focusStart(br);this.dde.refreshMasks();}};TextEditor.insertPlaceholder=function(parentElem){if(!parentElem)parentElem=this.target;var ph=this.dde.js.dom.createElement('br');this.placeholders.push(ph);parentElem.appendChild(ph);this.cc.focusBefore(ph);};TextEditor.removePlaceholders=function(){while(this.placeholders.length>0){var ph=this.placeholders.pop();this.dde.js.dom.removeElement(ph);}};TextEditor.insertBreak=function(event){var eSel=this.cc.getFocusElement();this.dde.js.dom.stopEvent(event);var elem=this.dde.js.dom.createElement('br');if(eSel&&eSel!==this.target&&this.hrefPopup.isActive()&&eSel.tagName&&eSel.tagName=='A'&&!eSel.nextSibling){this.dde.js.dom.insertAfter(elem,eSel);this.cc.focusStart(elem);this.hrefPopup.updateUI();}else{this.cc.insertElement(elem);}};TextEditor.insertParaBreak=function(event){var eSel=this.cc.getFocusElement();this.dde.js.dom.stopEvent(event);var elem=this.dde.js.dom.createElement('br',{'style':{'clear':'both'}});this.cc.insertElement(elem);};TextEditor.insertImage=function(){var elem=this.dde.js.dom.createElement('img',{'contentEditable':'false','src':'','alt':'New image'});this.cc.insertElement(elem);};TextEditor.insertImageLink=function(){var elem=this.dde.js.dom.createElement('a',{'href':''},['img',{'contentEditable':'false','src':'','alt':'New image'}]);this.cc.insertElement(elem);};TextEditor.createLink=function(){var selText=this.cc.getSelection().toString();if(selText){if(selText.match(/^[a-z]+:\/\//)){return this.cc.exec('createLink',selText);}else if(selText.match(/@[\w\.-]+\.[a-z]{2,6}$/i)){return this.cc.exec('createLink','mailto:'+selText);}}
this.cc.exec('createLink','http://');this.updateUI();this.hrefPopup.focus();};TextEditor.foreColor=function(){var color=prompt('Color (e.g., #0479A7)');if(color){this.cc.exec('foreColor',color);var stack=this.cc.getElementStack(this.focusElement);for(var i=0,elem;elem=stack[i];i++){if(elem.tagName=='A'){this.dde.js.dom.setStyle(elem,'color',color);}}}};TextEditor.setParagraphType=function(tagName){var elem=this.cc.getContainingParagraph();var newElem=this.dde.js.dom.createElement(tagName);if(elem&&elem===this.target){this.dde.js.dom.insertElementAdoptChildren(newElem,elem);}else if(elem){this.dde.js.dom.appendChildren(newElem,elem.childNodes);this.dde.js.dom.replaceElement(newElem,elem);}else{this.cc.insertElement(newElem);}
if(!newElem.firstChild){this.insertPlaceholder(newElem);}else{this.cc.focusStart(newElem.firstChild);}};TextEditor.setParagraphJustification=function(cmd){var elem=this.cc.getContainingParagraph();if(elem&&elem!==this.target){var align=cmd=='justifyRight'?'right':cmd=='justifyFull'?'justify':cmd=='justifyCenter'?'center':'left';if(align=='justify'){this.dde.js.dom.setStyle(elem,'text-align',align);}else{this.dde.js.dom.setAttribute(elem,'align',align);}}else{alert('Cannot set justification: No containing paragraph');}};TextEditor.setHTML=function(htmlText){var src=htmlText.replace(/^\s+|\s+$/g,'');this.dde.js.dom.setAttribute(this.target,'innerHTML',src);this.selectFirst();};TextEditor.getHTML=function(){this.removePlaceholders();return this.dde.js.dom.getAttribute(this.target,'innerHTML');};TextEditor.input={'ctrl+a':function(event){this.dde.js.dom.stopEvent(event);this.cc.selectContents();},'shift+enter':function(event){this.insertBreak(event);},'ctrl+shift+enter':function(event){this.insertParaBreak(event);},'enter':function(event){if(this.focusElement===this.target||this.cc.getRange().endContainer===this.target){return this.insertBreak(event);}
var inside=true;var node=this.focusElement;while(node){if(node===this.target){inside=false;}
if(!ecma.dom.node.isElement(node))break;if(node.tagName.match(/^(LI|DT|DD)$/)){return inside?null:this.insertBreak(event);}
node=node.parentNode;}},'tab':function(event){this.dde.js.dom.stopEvent(event);this.jumpForward();},'shift+tab':function(event){this.dde.js.dom.stopEvent(event);this.jumpBackward();},'ctrl+b':function(event){this.dde.js.dom.stopEvent(event);this.exec('bold');},'ctrl+i':function(event){this.dde.js.dom.stopEvent(event);this.exec('italic');},'ctrl+u':function(event){this.dde.js.dom.stopEvent(event);this.exec('underline');},'ctrl+l':function(event){this.dde.js.dom.stopEvent(event);this.createLink();},'ctrl+0':function(event){this.dde.js.dom.stopEvent(event);this.setParagraphType('p');},'ctrl+1':function(event){this.dde.js.dom.stopEvent(event);this.setParagraphType('h1');},'ctrl+2':function(event){this.dde.js.dom.stopEvent(event);this.setParagraphType('h2');},'ctrl+3':function(event){this.dde.js.dom.stopEvent(event);this.setParagraphType('h3');},'ctrl+4':function(event){this.dde.js.dom.stopEvent(event);this.setParagraphType('h4');},'ctrl+g':function(event){this.dde.js.dom.stopEvent(event);this.insertImage();},'ctrl+shift+g':function(event){this.dde.js.dom.stopEvent(event);this.insertImageLink();},'ctrl+e':function(event){this.dde.js.dom.stopEvent(event);this.exec('editHTML');},'ctrl+m':function(event){this.dde.js.dom.stopEvent(event);this.exec('scrubHTML');},'esc':function(event){this.dde.js.dom.stopEvent(event);this.dde.deselect();}};});ECMAScript.Extend('lsn.ext.dde',function(ecma){var _insert=function(bBefore){var ok=this.dde.deltas.isUpToDate()?true:confirm('This will require saving your current changes, continue?');if(!ok)return;this.dde.deselect();var cluster=this.marker.cluster;var group=cluster.parentNode;var src=group.data.begin.attrs['new'];var index=ecma.util.asInt(cluster.index);if(!bBefore)index++;var ds=group.data.begin.attrs.ds;this.dde.deltas.addDelta('insert',ds,index,src);this.dde.exec('docSave',true);};var CEditor=ecma.lsn.ext.dde.Editor;var BlockEditor=ecma.lang.createMethods(CEditor);this.BlockEditor=function(dde,marker){CEditor.apply(this,arguments);};this.BlockEditor.prototype=BlockEditor;BlockEditor.resize=function(){this.dde.refreshMasks();};BlockEditor.begin=function(){this.dde.refreshMasks();this.dde.mm.show('block');};BlockEditor.end=function(){};BlockEditor.focus=function(){};BlockEditor.exec=function(cmd,args){var func=this[cmd];if(!ecma.util.isa(func,Function))throw'No such command: '+cmd;func.apply(this,args);};BlockEditor.moveUp=function(){var cluster=this.marker.cluster;var prev=cluster.previousSibling;if(!prev)return;var refElem=prev.firstChild.data;var node=cluster.firstChild;while(node){refElem.parentNode.insertBefore(node.data,refElem);node=node.nextSibling;}
cluster.parentNode.insertBefore(cluster,prev);this.dde.refreshMasks();this.dde.scrollToMarker();this.recordChanges();};BlockEditor.moveDown=function(){var cluster=this.marker.cluster;var next=cluster.nextSibling;if(!next)return;var refElem=next.lastChild.data;var node=cluster.lastChild;while(node){this.dde.js.dom.insertAfter(node.data,refElem);node=node.previousSibling;}
cluster.parentNode.insertAfter(cluster,next);this.dde.refreshMasks();this.dde.scrollToMarker();this.recordChanges();};BlockEditor.recordChanges=function(group){if(!group)group=this.marker.cluster.parentNode;var ds=group.data.begin.attrs.ds;var indexes=[];var node=group.firstChild;while(node){indexes.push(node.data.attrs.key);node=node.nextSibling;}
this.dde.deltas.addDelta('reorder',ds,indexes);};BlockEditor.insertBefore=function(){_insert.call(this,true);};BlockEditor.insertAfter=function(){_insert.call(this,false);};BlockEditor.remove=function(){var cluster=this.marker.cluster;var group=cluster.parentNode;var key=cluster.data.attrs.key;cluster.data.attrs.key=undefined;var addr=group.data.begin.attrs.ds;if((!addr)||(!key&&key!==0)){throw'Cannot determine data address';}
if(!confirm('Remove the select block?'))return;addr+='/'+key;this.dde.deltas.addDelta('remove',addr);this.dde.deselect();var node=cluster.firstChild;while(node){this.dde.removeMarkersFrom(node.data);node.data.parentNode.removeChild(node.data);node.data=null;node=node.nextSibling;}
group.removeChild(cluster);this.recordChanges(group);this.dde.removeMarker(this.marker);this.dde.refreshMarkers();};});ECMAScript.Extend('lsn.ext.dde',function(ecma){var CActionDispatcher=ecma.action.ActionDispatcher;var _attrProps=[#:js:var ./attributes.hf];this.AttributeControl=function(attr,ds){CActionDispatcher.apply(this);this.ui={};this.attr=attr;this.ds=ds;this.orig='';this.input=null;this.combo=null;this.vChange=null;try{this.props=_attrProps.get(this.attr).toObject();}catch(ex){this.props={'label':attr};ecma.console.log('No control properties for attribute: '+attr);}};var AttributeControl=this.AttributeControl.prototype=ecma.lang.createMethods(CActionDispatcher);AttributeControl.getRootElement=function(){return this.ui.root||this.createUI();};AttributeControl.createUI=function(){this.ui.dt=ecma.dom.createElement('DT',{'innerHTML':this.props.label});this.ui.dd=ecma.dom.createElement('DD');this.input=this.createInput();if(!this.hidden){this.ui.dd.appendChild(this.input);this.extendInput();}
this.ui.root=ecma.dom.createElement('DL',[this.ui.dt,this.ui.dd]);return this.ui.root;};AttributeControl.createInput=function(){var input=null;if(this.props.options){input=ecma.dom.createElement('SELECT');for(var j=0,opt;opt=this.props.options[j];j++){var optElem=ecma.dom.createElement('OPTION',{'value':opt.value,'innerHTML':opt.text});input.appendChild(optElem);}}else if(this.hidden){input={'value':null};}else{input=ecma.dom.createElement('INPUT');this.vChange=new ecma.dom.EventListener(input,'change',this.onChange,this);}
return input;};AttributeControl.extendInput=function(){if(this.attr=='src'){this.combo=new ecma.lsn.ext.dde.ImageCombo();this.combo.addActionListener('select',this.onChange,this);this.combo.attach(this.input);this.combo.expand('/');}else if(this.attr=='href'){this.combo=new ecma.lsn.ext.dde.FileCombo();this.combo.addActionListener('select',this.onChange,this);this.combo.attach(this.input);this.combo.expand('/');}};AttributeControl.onChange=function(){this.dispatchAction('onChange');};AttributeControl.getHelp=function(){if(this.props.summary){var str='<b>'+this.props.label+'</b>';if(this.props.example){str+=' (<span class="eg">e.g., '+this.props.example+'</span>)';}
str+='<br/>';str+=this.props.summary;return str;}else{return'<i>No help available</i>';}};AttributeControl.setOriginalValue=function(value){this.orig=value;this.input.value=value;return value;};AttributeControl.setValue=function(value){ecma.dom.setValue(this.input,value);return value;};AttributeControl.getValue=function(){return this.hidden?this.orig:ecma.dom.getValue(this.input);};AttributeControl.reset=function(){this.orig='';};AttributeControl.destroy=function(){if(this.vChange)this.vChange.remove();if(this.combo)this.combo.destroy();};});ECMAScript.Extend('lsn.ext.dde',function(ecma){var CEditor=ecma.lsn.ext.dde.Editor;this.AttributeEditor=function(dde,marker){CEditor.apply(this,arguments);this.modified=false;this.dde.mm.show('none');this.opts=this.initOptions();this.ctrls=this.initControls();};var AttributeEditor=this.AttributeEditor.prototype=ecma.lang.createMethods(CEditor);AttributeEditor.initOptions=function(){var optStr=this.dde.js.dom.getAttribute(this.target,'_lsn_opts');return ecma.lsn.ext.dde.parseAttributes(optStr);};AttributeEditor.initControls=function(){var result=[];var attrs=this.marker.getAttributes();attrs.iterate(function(attr,ds){result.push(new ecma.lsn.ext.dde.AttributeControl(attr,ds));},this);return result;};AttributeEditor.getControl=function(attr){for(var i=0,ctrl;ctrl=this.ctrls[i];i++){if(ctrl.attr===attr)return ctrl;}};AttributeEditor.resize=function(){this.dde.refreshMasks();};AttributeEditor.begin=function(){this.dde.refreshMasks();if(!this.dlg){this.dlg=new ecma.lsn.Dialog("[#:html:url './dlg-edit-attr.html']",{modal:true,modalOpacity:0,refetch:false});this.dlg.addEvent('show',ecma.lang.Callback(this.onShow,this));this.dlg.addEvent('ready',ecma.lang.Callback(this.onReady,this));this.dlg.addEvent('ok',ecma.lang.Callback(this.onOk,this));this.dlg.addEvent('apply',ecma.lang.Callback(this.onApply,this));this.dlg.addEvent('cancel',ecma.lang.Callback(this.onCancel,this));}
this.dlg.show();};AttributeEditor.end=function(){this.dlg.hide();if(this.modified){var data={};var resize=null;for(var i=0,ctrl;ctrl=this.ctrls[i];i++){if(ctrl.attr=='resize'){resize=this.getAttribute(ctrl.attr);continue;}
data[ctrl.attr]=this.getAttribute(ctrl.attr);}
if(resize){data['src']+='?resize='+resize;}
this.recordChanges(data);}
for(var i=0,ctrl;ctrl=this.ctrls[i];i++){ctrl.destroy();}};AttributeEditor.recordChanges=function(data){var elem=this.elem;var attrs=this.marker.getAttributes();var names=attrs.keys();for(var j=0,name;name=names[j];j++){var ds=attrs.get(name);var raw=data[name];var val=ecma.data.entities.decode(raw);var re=new RegExp('\\['+'#','g');val=val.replace(re,'[&#35;');this.dde.deltas.addDelta('store',ds,val);}};AttributeEditor.canRemove=function(){return false;};AttributeEditor.focus=function(){var ctrl=this.ctrls[0];if(ctrl){ctrl.input.focus();}};AttributeEditor.getValue=function(attr){var ctrl=this.getControl(attr);return ctrl?ctrl.getValue():undefined;};AttributeEditor.onShow=function(){ecma.dom.removeChildren(this.dlg.params.container);for(var i=0,ctrl;ctrl=this.ctrls[i];i++){var elem=ctrl.getRootElement();ctrl.setOriginalValue(this.getAttribute(ctrl.attr));if(!ctrl.hidden){ecma.dom.addEventListener(ctrl.input,'focus',this.showHelp,this,[ctrl]);ecma.dom.appendChild(this.dlg.params.container,elem);}}
if(this.canRemove()){var btnApply=this.dlg.getElementById('btn_apply');ecma.dom.insertBefore(ecma.dom.createElement('button=Delete',{'onClick':[this.onRemove,this],'id':'btn_remove'}),btnApply);}};AttributeEditor.showHelp=function(event,ctrl){ecma.dom.setValue(this.helpArea,ctrl.getHelp());};AttributeEditor.clearHelp=function(event,ctrl){ecma.dom.setValue(this.helpArea,'');};AttributeEditor.onReady=function(){if(!this.helpArea){this.helpArea=ecma.dom.createElement('div',{'class':'help'});var pe=this.dlg.getElementById('btnbar');ecma.dom.insertAfter(this.helpArea,pe);}
this.focus();};AttributeEditor.onApply=function(){var isResized=false;for(var i=0,ctrl;ctrl=this.ctrls[i];i++){var attr=ctrl.attr;var value=ctrl.getValue();this.setAttribute(attr,value);if(attr=='resize'&&value)isResized=true;}
if(!isResized){this.dde.js.dom.removeAttribute(this.target,'width');this.dde.js.dom.removeAttribute(this.target,'height');}
this.dde.refreshMasks();};AttributeEditor.setAttribute=function(attr,value){if(this.target.tagName=='A'){if(attr=='href'){var href=this.dde.js.dom.getAttribute(this.target,'href');if(this.target.innerHTML==href){this.target.innerHTML=value;}}}
this.dde.js.dom.setAttribute(this.target,attr,value);};AttributeEditor.getAttribute=function(attr){return this.dde.js.dom.getAttribute(this.target,attr);};AttributeEditor.onOk=function(){this.onApply();this.modified=true;for(var i=0,ctrl;ctrl=this.ctrls[i];i++){ctrl.reset();}
if(this.dde.getEditor()===this)this.dde.deselect();};AttributeEditor.onCancel=function(){for(var i=0,ctrl;ctrl=this.ctrls[i];i++){this.setAttribute(ctrl.attr,ctrl.orig);}
this.modified=false;if(this.dde.getEditor()===this)this.dde.deselect();};});ECMAScript.Extend('lsn.ext.dde',function(ecma){var CAttributeEditor=ecma.lsn.ext.dde.AttributeEditor;this.ImageEditor=function(){CAttributeEditor.apply(this,arguments);this.hyperlink=null;this.evtLoad=null;};var ImageEditor=this.ImageEditor.prototype=ecma.lang.createMethods(CAttributeEditor);ImageEditor.isHyperlinked=function(){return this.hyperlink?true:false;};ImageEditor.begin=function(){this.evtLoad=new this.dde.js.dom.EventListener(this.target,'load',this.onImageLoad,this);return CAttributeEditor.prototype.begin.apply(this,arguments);};ImageEditor.end=function(){this.evtLoad.remove();return CAttributeEditor.prototype.end.apply(this,arguments);};ImageEditor.initControls=function(){var result=CAttributeEditor.prototype.initControls.apply(this,arguments);if(!this.marker.attrs.get('resize')){var ctrl=new ecma.lsn.ext.dde.AttributeControl('resize');ctrl.hidden=this.opts.get('resize')=='no-resize';result.push(ctrl);}
return result;};ImageEditor.onReady=function(){CAttributeEditor.prototype.onReady.apply(this,arguments);var ctrl=this.getControl('src');ctrl.addActionListener('onChange',this.onSelectImage,this);};ImageEditor.onSelectImage=function(action){this.setAttribute('src',this.getValue('src'));this.setAttribute('resize',this.getValue('resize'));};ImageEditor.onImageLoad=function(event){this.dde.refreshMasks();};ImageEditor.setAttribute=function(attr,value){if(attr.match(/^(href|target|rev|rel)$/)){var a=this.target.parentNode;if(a.tagName!='A'){throw('images with attribute "'+attr+'" must be a child of an anchor element');}
this.dde.js.dom.setAttribute(a,attr,value);}else if(attr=='resize'){try{var src=this.getAttribute('src');src+='?resize='+(value||'1:1');var req=new ecma.http.Request(src);req.method='HEAD';req.submit(null,[function(req){var headers=req.xhr.getAllResponseHeaders();var w=req.xhr.getResponseHeader('X-Image-DisplayWidth');var h=req.xhr.getResponseHeader('X-Image-DisplayHeight');if(w&&h){this.dde.js.dom.setAttribute(this.target,'width',w);this.dde.js.dom.setAttribute(this.target,'height',h);}
this.dde.refreshMasks();},this]);}catch(ex){}
if(value){this.dde.js.dom.setAttribute(this.target,'src',src);}}else{CAttributeEditor.prototype.setAttribute.apply(this,arguments);}};ImageEditor.getAttribute=function(attr){var result=null;if(attr.match(/^(href|target|rev|rel)$/)){var a=this.target.parentNode;if(a.tagName!='A'){throw('images with attribute "'+attr+'" must be a child of an anchor element');}
result=this.dde.js.dom.getAttribute(a,attr);result=ecma.util.defined(result)?decodeURIComponent(result):'';}else if(attr=='src'){var src=this.dde.js.dom.getAttribute(this.target,'src');var parts=src.split('?',2);if(parts.length==2&&parts[1].match(/resize=([\dx]+)/)){result=parts[0];}else{result=src;}
result=decodeURIComponent(result);}else if(attr=='resize'){var src=this.dde.js.dom.getAttribute(this.target,'src');var parts=src.split('?',2);if(parts.length==2){var m=parts[1].match(/resize=([\dx]+)/);if(m)result=m[1];}}else{result=CAttributeEditor.prototype.getAttribute.apply(this,arguments);}
return result;};});ECMAScript.Extend('lsn.ext.dde',function(ecma){var CImageEditor=ecma.lsn.ext.dde.ImageEditor;this.InlineImageEditor=function(){CImageEditor.apply(this,arguments);};var InlineImageEditor=this.InlineImageEditor.prototype=ecma.lang.createMethods(CImageEditor);InlineImageEditor.canRemove=function(){return true;};InlineImageEditor.recordChanges=function(data){};InlineImageEditor.onRemove=function(event){if(confirm('Are you sure?')){this.onCancel();this.end();this.dde.js.dom.removeElement(this.target);}};InlineImageEditor.enableHyperlink=function(){if(this.isHyperlinked())return;this.hyperlink=this.js.dom.createElement('A');this.js.dom.insertBefore(this.target,this.hyperlink)
this.js.dom.appendChild(this.hyperlink,this.target);};InlineImageEditor.disableHyperlink=function(){if(!this.isHyperlinked())return;this.js.dom.removeElementOrphanChildren(this.hyperlink);this.hyperlink=null;};});ECMAScript.Extend('lsn.ext.dde',function(ecma){this.MarkerList=function(dde){this.dde=dde;this.markers=[];this.layer=dde.ui.submarkers;};var MarkerList=this.MarkerList.prototype={};MarkerList.add=function(elem){var klass=ecma.lsn.ext.dde.markers.InlineMarker;var attrs=null;this.markers.push(new klass(this.dde,elem,attrs));};MarkerList.clear=function(){ecma.dom.removeChildren(this.layer);};});ECMAScript.Extend('lsn.ext.dde.markers',function(ecma){this.Base=function(dde,pelem){this.dde=dde;this.attrs=null;this.menu=new ecma.lsn.ext.dde.PopupMenu(dde);this.maskType='normal';this.modified=false;this.images=[];this.editor=null;this.pelem=pelem||dde.ui.markers;this.box={};this.adjust={x:0,y:0};};var Base=this.Base.prototype=ecma.lang.createMethods();Base.getBoundingBox=ecma.lang.createAbstractFunction();Base.getType=function(){return'unknown';};Base.getEditor=ecma.lang.createAbstractFunction();Base.getAttributes=function(){return this.attrs;};Base.getAttribute=function(key){return this.attrs?this.attrs.getString(key):undefined;};Base.createImage=function(fn,w,h,l,t){var basePath="[#:html:url '../images/markers']";var elem=this.dde.js.dom.createElement('img',{'src':basePath+'/'+fn,'onClick':[this.onClick,this],'onMouseOver':[this.onMouseOver,this],'onMouseOut':[this.onMouseOut,this],'class':'dde-marker','width':w,'height':h,'style':{'position':'absolute','cursor':'pointer'}});this.images.push({'elem':elem,'offsetLeft':l,'offsetTop':t});this.pelem.appendChild(elem);};Base.onClick=function(event){if(!this.dde.editor){this.dde.setMaskType(this.maskType);this.dde.showMask(this);this.dde.select(this);}};Base.onDblClick=function(event){};Base.onMouseOver=function(event){if(!this.dde.editor){this.dde.setMaskType(this.maskType);this.dde.showMask(this);}};Base.onMouseOut=function(event){if(!this.dde.editor){this.dde.hideMask();}};Base.refresh=function(){this.box=this.getBoundingBox();for(var i=0,img;img=this.images[i];i++){var l=this.box.left+img.offsetLeft+this.dde.body_x+this.adjust.x;var t=this.box.top+img.offsetTop+this.dde.body_y+this.adjust.y;l=ecma.util.asInt(l,true);t=ecma.util.asInt(t,true);this.dde.js.dom.setStyle(img.elem,'left',l+'px');this.dde.js.dom.setStyle(img.elem,'top',t+'px');}};Base.remove=function(){for(var i=0,img;img=this.images[i];i++){this.dde.js.dom.removeElement(img.elem);}
this.images=[];};});ECMAScript.Extend('lsn.ext.dde.markers',function(ecma){var baseClass=ecma.lsn.ext.dde.markers.Base;var proto=ecma.lang.Methods(baseClass);this.ContentMarker=function(dde,elem){baseClass.apply(this,[dde]);this.elem=elem;var attrStr=this.dde.js.dom.getAttribute(elem,'_lsn_ds');this.attrs=ecma.lsn.ext.dde.parseAttributes(attrStr);var optsStr=this.dde.js.dom.getAttribute(elem,'_lsn_opts');this.opts=ecma.lsn.ext.dde.parseAttributes(optsStr);this.createImage("marker7c.png",16,16,0,0);this.refresh();},this.ContentMarker.prototype=proto;proto.getOption=function(key){return this.opts?this.opts.getString(key):undefined;};proto.getType=function(){return ecma.util.grep('innerHTML',this.attrs.keys())?'text':this.elem.tagName=='IMG'?'image':'attribute';};proto.getEditor=function(){try{if(ecma.util.grep('innerHTML',this.attrs.keys())){if(!this.dde.editors.TextEditor){this.dde.editors.TextEditor=new ecma.lsn.ext.dde.TextEditor(this.dde)}
this.dde.editors.TextEditor.setMarker(this);return this.dde.editors.TextEditor;}else if(this.elem.tagName=='IMG'){return new ecma.lsn.ext.dde.ImageEditor(this.dde,this);}else{return new ecma.lsn.ext.dde.AttributeEditor(this.dde,this);}}catch(ex){alert(ex);}},proto.getBoundingBox=function(){var pos=this.dde.js.dom.getElementPosition(this.elem);if(pos.width<10){pos.width=16;pos.right=pos.left+16;}
if(pos.height<10){pos.height=16;pos.bottom=pos.top+16;}
var imgList=this.elem.getElementsByTagName('img');for(var i=0,img;img=imgList[i];i++){pos.height=Math.max(pos.height,this.dde.js.dom.getHeight(img));pos.width=Math.max(pos.width,this.dde.js.dom.getWidth(img));}
return pos;};});ECMAScript.Extend('lsn.ext.dde',function(ecma){this.BlockInfo=function(){ecma.data.Node.apply(this,[new Object()]);this.data.begin=null;this.data.end=null;};this.BlockInfo.prototype=ecma.lang.createMethods(ecma.data.Node);ecma.util.overlay(this.BlockInfo.prototype,{setBegin:function(cnode,cdata){var attrs=ecma.lsn.ext.dde.parseAttributes(cdata);this.data.begin={'cnode':cnode,'attrs':attrs.toObject()};},addItem:function(cnode,cdata){var attrs=ecma.lsn.ext.dde.parseAttributes(cdata);var node=this.appendChild({'cnode':cnode,'attrs':attrs.toObject()});this.captureElements(node.previousSibling,cnode);},setEnd:function(cnode,cdata){var attrs=ecma.lsn.ext.dde.parseAttributes(cdata);this.data.end={'cnode':cnode,'attrs':attrs.toObject()};if(!this.lastChild){this.appendChild({'cnode':cnode,'attrs':attrs.toObject()});}else{this.captureElements(this.lastChild,cnode);}},captureElements:function(node,endElem){if(!node)return;var elem=node.data.cnode.nextSibling;while(elem&&elem!==endElem){node.appendChild(elem);elem=elem.nextSibling;}
ecma.dom.removeElement(node.data.cnode);}});});ECMAScript.Extend('lsn.ext.dde.markers',function(ecma){function _getBoundingBox(elem,box){if(!ecma.dom.node.isElement(elem))return;var pos=this.dde.js.dom.getElementPosition(elem);box.x1=box.x1==null?pos.left:Math.min(box.x1,pos.left);box.y1=box.y1==null?pos.top:Math.min(box.y1,pos.top);box.x2=Math.max(box.x2,this.dde.js.dom.getRight(elem));box.y2=Math.max(box.y2,this.dde.js.dom.getBottom(elem));_getOverflowBounds.call(this,elem,box);}
function _getOverflowBounds(elem,box){if(!ecma.dom.node.isElement(elem))return;if(elem.tagName=='IMG'){box.x2=Math.max(box.x2,this.dde.js.dom.getRight(elem));box.y2=Math.max(box.y2,this.dde.js.dom.getBottom(elem));}
var child=elem.firstChild;while(child){_getOverflowBounds.call(this,child,box);child=child.nextSibling;}}
function _getPrecedingElement(elem){if(elem.previousSibling){if(ecma.dom.node.isElement(elem.previousSibling)){return elem.previousSibling;}else{return _getPrecedingElement.call(this,elem.previousSibling);}}else if(elem.parentNode&&elem.parentNode!==elem){if(ecma.dom.node.isElement(elem.parentNode)){return elem.parentNode;}else{return _getPrecedingElement.call(this,elem.parentNode);}}else{return undefined;}}
var CBase=ecma.lsn.ext.dde.markers.Base;var BlockMarker=ecma.lang.Methods(CBase);this.BlockMarker=function(dde,cluster){CBase.call(this,dde);this.maskType='block';this.cluster=cluster;this.createImage("marker7a.png",19,6,-3,-6),this.createImage("marker7b.png",6,19,-6,0),this.refresh();};this.BlockMarker.prototype=BlockMarker;BlockMarker.getType=function(){return'block';}
BlockMarker.getEditor=function(){if(!this.editor){this.editor=new ecma.lsn.ext.dde.BlockEditor(this.dde,this);}
return this.editor;};BlockMarker.getBoundingBox=function(){var box={x1:null,y1:null,x2:0,y2:0}
var node=this.cluster.firstChild;if(!node){var cnode=this.cluster.data.cnode;if(cnode){var elem=_getPrecedingElement.call(this,cnode);if(elem){_getBoundingBox.call(this,elem,box);}}}else{while(node){var elem=node.data;_getBoundingBox.call(this,elem,box);node=node.nextSibling;}}
box.x1=ecma.util.asInt(box.x1);box.y1=ecma.util.asInt(box.y1);return{top:box.y1,left:box.x1,width:box.x2-box.x1,height:box.y2-box.y1};};});ECMAScript.Extend('lsn.ext.dde.markers',function(ecma){var CBase=ecma.lsn.ext.dde.markers.Base;this.InlineMarker=function(dde,elem,attrs){CBase.apply(this,[dde,dde.ui.submarkers]);this.elem=elem;if(elem.tagName=='IMG'){this.attrs=new ecma.data.HashList('src',null,'alt',null,'border',null,'align',null);if(elem.parentNode&&elem.parentNode.tagName=='A'){this.attrs.set('href',null);this.attrs.set('rel',null);}}else{throw'no implementation for editing such an element';}
this.createImage("marker7c.png",16,16,0,0);this.refresh();};var InlineMarker=this.InlineMarker.prototype=ecma.lang.Methods(CBase);InlineMarker.getBoundingBox=function(){var pos=this.dde.js.dom.getElementPosition(this.elem);if(pos.width<10){pos.width=16;pos.right=pos.left+16;}
if(pos.height<10){pos.height=16;pos.bottom=pos.top+16;}
return pos;};InlineMarker.onClick=function(event){this.editor=new ecma.lsn.ext.dde.InlineImageEditor(this.dde,this);this.editor.begin();};InlineMarker.onMouseOver=function(event){};InlineMarker.onMouseOut=function(event){};});ECMAScript.Extend('lsn.ext.dde',function(ecma){this.PopupMenu=function(dde,children){this.dde=dde;this.active=false;this.celem=ecma.dom.createElement('div');this.elem=ecma.dom.createElement('div',{'class':'popupmenu','style':{'position':'absolute'}},['table',['tbody',['tr',['td',[this.celem]]]]]);this.children=children;if(this.children)ecma.dom.appendChildren(this.celem,this.children);this.clickMask=new ecma.lsn.Mask({'opacity':0});ecma.dom.addEventListener(this.clickMask.ui,'click',this.hide,this);};this.PopupMenu.prototype={isActive:function(){return this.active;},show:function(event){this.clickMask.show();this.dde.refreshMasks();var pointer=this.dde.js.dom.getEventPointer(event);this.dde.js.dom.stopEvent(event);var l=pointer.x;var t=pointer.y+[#../index.html/menubar/height];ecma.dom.setStyle(this.elem,'top',t+'px');ecma.dom.setStyle(this.elem,'left',l+'px');ecma.dom.getBody().appendChild(this.elem);this.active=true;},hide:function(){ecma.dom.removeElement(this.elem);this.clickMask.hide();this.active=false;},exec:function(event,cmd){ecma.dom.stopEvent(event);alert(cmd);this.hide();}};});ECMAScript.Extend('lsn.ext.dde.popups',function(ecma){CPopupMenu=ecma.lsn.ext.dde.PopupMenu;this.Href=function(dde,editor){this.createUI();this.editor=editor;CPopupMenu.apply(this,[dde,this.ui.root]);};var proto=this.Href.prototype=ecma.lang.createMethods(CPopupMenu);proto.createUI=function(){this.ui=new Object();this.ui.ctrl=ecma.dom.createElement('input',{onChange:[this.updateHref,this],style:{'width':'400px'}});this.ui.rel=ecma.dom.createElement('input',{onChange:[this.updateRel,this],style:{'width':'100px'}});this.ui.btnAdvanced=ecma.dom.createElement('a',{onClick:[this.toggleAdvanced,this],innerHTML:'Advanced',style:{}});this.ui.advanced=ecma.dom.createElement('div',{style:{display:'none',padding:'8px 4px 4px 4px'}},['label=rel: ',this.ui.rel]);this.ui.btnUnlink=ecma.dom.createElement('a=Unlink',{'onClick':[this.onUnlink,this]});this.ui.root=ecma.dom.createElements(this.ui.ctrl,'div',{style:{'margin-top':'2px'}},[this.ui.btnAdvanced,'#text= | ',this.ui.btnUnlink,],this.ui.advanced);};proto.updateUI=function(){var l=this.dde.js.dom.getLeft(this.target);var t=this.dde.js.dom.getBottom(this.target)+[#../index.html/menubar/height];var vp=this.dde.js.dom.getViewportPosition();t+=4;t-=vp.top;l-=vp.left;var maxL=vp.width-440;var maxT=vp.width-60;if(l>maxL)l=maxL;if(t>maxT)t-=100;ecma.dom.setStyle(this.elem,'top',t+'px');ecma.dom.setStyle(this.elem,'left',l+'px');};proto.show=function(target){if(!this.list){this.list=new ecma.lsn.ext.dde.FileCombo();this.list.attach(this.ui.ctrl);this.list.expand('/');this.list.addActionListener('userselect',this.onSelect,this);}
this.target=target;this.updateUI();ecma.dom.getBody().appendChild(this.elem);var value=this.target?this.dde.js.dom.getAttribute(this.target,'href'):'';ecma.dom.setValue(this.ui.ctrl,value);var relValue=this.target?this.dde.js.dom.getAttribute(this.target,'rel'):'';ecma.dom.setValue(this.ui.rel,relValue);this.vScroll=new this.dde.js.dom.EventListener(this.dde.js.window,'scroll',this.onScroll,this);this.kp=new ecma.dom.KeyPress();this.kp.setHandler('enter',this.finish,this);this.kp.setHandler('shift+tab',this.blur,this);this.kp.attach(this.ui.ctrl);this.list.hide();this.active=true;};proto.appear=function(){this.tId=null;this.updateUI();ecma.dom.setStyle(this.elem,'visibility','visible');};proto.onScroll=function(event){if(this.tId){ecma.dom.clearTimeout(this.tId);}else{ecma.dom.setStyle(this.elem,'visibility','hidden');}
this.tId=ecma.dom.setTimeout(this.appear,100,this);};proto.focus=function(){this.ranges=this.editor.cc.getRanges();this.ui.ctrl.focus();};proto.blur=function(event){ecma.dom.stopEvent(event);this.ui.ctrl.blur();this.ui.rel.blur();this.editor.focus();if(this.ranges){this.editor.cc.setRanges(this.ranges);}};proto.finish=function(event){this.blur(event);this.editor.cc.focusAfter(this.target);};proto.hide=function(){this.kp.detach(this.ui.ctrl);this.vScroll.remove();ecma.dom.removeElement(this.elem);this.active=false;};proto.updateHref=function(event){if(!this.target)return;this.target.href=this.ui.ctrl.value;};proto.updateRel=function(event){if(!this.target)return;this.target.rel=this.ui.rel.value;};proto.onSelect=function(){this.updateHref();};proto.onUnlink=function(event){ecma.dom.stopEvent(event);this.hide();var editor=this.dde.getEditor();if(editor){editor.exec('removeLink');this.dde.js.window.focus();editor.focus();}};proto.toggleAdvanced=function(event){ecma.dom.stopEvent(event);var display=ecma.dom.getStyle(this.ui.advanced,'display');ecma.dom.setStyle(this.ui.advanced,'display',display=='none'?'block':'none');};});ECMAScript.Extend('lsn.ext.dde',function(ecma){var proto={};this.StatusBar=function(elem){this.ui=ecma.dom.getElement(elem);this.history=[];this.timeout=4000;this.tidFlash=null;};this.StatusBar.prototype=proto;proto.set=function(text){this.clear();this.history.push(text);var elem=ecma.dom.createElement('span',{'innerHTML':text});ecma.dom.replaceChildren(this.ui,[elem]);return elem;};proto.setChildren=function(){this.clear();ecma.dom.replaceChildren(this.ui,arguments);};proto.clear=function(){if(this.tidFlash)ecma.dom.clearTimeout(this.tidFlash);this.tidFlash=null;ecma.dom.removeChildren(this.ui);};proto.flash=function(text){this.set(text);this.tidFlash=ecma.dom.setTimeout(this.clear,this.timeout,this);};proto.notify=function(text){var vp=js.dom.getViewportPosition();var msgElem=ecma.dom.createElement('span',{'innerHTML':text,'style':{'font-size':'12px'}});ecma.dom.replaceChildren(this.ui,[msgElem]);var pad=12;var width=ecma.dom.getWidth(msgElem)+(2*pad);var left=(vp.width/2)-(width/2);var wrapElem=ecma.dom.createElement('div',{'class':'statusNotify','style':{'position':'absolute','top':(vp.height/5)+'px','width':width+'px','left':left+'px','padding':pad+'px'}},[msgElem]);ecma.dom.getBody().appendChild(wrapElem);ecma.dom.setStyle(msgElem,'visibility','visible');ecma.dom.setTimeout(ecma.dom.removeElement,this.timeout,null,[wrapElem]);this.flash(text);};});ECMAScript.Extend('lsn.ext.dde',function(ecma){var CAction=ecma.action.ActionDispatcher;this.Deltas=function(dc){CAction.apply(this);this.dc=dc;this.queue=new ecma.data.HashList();};var Deltas=this.Deltas.prototype=ecma.lang.createMethods(CAction);Deltas.isUpToDate=function(){return this.queue.length==0;};Deltas.addDelta=function(verb,target,value){ecma.lang.assert(target.indexOf('/')==0);var uniq=verb=='remove'?ecma.util.randomId():verb+target;var key=ecma.data.md5.sum(uniq);var cmd=this.queue.get(key);if(cmd){cmd[2]=value;}else{cmd=this.queue.set(key,ecma.util.args(arguments));}};var _order={'store':0,'remove':1,'reorder':2,'insert':3};Deltas.commit=function(){this.dc.batch(this.queue.values().sort(function(a,b){return _order[a[0]]-_order[b[0]];}),[this.onComplete,this]);};Deltas.onComplete=function(result){this.clear();this.dispatchAction('complete');};Deltas.clear=function(){this.queue.clear();};});ECMAScript.Extend('lsn.ext.dde',function(ecma){var CActionDispatcher=ecma.action.ActionDispatcher;var _cookieKey='lsn.ext.dde';var _cookies=new ecma.http.Cookies();var proto=ecma.lang.createMethods(CActionDispatcher);this.Application=function(menuId,sbId,frameId){CActionDispatcher.apply(this);this.saving=null;this.baseLoc=new ecma.http.Location();this.docLoc=undefined;this.menuId=menuId;this.frameId=frameId;this.dc=new ecma.hubb.getInstance();this.editor=undefined;this.marker=undefined;this.js=undefined;this.felem=ecma.dom.getElement(frameId);this.frame=ecma.dom.getFrame(frameId);this.status=new ecma.lsn.ext.dde.StatusBar(sbId);this.deltas=null;this.markers=[];this.masks=[];this.editors={};this.mm=new ecma.lsn.ext.dde.MenuManager(this,this.menuId);this.reloadAfterCommit=null;this.vLoad=new ecma.dom.EventListener(this.felem,'load',this.onFrameLoad,this);this.vBeforeUnload=new ecma.dom.EventListener(ecma.window,'beforeunload',this.onBeforeUnload,this);this.attachToWindow();};this.Application.prototype=proto;proto.attachToWindow=function(){this.js=ecma.dom.getContentJS(this.felem);this.js.dom.addEventListener(this.js.window,'load',function(event){ecma.console.log('Child window onLoad event.');},this);this.js.window.opener=null;this.js.window.top=this.js.window.parent=this.js.window;};proto.disable=function(){this.mm.show('none');};proto.enable=function(){this.mm.show('main');};proto.getDocumentAddress=function(){return this.docLoc?this.docLoc.pathname:null;};proto.getTargetJS=function(){try{var doc=ecma.dom.getContentDocument(this.frame);var win=ecma.dom.getContentWindow(this.frame);var tjs=new ECMAScript.Class(win,doc);if(!ecma.http.isSameOrigin(ecma.document.location.href,doc.location.href)){tjs=null;}
return tjs;}catch(ex){return null;}};proto.onBeforeUnload=function(event){return this.onFrameBeforeUnload(event);};proto.setLastDocument=function(url){var cookieData=_cookies.getObject(_cookieKey);var values=cookieData?cookieData.toObject():{};values.lastDocument=url;_cookies.setObject(_cookieKey,values,30);};proto.getLastDocument=function(){var cookieData=_cookies.getObject(_cookieKey);return cookieData?cookieData.getValue('lastDocument'):undefined;};proto.onFrameLoad=function(event){var targetJS=this.getTargetJS();var docLoc=targetJS?new targetJS.http.Location():null;if(this.saving){if(docLoc&&docLoc.isSameDocument(this.saving)){this.reloadAfterCommit=this.saving;}else{ecma.dom.setTimeout(this.onFrameLoad,250,this,[event]);}
return;}
this.editors={};this.markers=[];this.masks=[];if(!targetJS)return this.disable();this.js=targetJS;this.docLoc=docLoc;this.setLastDocument(docLoc.getHref());this.mm.show('main');this.ui={popups:this.js.dom.createElement('div',{id:'dde-popup-layer',style:{'position':'absolute','z-index':10000,'top':0,'left':0}}),markers:this.js.dom.createElement('div',{id:'dde-marker-layer',style:{'position':'absolute','z-index':10000,'top':0,'left':0}}),submarkers:this.js.dom.createElement('div',{id:'dde-submarker-layer',style:{'position':'absolute','z-index':10000,'top':0,'left':0}}),masks:this.js.dom.createElement('div',{id:'dde-mask-layer',style:{'position':'absolute','z-index':9999,'top':0,'left':0}},this.createMasks())};this.body=this.js.dom.getBody();this.ce=this.js.dom.browser.isIE?this.body:this.body.parentNode||this.body;if(this.js.dom.getStyle(this.body,'position')=='relative'){this.body_x=ecma.util.asInt(this.js.dom.getStyle(this.body,'margin-top'));this.body_y=ecma.util.asInt(this.js.dom.getStyle(this.body,'margin-left'));}else{this.body_x=0;this.body_y=0;}
this.ce.appendChild(this.ui.markers);this.ce.appendChild(this.ui.submarkers);this.ce.appendChild(this.ui.masks);this.ce.appendChild(this.ui.popups);this.js.dom.include.style({href:"[#:html:url './masks.css']"});this.js.dom.addEventListener(this.js.window,'resize',this.onWindowResize,this);this.js.dom.addEventListener(this.js.window,'unload',this.onFrameUnload,this);this.doUnload=true;this.init();this.deltas=new ecma.lsn.ext.dde.Deltas(this.dc);this.deltas.addActionListener('complete',this.onCommitComplete,this);this.status.flash('Opened: '+this.docLoc.getHref());this.dispatchAction('open',this);ecma.lsn.hideMask();};proto.onFrameBeforeUnload=function(event){this.doUnload=false;if(this.editor)this.deselect();if(this.deltas&&!this.deltas.isUpToDate()){var msg='Your changes will be lost.';if(event){event.returnValue=msg;}
return msg;}};proto.onFrameUnload=function(event){if(!this.doUnload)return;if(this.editor)this.deselect();if(this.deltas&&!this.deltas.isUpToDate()){var msg='Save changes';if(confirm(msg)){this.exec('docSave');}}};proto.onCommitComplete=function(){try{this.status.notify('Changes have been saved');if(this.reloadAfterCommit){ecma.dom.setAttribute(this.frameId,'src',this.reloadAfterCommit);this.reloadAfterCommit=null;this.js.window.location.reload(true);}else{ecma.lsn.hideMask();new ecma.http.Request(this.saving).submit();}}finally{this.saving=null;}};proto.createMasks=function(){this.masks=[];for(var i=1;i<10;i++){var mask=this.js.dom.createElement('div',{'id':'dde-mask-'+i,'class':'dde-mask'});this.js.dom.setOpacity(mask,.50);this.js.dom.addEventListener(mask,'click',this.deselect,this);this.masks.push(mask);}
return this.masks;};proto.init=function(){var elems=[]
this.makeEditableElements(this.js.dom.getBody(),elems);this.getEditableElements(this.js.dom.getBody(),elems);for(var i=0,elem;elem=elems[i];i++){this.markers.push(this.createMarker(elem));}
this.adjustMarkers();};proto.makeEditableElements=function(pelem,result){var comments=this.js.dom.getElementsByNodeType(pelem,ecma.dom.constants.COMMENT_NODE);var blocks=[];var block=null;var spec=null;for(var i=0,cnode;cnode=comments[i];i++){spec=cnode.data.match(/^ce:ds="([^"]+)"(.*)$/);if(spec){var elem=cnode.parentNode;var attr=this.js.dom.getAttribute(elem,'_lsn_ds')||'';attr+=spec[1];this.js.dom.setAttribute(elem,'_lsn_ds',attr);if(spec[2]){var opts=spec[2].match(/^\s+opts="([^"]+)"/);if(opts)this.js.dom.setAttribute(elem,'_lsn_opts',opts[1]);}
elem.removeChild(cnode);continue;}
spec=cnode.data.match(/^ce:begin="([^"]+)"$/);if(spec){if(block)blocks.push(block);block=new ecma.lsn.ext.dde.BlockInfo();block.setBegin(cnode,spec[1]);continue;}
spec=cnode.data.match(/^ce:item="([^"]+)"$/);if(spec){if(!block)throw'Item outside of block';block.addItem(cnode,spec[1]);continue;}
spec=cnode.data.match(/^ce:end$/);if(spec){block.setEnd(cnode);var cluster=block.firstChild;while(cluster){result.push(cluster);cluster=cluster.nextSibling;}
block=blocks.pop();continue;}}};proto.getEditableElements=function(pelem,result){for(var i=0,node=null,nodes=pelem.childNodes;node=nodes[i];i++){if(!ecma.dom.node.isElement(node))continue;var ds=ecma.dom.getAttribute(node,'_lsn_ds');if(ds)result.push(node);if(node.childNodes.length>0)this.getEditableElements(node,result);}};proto.createMarker=function(target){if(ecma.util.isa(target,ecma.data.Node)){return new ecma.lsn.ext.dde.markers.BlockMarker(this,target);}else{return new ecma.lsn.ext.dde.markers.ContentMarker(this,target);}};proto.adjustMarkers=function(){for(var i=0,m;m=this.markers[i];i++){if(!m.elem)continue;for(var n=m.elem.previousSibling;n;n=n.previousSibling){if(!this.js.dom.node.isElement(n))continue;var f=this.js.dom.getStyle(n,'float');var c=this.js.dom.getStyle(n,'clear');if(c&&c!='none')break;if(this.js.dom.getLeft(m.elem)!=this.js.dom.getLeft(n))break;if(f&&f=='left'){var w=this.js.dom.getWidth(n);m.adjust.x=w;m.refresh();break;}}}};proto.removeMarker=function(marker){var result=null;for(var i=0,m;m=this.markers[i];i++){if(m==marker){result=this.markers.splice(i--,1);marker.remove();break;}}
return result;};proto.removeMarkersFrom=function(elem){var m=this.getMarker(elem);if(m){this.removeMarker(m);}
var n=elem.firstChild;while(n){this.removeMarkersFrom(n);n=n.nextSibling;}};proto.onWindowResize=function(event){this.refreshMarkers();if(this.editor)this.editor.resize();};proto.exec=function(){var args=ecma.util.args(arguments);var cmd=args.shift();if(!this.cmds[cmd])throw'Unknown exec command: '+cmd;this.cmds[cmd].apply(this,args);};proto.cmds={docOpen:function(){if(!this.dlgOpen){this.dlgOpen=new ecma.hubb.ui.BrowseDialog();this.dlgOpen.dlg.addEvent('ok',ecma.lang.Callback(function(){var addr=this.dlgOpen.getTarget().getAddress();this.load(addr);},this));}
this.dlgOpen.show(this.docLoc.pathname);},docSave:function(reload){reload=true;if(this.deltas&&this.deltas.isUpToDate()){this.status.flash('No save needed');return;}
this.saving=this.docLoc.getUri();this.reloadAfterCommit=reload?this.docLoc.getUri():null;ecma.lsn.showMask();ecma.dom.setTimeout(this.deltas.commit,0,this.deltas);},docGoto:function(){ecma.window.open(this.js.window.location.href);},docViewSource:function(){if(this.deltas&&!this.deltas.isUpToDate()){if(confirm("Save changes?\n\nViewing source displays the source of the saved document.")){this.deltas.addActionListener('complete',this.cmds.docViewSource,this);this.exec('docSave');}
return;}
if(!this.dlgViewSource){this.dlgViewSource=new ecma.lsn.Dialog('[#`./dlg-view-source.html`]',{'refetch':false});}
this.dlgViewSource.show({'href':this.docLoc.getHref()});},docMail:function(){if(!this.dlgMail){this.dlgMail=new ecma.lsn.Dialog('[#`./dlg-mail.html`]',{'refetch':false});this.dlgMail.addEvent('mail-sent',ecma.lang.Callback(function(){this.status.notify('Mail sent!');},this));}
this.dlgMail.show({'href':this.docLoc.getHref()});},docRefresh:function(){if(this.editor)this.deselect();if(this.deltas&&!this.deltas.isUpToDate()){var msg='Save changes';if(confirm(msg)){this.exec('docSave');return;}else{this.deltas.clear();}}
try{this.js.document.location.reload(true);}catch(ex1){try{this.js.window.location.reload(true);}catch(ex2){this.status.flash('Could not reload');}}},stopEditing:function(){this.deselect();}};proto.load=function(uri){this.felem.src=uri;};proto.canUnload=function(){if(!this.deltas)return true;return!this.deltas.isUpToDate()?confirm('Discard changes?'):true;};proto.refresh=function(){this.refreshMarkers();this.refreshMasks();};proto.refreshMarkers=function(){for(var i=0;i<this.markers.length;i++){this.markers[i].refresh();}};proto.showMarkers=function(){this.js.dom.setStyle(this.ui.markers,'display','');};proto.hideMarkers=function(){ecma.dom.setStyle(this.ui.markers,'display','none');};proto.getMarker=function(elem){for(var i=0,marker;marker=this.markers[i];i++){if(elem===marker.elem){return marker;}}};proto.showMask=function(marker){this.marker=marker;this.refresh();this.js.dom.setStyle(this.ui.masks,'display','');};proto.hideMask=function(){ecma.dom.setStyle(this.ui.masks,'display','none');if(this.maskType){ecma.dom.removeClassName(this.ui.masks,this.maskType);this.maskType=null;}
this.marker=null;};proto.setMaskType=function(type){this.maskType=type;ecma.dom.addClassName(this.ui.masks,this.maskType);};proto.selectNext=function(){if(!this.marker)return;for(var i=0,marker;marker=this.markers[i];i++){if(marker===this.marker){for(var j=1,next;next=this.markers[i+j];j++){if(next.getType()=='text'){this.deselect();next.onClick();break;}}
break;}}};proto.selectPrevious=function(){if(!this.marker)return;for(var i=0,marker;marker=this.markers[i];i++){if(marker===this.marker){for(var j=1,prev;prev=this.markers[i-j];j++){if(prev.getType()=='text'){this.deselect();prev.onClick();break;}}
break;}}};proto.select=function(marker,cmd){this.editor=marker.getEditor();if(!this.editor)return;ecma.dom.addClassName(this.ui.masks,'shaded');this.editor.begin(cmd);this.marker=marker;this.hideMarkers();};proto.deselect=function(){if(this.editor){this.editor.end();this.editor=null;this.mm.show('main');}
this.marker=null;this.hideMask();ecma.dom.removeClassName(this.ui.masks,'shaded');this.showMarkers();this.js.dom.getBody().focus();this.refresh();};proto.getEditor=function(){return this.editor;};proto.refreshMasks=function(){if(!this.js)return;if(!this.marker)return;var pos=this.marker.getBoundingBox();var pg_h=this.js.dom.canvas.pageY()-this.body_y;var pg_w=this.js.dom.canvas.pageX()-this.body_x;var w1=pos.left+this.body_x;var w2=pos.width;var w3=pg_w-(pos.left+pos.width);var h1=pos.top+this.body_y;var h2=pos.height;var h3=pg_h-(pos.top+pos.height);var l1=0
var l2=l1+w1;var l3=l1+w1+w2;var t1=0
var t2=t1+h1;var t3=t1+h1+h2;this.updmsk(this.masks[0],t1,l1,w1,h1);this.updmsk(this.masks[1],t1,l2,w2,h1);this.updmsk(this.masks[2],t1,l3,w3,h1);this.updmsk(this.masks[3],t2,l1,w1,h2);this.updmsk(this.masks[4],t2,l2,w2,h2);this.updmsk(this.masks[5],t2,l3,w3,h2);this.updmsk(this.masks[6],t3,l1,w1,h3);this.updmsk(this.masks[7],t3,l2,w2,h3);this.updmsk(this.masks[8],t3,l3,w3,h3);};proto.scrollToMarker=function(marker){if(!marker)marker=this.marker;if(!marker)return;var pos=this.marker.getBoundingBox();var vp=this.js.dom.getViewportPosition();if(pos.top<vp.top){var y=Math.max(0,pos.top-(vp.height/3));this.js.window.scroll(vp.left,y);}else if(pos.top>(vp.top+vp.height)){this.js.window.scroll(vp.left,(pos.top-pos.height));}};proto.updmsk=function(elem,t,l,w,h){this.js.dom.setStyle(elem,'top',t+'px');this.js.dom.setStyle(elem,'left',l+'px');this.js.dom.setStyle(elem,'width',w+'px');this.js.dom.setStyle(elem,'height',h+'px');};});