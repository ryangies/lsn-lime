// Livesite (c) Livesite Networks, LLC.

js.extend('lsn.desktop.ext.edit.ace.metadata',function(js){var _modes=this.modes=[{name:'ace/mode/text',source:null,types:['file-text-txt']},{name:'ace/mode/c',source:'mode-c_cpp.js',types:['file-text-c','file-text-cpp','file-text-h']},{name:'ace/mode/coffee',source:'mode-coffee.js',types:[]},{name:'ace/mode/css',source:'mode-css.js',types:['file-text-css']},{name:'ace/mode/doc',source:'mode-doc.js',types:['file-text-md']},{name:'ace/mode/html',source:'mode-html.js',types:['file-text-ht','file-text-htm','file-text-html']},{name:'ace/mode/java',source:'mode-java.js',types:['file-text-java']},{name:'ace/mode/javascript',source:'mode-javascript.js',types:['file-text-js']},{name:'ace/mode/php',source:'mode-php.js',types:['file-text-php']},{name:'ace/mode/python',source:'mode-python.js',types:['file-text-js']},{name:'ace/mode/ruby',source:'mode-ruby.js',types:['file-text-ruby']},{name:'ace/mode/xml',source:'mode-xml.js',types:['file-text-xml']}];this.getModeByType=function(type){for(var i=0,mode;mode=_modes[i];i++){if(js.util.grep(type,mode.types)){return mode;}}
return _modes[0];};var _themes=this.themes=[{alias:'clouds',name:'ace/theme/clouds',source:'theme-clouds.js'},{alias:'clouds_midnight',name:'ace/theme/clouds_midnight',source:'theme-clouds_midnight.js'},{alias:'cobalt',name:'ace/theme/cobalt',source:'theme-cobalt.js'},{alias:'dawn',name:'ace/theme/dawn',source:'theme-dawn.js'},{alias:'eclipse',name:'ace/theme/eclipse',source:'theme-eclipse.js'},{alias:'idle_fingers',name:'ace/theme/idle_fingers',source:'theme-idle_fingers.js'},{alias:'kr_theme',name:'ace/theme/kr_theme',source:'theme-kr_theme.js'},{alias:'mono_industrial',name:'ace/theme/mono_industrial',source:'theme-mono_industrial.js'},{alias:'monokai',name:'ace/theme/monokai',source:'theme-monokai.js'},{alias:'pastel_on_dark',name:'ace/theme/pastel_on_dark',source:'theme-pastel_on_dark.js'},{alias:'twilight',name:'ace/theme/twilight',source:'theme-twilight.js'}];this.getThemeByAlias=function(alias){for(var i=0,theme;theme=_themes[i];i++){if(theme.alias==alias){return theme;}}
return _themes[0];};});js.extend('lsn.desktop.ext.edit.ace',function(js){this.MenuMain=function(eMenuId,editor){this.parentElement=js.dom.getElement(eMenuId);this.editor=editor;this.createUI();};var MenuMain=this.MenuMain.prototype=js.lang.createMethods();MenuMain.createUI=function(){var children=[];this.saveButton=js.dom.createElement('button=Save',{'onClick':[this.onSave,this]});children.push(this.saveButton);this.reloadButton=js.dom.createElement('button=Reload',{'onClick':[this.onReload,this]});children.push(this.reloadButton);this.ddeButton=js.dom.createElement('button=Edit as Live HTML',{'onClick':[this.onDDE,this]});children.push('#text= ');children.push(this.ddeButton);this.rootElement=js.dom.createElement('div',children);this.parentElement.appendChild(this.rootElement);};MenuMain.onSave=function(event){this.editor.saveContent();};MenuMain.onReload=function(event){this.editor.reload();};MenuMain.onDDE=function(event){var addr=this.editor.dnode.getAddress();var uri='/desktop/ext/dde/index.html?doc='+addr;try{var props={'id':js.util.randomId('editor'),'src':uri,'icon':'/res/icons/16x16/apps/accessories-text-editor.png','name':'Editor','side':'right','canClose':true};js.window.top.js.lsn.desktop.createTab(props);}catch(ex){js.console.log(ex);js.window.open(uri);}};});js.extend('lsn.desktop.ext.edit.ace',function(js){this.MenuOptions=function(eMenuId,editor){this.parentElement=js.dom.getElement(eMenuId);this.editor=editor;this.createUI();};var MenuOptions=this.MenuOptions.prototype=js.lang.createMethods();MenuOptions.createUI=function(){this.options=[];var themes=js.lsn.desktop.ext.edit.ace.metadata.themes;for(var i=0,theme;theme=themes[i];i++){this.options.push(js.dom.createElement('option',{'value':theme.alias,'innerHTML':theme.alias}));}
this.themeList=js.dom.createElement('select',{'onChange':[this.onSelectTheme,this]},this.options);this.rootElement=js.dom.createElement('div',{},[this.themeList]);this.parentElement.appendChild(this.rootElement);};MenuOptions.onSelectTheme=function(event){var themeName=js.dom.getValue(this.themeList);this.editor.setTheme(themeName);};});js.extend('lsn.desktop.ext.edit.ace',function(js){this.StatusBar=function(eStatusBarId){this.parentElement=js.dom.getElement(eStatusBarId);this.popups=[];this.timeout=3000;};var StatusBar=this.StatusBar.prototype=js.lang.createMethods();StatusBar.createPopup=function(cssClass,childNodes){var vp=js.dom.getViewportPosition();var pad=12;var width=(vp.width/4)+(2*pad);var left=(vp.width/2)-(width/2);var popup=js.dom.createElement('div',{'style':{'position':'absolute','top':(vp.height/5)+'px','width':width+'px','left':left+'px','padding':pad+'px'}},childNodes);js.dom.addClassName(popup,'statusPopup');js.dom.addClassName(popup,cssClass);this.popups.push(popup);js.dom.getBody().appendChild(popup);return popup;};StatusBar.notify=function(text){var contents=js.dom.createElements('span',{'innerHTML':text,'style':{'font-size':'12px'}});this.createPopup('statusNotify',contents);js.dom.setTimeout(this.removePopup,this.timeout,this);};StatusBar.alert=function(text){var contents=js.dom.createElements('span',{'innerHTML':text,'style':{'font-size':'12px'}},'div.footerButtons',['button=OK',{'onClick':[this.removePopup,this]}]);this.createPopup('statusAlert',contents);};StatusBar.removePopup=function(event){js.dom.stopEvent(event);var elem=this.popups.shift();if(elem)js.dom.removeElement(elem);};});js.extend('lsn.desktop.ext.edit.ace',function(js){var _aceRootUri='[#`./js`]/ace/';var CAction=js.action.ActionDispatcher;this.Editor=function(eAreaId){CAction.apply(this);this.eArea=js.dom.getElement(eAreaId);this.dnode=null;this.ace=ace.edit(this.eArea);this.setTheme('clouds');this.db=js.hubb.getInstance();};var Editor=this.Editor.prototype=js.lang.createMethods(CAction);Editor.edit=function(dnode){this.dnode=dnode;this.baseContent=null;this.conflict=false;this.loadContent();js.dom.setStyle(this.eArea,'visibility','hidden');js.dom.setTimeout(this.onReady,250,this);};Editor.clear=function(){try{this.dnode.removeActionListener('update',this.onNodeUpdated,this);}finally{this.dnode=null;}};Editor.onReady=function(){if(this.dnode){this.ace.gotoLine(1);this.setMode(this.dnode.getType());this.dnode.addActionListener('update',this.onNodeUpdated,this);}
js.dom.setStyle(this.eArea,'visibility','visible');};Editor.onNodeUpdated=function(action,dnode){if(!this.hasChanged()){this.loadContent();}else{this.conflict=true;this.dispatchAction('conflict',dnode);}};Editor.loadContent=function(){if(this.dnode){var content=this.dnode.getContent();this.ace.getSession().setValue(content);if(!this.conflict)this.baseContent=content;}};Editor.reload=function(){this.dnode.fetch();};Editor.saveContent=function(){if(this.dnode){if(this.conflict&&!confirm('Are you sure you want to overwrite this modified file?')){return;}
var value=this.getContent();this.conflict=false;this.baseContent=value;this.db.store(this.dnode.getAddress(),value,[this.onStore,this]);}};Editor.hasChanged=function(){var content=this.getContent();return this.baseContent!=content;};Editor.getContent=function(){return this.ace.getSession().getValue();};Editor.onStore=function(dnode){this.dispatchAction(dnode?'saved':'notsaved',dnode);};Editor.setTheme=function(name){this.theme=js.lsn.desktop.ext.edit.ace.metadata.getThemeByAlias(name);if(this.theme.source){js.dom.include.script({src:_aceRootUri+this.theme.source,id:this.theme.name},[this.onThemeLoad,this]);}else{this.onThemeLoad();}};Editor.onThemeLoad=function(){this.ace.setTheme(this.theme.name);};Editor.setMode=function(type){this.mode=js.lsn.desktop.ext.edit.ace.metadata.getModeByType(type);if(this.mode.source){js.dom.include.script({src:_aceRootUri+this.mode.source,id:this.mode.name},[this.onModeLoad,this]);}else{this.onModeLoad();}};Editor.onModeLoad=function(){var modeClass=require(this.mode.name).Mode;this.ace.getSession().setMode(new modeClass());};});