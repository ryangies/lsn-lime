// Livesite (c) Livesite Networks, LLC.

js.extend('ext.share',function(js){var _package=this;_package.SharedArray=function(){this.a=[];};var _proto=_package.SharedArray.prototype=js.lang.createMethods();_proto.getArray=function(){return this.a;};_proto.pop=function(){var result=Array.pop.apply(this.a,arguments);this.executeAction('pop',result);return result;};_proto.push=function(){var result=Array.push.apply(this.a,arguments);this.executeAction('push',result);return result;};_proto.reverse=function(){var result=Array.reverse.apply(this.a,arguments);this.executeAction('reverse',result);return result;};_proto.shift=function(){var result=Array.shift.apply(this.a,arguments);this.executeAction('shift',result);return result;};_proto.sort=function(){var result=Array.sort.apply(this.a,arguments);this.executeAction('sort',result);return result;};_proto.splice=function(){var result=Array.splice.apply(this.a,arguments);this.executeAction('splice',result);return result;};_proto.unshift=function(){var result=Array.unshift.apply(this.a,arguments);this.executeAction('unshift',result);return result;};_proto.concat=function(){var result=Array.concat.apply(this.a,arguments);this.executeAction('concat',result);return result;};_proto.join=function(){var result=Array.join.apply(this.a,arguments);this.executeAction('join',result);return result;};_proto.slice=function(){var result=Array.slice.apply(this.a,arguments);this.executeAction('slice',result);return result;};_proto.toString=function(){var result=Array.toString.apply(this.a,arguments);this.executeAction('toString',result);return result;};});js.extend('ext.share',function(js){var _package=this;var _base=js.data.Node;var _super=_base.prototype;var _proto=js.lang.createMethods(_base);_package.SortedNode=function(){_base.apply(this,arguments);};_package.SortedNode.prototype=_proto;_proto.sortCompare=function(a,b){if(a&&b){var av=a.data.sortValue||0;var bv=b.data.sortValue||0;var rv=av-bv;return rv==0?a.index=b.index:rv;}else{return a?-1:b?1:0;}};});js.extend('ext.share',function(js){var _package=this;_package.ObjectFactory=function(){this.objectMap={};this.defaultObject=null;};var _proto=_package.ObjectFactory.prototype=js.lang.createMethods();_proto.get=function(key){return this.objectMap[key]||this.defaultObject;};_proto.set=function(key,ctor,bDefault){if(bDefault)this.setDefault(ctor);return this.objectMap[key]=ctor;};_proto.setDefault=function(ctor){return this.defaultObject=ctor;};_proto.createObject=function(){var args=js.util.args(arguments);var key=args.shift();var ctor=this.get(key);return js.lang.createObject(ctor,args);};});js.extend('ext.share',function(js){this.ObjectCache=function(){this.seeds={};this.instances={};};var _proto=this.ObjectCache.prototype=js.lang.createMethods();_proto.register=function(name,ctor,cb){if(name in this.instances)delete this.instances[name];this.seeds[name]=[ctor,cb];};_proto.get=function(name){var obj=this.instances[name];if(!obj){var seed=this.seeds[name];if(!seed)throw new TypeError('Named object does not exist: '+name);obj=this.instances[name]=new seed[0]();if(seed[1]){js.lang.callback(seed[1],obj)}}
return obj;}});js.extend('ext.share',function(js){var CActionDispatcher=js.action.ActionDispatcher;this.Selection=function(){CActionDispatcher.apply(this);this.cwd=null;this.selection=[];};var _proto=this.Selection.prototype=js.lang.createMethods(CActionDispatcher);_proto.setCwd=function(target){if(this.cwd!==target){this.clearSelection();if(this.cwd){target.dispatchAction('onDeselectCwd',this.cwd);}
this.cwd=target;target.dispatchAction('onSelectCwd',this.cwd);this.dispatchAction('onChangeDirectory',this.cwd);}};_proto.getSelection=function(){return this.selection;};_proto.getSelected=function(){return this.selection[0];};_proto.getCwd=function(){return this.cwd;};_proto.select=function(target){this.clearSelection();this.multiSelect(target);};_proto.multiSelect=function(target){this.selection.push(target);target.dispatchAction('onSelect');this.dispatchAction('onSelect',target);};_proto.deselect=function(target){for(var i in this.selection){if(this.selection[i]===target){this.selection.splice(i,1);target.dispatchAction('onDeselect',target);this.dispatchAction('onDeselect',target);}}};_proto.clearSelection=function(){while(this.selection.length>0){var target=this.selection.pop();target.dispatchAction('onDeselect',target);this.dispatchAction('onDeselect',target);}};});js.extend('ext.share',function(js){this.Initiator=function(props){js.util.overlay(this,props);};var _proto=this.Initiator.prototype=js.lang.createMethods();_proto.match=function(node){var file=node.getDataNode();var matchTypes=this.matchTypes;var ok=matchTypes?false:true;if(matchTypes){var type=file.getType();for(var i=0;!ok&&i<matchTypes.length;i++){ok=type.match(matchTypes[i]);}}
return ok?true:false;};});js.extend('ext.share.data',function(js){this.loadHandlers=function(env){env.registerHandler('data-reorder-previous',function(action,targetNode){var previousNode;var node=targetNode.previousSibling;while(node&&!previousNode){if(node.canDisplay())previousNode=node;node=node.previousSibling;}
if(!previousNode)return;var parentNode=targetNode.parentNode;var indexes=[];var child=parentNode.firstChild;while(child){if(child===previousNode){indexes.push(targetNode.getDataNode().getKey());indexes.push(previousNode.getDataNode().getKey());child=targetNode.nextSibling;}else{indexes.push(child.getDataNode().getKey());child=child.nextSibling;}}
var db=parentNode.getDataNode().getDataBridge();var addr=parentNode.getDataNode().getAddress();env.showLoading();db.reorder(addr,indexes,function(){env.hideLoading();});});env.registerHandler('data-reorder-next',function(action,targetNode){var nextNode;var node=targetNode.nextSibling;while(node&&!nextNode){if(node.canDisplay())nextNode=node;node=node.nextSibling;}
if(!nextNode)return;var parentNode=targetNode.parentNode;var indexes=[];var child=parentNode.firstChild;while(child){if(child===targetNode){indexes.push(nextNode.getDataNode().getKey());indexes.push(targetNode.getDataNode().getKey());child=nextNode.nextSibling;}else{indexes.push(child.getDataNode().getKey());child=child.nextSibling;}}
var db=parentNode.getDataNode().getDataBridge();var addr=parentNode.getDataNode().getAddress();env.showLoading();db.reorder(addr,indexes,function(){env.hideLoading();});});};});js.extend('ext.share.data.model',function(js){var _package=this;_package.Schema=function(dnode,id){if(id){this.id=id;this.canPersist=true;}else{this.id=js.util.rand8();this.canPersist=false;}
this.dnode=null;this.form=null;this.childManifest=null;if(dnode)this.load(dnode);};var _proto=_package.Schema.prototype=js.lang.createMethods();_proto.getId=function(){return this.id;};_proto.getName=function(){try{return this.getDataNode().isFile()?null:this.getDataNode().getKey()}catch(ex){return undefined;}};_proto.getLabel=function(){try{return this.getDataNode().getString('label')||this.getName();}catch(ex){return null;}};_proto.getChildManifest=function(){try{if(this.childManifest)return this.childManifest;var manifest=this.getDataValue('children').toObject();if(manifest.schema){manifest.schema=this.getSchema(manifest.schema);}
if(manifest.schemas){var schemas=[];for(var i=0;i<manifest.schemas.length;i++){schemas.push(this.getSchema(manifest.schemas[i]));}
manifest.schemas=schemas;}else{manifest.schemas=[manifest.schema];}
this.childManifest=manifest;}catch(ex){return null;}
return this.childManifest;};_proto.toObject=function(){var obj=js.util.isFunction(this.dnode.toObject)?this.dnode.toObject():this.dnode;if(js.util.isString(obj.schema)){obj.schema=this.getSchema(obj.schema);}
return obj;};_proto.getSchema=function(name){if(!js.util.isDefined(name))return this;var spec=name;if(js.util.isString(name)&&js.util.isa(this.dnode,js.hubb.Node)){spec=this.dnode.getStorage().getValue(name);}
return env.schemas.fetch(spec);};_proto.getDataNode=function(){return this.dnode;};_proto.getForm=function(){return this.form;};_proto.load=function(dnode){this.dnode=dnode;this.data=(js.util.isa(dnode,js.hubb.Node)||js.util.isa(dnode,js.data.HashList))?dnode:js.data.fromObject(dnode);this.form=new js.ext.share.input.Form();this.form.loadSchema(this.dnode);this.setup();};_proto.getDataValue=function(key){return this.data?this.data.get(key):undefined;};_proto.clone=function(){return new _package.Schema(this.dnode);};_proto.setup=function(){this.summaryFields=[];this.summaryEditableFields=[];var firstVisibleField=null;var fields=this.form.getFields();for(var i=0,field;field=fields[i];i++){if(field.isHidden())continue;if(!firstVisibleField)firstVisibleField=field;if(field.data.is_name_field)this.nameField=field;var summary=field.data.summary;if(!summary)continue;switch(summary){case'display':break;case'edit':this.summaryEditableFields.push(field);break;default:js.console.log('Unexpected value for property `summary`:',summary);}
this.summaryFields.push(field);}
if(!this.summaryFields.length){if(firstVisibleField){this.summaryFields.push(firstVisibleField);}}
if(!this.nameField)this.nameField=this.summaryFields[0];};_proto.getSummaryFields=function(){return this.summaryFields;};_proto.getDefaultValues=function(){return this.form.getDefaultValues();};_proto.getIconPath=function(){try{return this.getDataValue('icon').toString();}catch(ex){return this.getChildManifest()?'/res/icons/16x16/categories/book-marks.png':'/res/icons/16x16/emblems/directory-object.png';}};});js.extend('ext.share.data.model',function(js){var _package=this;var CSchema=_package.Schema;_package.SchemaLoader=function(){this.schemas={};};var _proto=_package.SchemaLoader.prototype=js.lang.createMethods();_proto.load=function(data){data.iterate([this.vivifySchema,this]);};_proto.fetch=function(arg,cb){var schema=null;if(!js.util.isDefined(arg)){return;}else if(js.util.isa(arg,CSchema)){schema=arg;}else if(js.util.isa(arg,js.hubb.Node)){var id=arg.getValue('id')||arg.getAddress();schema=this.vivifySchema(id,arg);}else if(js.util.isAssociative(arg)){schema=new CSchema(arg);this.schemas[schema.getId()]=schema;}else if(js.util.isString(arg)){schema=this.schemas[arg];if(!schema){env.hub.get(arg,[this.fetch,this,[cb]])
return;}}
if(cb)js.lang.callback(cb,null,[schema]);return schema;};_proto.vivifySchema=function(id,data){if(!id)throw new Error('Missing schema id');var schema=this.schemas[id];if(!schema){this.schemas[id]=schema=new CSchema(data,id);}
return schema;};});js.extend('ext.share.data.model',function(js){var _package=this;_package.DataListener=function(){this.dataListeners=this.als||[];this.addActionListener('onAdopted',this.attachDataListener,this);this.addActionListener('onOrphaned',this.detachDataListener,this);};var _proto=_package.DataListener.prototype=js.lang.createMethods();_proto.detachDataListener=function(){for(var i=0,al;al=this.dataListeners[i];i++){al.remove();}
this.dataListeners=[];};_proto.attachDataListener=function(){this.dataListeners.push(this.data.addActionListener('create',this.onDataAction,this),this.data.addActionListener('update',this.onDataAction,this),this.data.addActionListener('remove',this.onDataAction,this));};_proto.onDataAction=function(action,dnode){switch(action.name){case'create':try{this.insertChild(dnode);}catch(ex){js.error.reportError(ex);}
break;case'update':if(action.updated.order){this.sort();}
this.dispatchAction(action,dnode);break;case'remove':if(dnode===this.getDataNode()){this.deselect();this.parentNode.removeChild(this);}
break;}};});js.extend('ext.share.data.model',function(js){var _package=this;_package.Selectable=function(selection){};var _proto=_package.Selectable.prototype=js.lang.createMethods();_proto.select=function(){this.rootNode.select(this);};_proto.isSelected=function(){var me=this;function matchFunction(unk){return unk===me;}
return js.util.grep(matchFunction,this.rootNode.getSelection());};_proto.multiSelect=function(){this.rootNode.multiSelect(this);};_proto.deselect=function(){this.rootNode.deselect(this);};});js.extend('ext.share.data.model',function(js){var _package=this;var CNodeBase=js.data.Node;var CSelectable=js.ext.share.data.model.Selectable;var CDataListener=js.ext.share.data.model.DataListener;_package.Node=function(data){CNodeBase.apply(this,arguments);CSelectable.apply(this);CDataListener.apply(this);this.populate();};var _proto=_package.Node.prototype=js.lang.createPrototype(CNodeBase,CSelectable,CDataListener);_proto.populate=function(){if(this.data&&js.util.isFunction(this.data.values)){var items=this.data.values();for(var i=0,item;item=items[i];i++){this.insertChild(item);}}};_proto.createNode=function(data){return new _package.Node(data);};_proto.sortCompare=function(a,b){if(!(js.util.defined(a)&&js.util.defined(b)))return;var av=a.data.getIndex();var bv=b.data.getIndex();var rv=av-bv;return rv;};_proto.canDisplay=function(){return true;};_proto.getName=function(){return this.data.getKey();};_proto.getType=function(){return this.data.getType();};});js.extend('ext.share.data.model',function(js){var CNodeBase=js.ext.share.data.model.Node;var CSelection=js.ext.share.Selection;this.RootNode=function(data){CNodeBase.call(this,data);CSelection.call(this);};var _proto=this.RootNode.prototype=js.lang.createMethods(CNodeBase,CSelection);_proto.load=function(ds){env.hub.get(ds,[this.onLoad,this]);};_proto.onLoad=function(dnode){this.data=dnode;this.populate();};});js.extend('ext.share.data.model',function(js){var CNodeBase=js.ext.share.data.model.Node;var CNode=this.CollectionItem=function(dnode){CNodeBase.apply(this,arguments);this.super=CNodeBase.prototype;this.schema=null;};var _proto=this.CollectionItem.prototype=js.lang.createMethods(CNodeBase);_proto.onAdopted=function(){var schema=this.getSchema();this.nameFieldName=schema.nameField.getName();};_proto.createNode=function(data){};_proto.getSchema=function(){if(!this.schema){var name=this.getDataNode().getString('schema');this.schema=this.rootNode.getSchema(name);}
return this.schema;};_proto.getName=function(){return this.nameFieldName?this.data.get(this.nameFieldName):this.data.getKey();};});js.extend('ext.share.data.model',function(js){var CNodeBase=js.ext.share.data.model.Node;var CSelection=js.ext.share.Selection;this.Collection=function(storage,schema){CSelection.call(this);CNodeBase.call(this);this.schema=schema;this.definition=schema.definition;this.load(storage);};var _proto=this.Collection.prototype=js.lang.createMethods(CSelection,CNodeBase);_proto.CNode=js.ext.share.data.model.CollectionItem;_proto.setDataNode=function(dnode){this.unload();this.data=dnode;this.attachDataListener();};_proto.getDataNode=function(){return this.data;};_proto.getSchema=function(name){return name&&this.definition?this.schema.definition.getSchema(name):this.schema;};_proto.createNode=function(dnode){var node=new this.CNode(dnode);node.addActionListener('onclick',function(action,node){this.dispatchAction('onItemClick',node);},this);return node;};_proto.load=function(dnode){this.setDataNode(dnode);var manifest=this.schema.getChildManifest();var items=manifest?this.data.get(manifest.name).values():this.data.values();for(var i=0,item;item=items[i];i++){item.load([this.insertChild,this]);}};_proto.unload=function(){this.detachDataListener();this.removeAllChildren();this.data=null;};_proto.canDisplay=function(){return false;};});js.extend('ext.share.ui',function(js){var _package=this;_package.View=function(){this.elements=this.createElements();};var _proto=_package.View.prototype=js.lang.createMethods();_proto.getElements=function(){return this.elements;};_proto.createElements=function(){return[];};_proto.removeElements=function(){js.dom.removeElements(this.getElements());};_proto.unload=function(){this.removeElements();};});js.extend('ext.share.data.view',function(js){var _package=this;CBaseView=js.ext.share.ui.View;CNodeLayer=js.data.NodeLayer;_package.ListViewItem=function(mnode,layerName,view){CNodeLayer.apply(this,arguments);CBaseView.apply(this);this.view=view;};_proto=_package.ListViewItem.prototype=js.lang.createPrototype(CBaseView,CNodeLayer);_proto.createElements=function(){this.dnode=this.node.getDataNode();return[js.dom.createElement('P='+this.dnode.toString())];};_proto.onAdopted=function(){CNodeLayer.prototype.onAdopted.apply(this,arguments);this.node.addActionListener('onSelect',this.onModelSelect,this);this.node.addActionListener('onDeselect',this.onModelDeselect,this);this.insertElements();};_proto.onOrphaned=function(){CNodeLayer.prototype.onOrphaned.apply(this,arguments);this.node.removeActionListener('onSelect',this.onModelSelect,this);this.node.removeActionListener('onDeselect',this.onModelDeselect,this);this.removeElements();};_proto.onReordered=function(){CNodeLayer.prototype.onReordered.apply(this,arguments);this.insertElements();};_proto.insertElements=function(){if(this.nextSibling){var nextElements=this.nextSibling.getElements();var nextElement=nextElements[0];js.dom.insertChildrenBefore(nextElement,this.getElements());}else if(this.previousSibling){var previousElements=this.previousSibling.getElements();var previousElement=previousElements[previousElements.length-1];js.dom.insertChildrenAfter(previousElement,this.getElements());}else{js.dom.appendChildren(this.view.getAppendage(),this.getElements());}};_proto.onModelSelect=function(action,node){js.dom.addClassName(this.getElements(),'selected');};_proto.onModelDeselect=function(action,node){js.dom.removeClassName(this.getElements(),'selected');};});js.extend('ext.share.data.view',function(js){var _package=this;CBaseView=js.ext.share.ui.View;CListViewItem=js.ext.share.data.view.ListViewItem;_package.ListView=function(itemClass){CBaseView.apply(this);this.itemClass=null;this.layerName=null;};_proto=_package.ListView.prototype=js.lang.createPrototype(CBaseView);_proto.setItemClass=function(itemClass){return this.itemClass=itemClass;};_proto.getItemClass=function(){return this.itemClass||CListViewItem;};_proto.setLayerName=function(layerName){if(this.layerName){js.dom.removeClassName(this.getElements(),this.layerName);}
this.layerName=layerName;layerName=this.getLayerName();js.dom.addClassName(this.getElements(),layerName);return layerName;};_proto.getLayerName=function(){return this.layerName?this.layerName:this.setLayerName('layer-'+js.util.rand4());};_proto.load=function(data){this.model=new js.ext.share.data.model.RootNode(data);this.model.attachDataListener();this.model.addLayer(this.getLayerName(),this);return this.model;};_proto.getModel=function(){return this.model;};_proto.createLayer=function(mnode,layerName){var layerClass=mnode===this.model?js.data.NodeLayer:this.getItemClass()
return new layerClass(mnode,layerName,this);};_proto.createElements=function(){return[js.dom.createElement('DIV.list-view')];};_proto.getAppendage=function(){return this.getElements()[0];};_proto.unload=function(){CBaseView.prototype.unload.apply(this);this.model.removeLayer(this.getLayerName());};});js.extend('ext.share.input',function(js){var _package=this;var CObjectFactory=js.ext.share.ObjectFactory;_package.Factory=function(){CObjectFactory.apply(this,arguments);};var _proto=_package.Factory.prototype=js.lang.createMethods(CObjectFactory);_proto.createObject=function(){var args=js.util.args(arguments);var key=args.shift();args[0]=js.util.overlay({'type':key},args[0]);var ctor=this.get(key);if(!ctor)throw new Error('Missing input class for: '+key);return js.lang.createObject(ctor,args);};_package.factory=new _package.Factory();});js.extend('ext.share.input.fields',function(js){var _package=this;_package.factory=new js.ext.share.ObjectFactory();});js.extend('ext.share.input',function(js){var _package=this;var CNode=js.data.Node;_package.FormNode=function(data){CNode.call(this,data);};var _proto=_package.FormNode.prototype=js.lang.createMethods(CNode);_proto.createNode=function(data){return js.ext.share.input.fields.factory.createObject(data.type,data,this);};_proto.onAdopt=function(node){};_proto.getElements=function(){return[];};_proto.getName=function(){try{return this.data.name;}catch(ex){return this.id;}};});js.extend('ext.share.input.fields',function(js){var _package=this;var CNode=js.ext.share.input.FormNode;_package.FormField=function(data){CNode.apply(this,[data]);this.isModified=null;this.alStorageChange=null;this.alUserChange=null;this.alCreate=null;this.input=this.createInput();this.input.addActionListener('onChange',this.onInputChange,this);if(this.data.value){this.input.deserialize(this.data.value);}
this.uiDisplay=js.dom.createElement('SPAN');this.displayElements=[this.uiDisplay];};var _proto=_package.FormField.prototype=js.lang.createMethods(CNode);js.ext.share.input.fields.factory.set('field',_package.FormField,true);_proto.getElements=function(){return this.input.getElements();};_proto.getDisplayElements=function(){this.updateDisplayValue();return this.displayElements;};_proto.updateDisplayValue=function(){var valueText=this.getValueText();var encodedValue=js.data.entities.encode(valueText,true);js.dom.setValue(this.uiDisplay,encodedValue);this.input.enable();};_proto.getValueText=function(){return this.input.getValueText();};_proto.getLabelText=function(){return js.util.firstDefined(this.data.label,this.data.name);};_proto.getDescriptionText=function(){return js.util.firstDefined(this.data.description,'');};_proto.getMenuElements=function(){return[];};_proto.hasChanged=function(){return this.isModified;};_proto.createInput=function(){return this.input||js.ext.share.input.factory.createObject(this.data.type,this.data.input);};_proto.isHidden=function(){return this.input.isHidden();};_proto.focus=function(){return this.input.focus();};_proto.select=function(){return this.input.select();};_proto.reset=function(){return this.input.reset();};_proto.tieValue=function(parentValue,key,bAutoCommit){var storedValue=parentValue.getValue(key);if(storedValue){if(this.alStorageChange)this.alStorageChange.remove();this.alStorageChange=storedValue.addActionListener('onChange',this.onStorageChange,this);this.onStorageChange(null,storedValue);}
if(bAutoCommit){if(storedValue){if(this.alUserChange)this.alUserChange.remove();this.alUserChange=this.input.addActionListener('onChange',this.onUserChange,this);}else{this.alCreate=this.input.addActionListener('onChange',this.onUserCreate,this,[parentValue,key]);}}};_proto.untieValue=function(){if(this.alStorageChange){this.alStorageChange.remove();this.alStorageChange=null;}
if(this.alUserChange){this.alUserChange.remove();this.alUserChange=null;}
if(this.alCreate){this.alCreate.remove();this.alCreate=null;}
this.dnode=null;this.deserialize('');};_proto.onStorageChange=function(action,dnode){if(!dnode){this.deserialize('');}else{this.dnode=dnode;this.deserialize(this.dnode.toString());}};_proto.onUserCreate=function(action,input,parentValue,key){var value=this.serialize();var db=parentValue.getDataBridge();var addr=parentValue.getAddress()+'/'+key;db.store(addr,value,[this.onCreateValue,this]);this.input.disable();};_proto.onCreateValue=function(dnode){if(dnode){if(this.alCreate){this.alCreate.remove();this.alCreate=null;}
var key=dnode.getKey();var parentValue=dnode.getParentNode();this.tieValue(parentValue,key,true);this.input.enable();}};_proto.onUserChange=function(action,input){js.lang.assert(this.dnode);var value=this.serialize();var db=this.dnode.getDataBridge();var addr=this.dnode.getAddress();if(this.alStorageChange){this.alStorageChange.remove();this.alStorageChange=null;}
db.store(addr,value,[this.onCommitValue,this]);this.input.disable();};_proto.onInputChange=function(action,input){this.isModified=true;};_proto.onCommitValue=function(dnode){if(!dnode)return;if(dnode!==this.dnode)return;this.isModified=false;this.updateDisplayValue();this.input.enable();this.alStorageChange=dnode.addActionListener('onChange',this.onStorageChange,this);};_proto.deserialize=function(storedValue){var result=this.input.deserialize(storedValue);this.isModified=false;this.updateDisplayValue();return result;};_proto.serialize=function(){return this.input.serialize();};});js.extend('ext.share.input.fields',function(js){var _package=this;var CFormField=js.ext.share.input.fields.FormField;_package.ArrayField=function(data){this.uiRoot=js.dom.createElement('DIV');this.uiMenu=js.dom.createElement('DIV');CFormField.apply(this,[data]);};var _proto=_package.ArrayField.prototype=js.lang.createMethods(CFormField);js.ext.share.input.fields.factory.set('array',_package.ArrayField);_proto.onAdopted=function(){if(!this.childNodes){this.appendChildren(this.data.fields);}};_proto.getElements=function(){return[this.uiRoot];};_proto.isHidden=function(){return false;};_proto.focus=function(){};_proto.select=function(){};_proto.getMenuElements=function(){return[this.uiMenu];};_proto.tieValue=function(dnode,key,bAutoCommit){try{var storedValue=dnode.getValue(key);if(!storedValue){throw'Missing storage';}
var id=dnode.getAddress();var schema=env.schemas.fetch(this.data.schema);if(!schema)throw'Missing schema';this.editor=new js.ext.collections.Editor(id);this.editor.loadDataAndSchema(storedValue,schema);var selection=new js.ext.share.Selection();this.collMenu=new js.ext.share.ui.menu.PanelMenu(env,selection);this.collMenu.load({"items":[{"type":"category","items":[{"type":"item","target":"selection","text":"New Item","tooltip":"Create a new item in this collection","action":"ext-collections-new-item","icon":"/res/icons/16x16/nodes/data-hash.png"}]}]});js.dom.replaceChildren(this.uiRoot,this.editor.getElements());js.dom.replaceChildren(this.uiMenu,this.collMenu.getElements());js.dom.appendChildren(this.uiMenu,this.editor.getMenu().getElements());selection.select(this.editor);return this.input.setValue(storedValue);}catch(ex){js.dom.replaceChildren(this.uiRoot,js.dom.createElements('P.error='+ex.toString()));}};});js.extend('ext.share.input',function(js){var _package=this;var CNode=js.ext.share.input.FormNode;_package.Form=function(){CNode.apply(this,arguments);};var _proto=_package.Form.prototype=js.lang.createMethods(CNode);_proto.fetchSchema=function(addr){env.showLoading();env.hub.fetch(addr,[function(dnode){env.hideLoading();if(!dnode){env.status.alert('Could not load schema');return;}
this.loadSchema(dnode);},this]);};_proto.loadSchema=function(schema){this.removeAllChildren();schema=js.util.isFunction(schema.toObject)?schema.toObject():schema;this.appendChildren(schema.fields);};_proto.getFields=function(){var fields=[];this.iterate(function(child){fields=fields.concat(child);});return fields;};_proto.getNamedFields=function(){var result={};var fields=this.getFields();for(var i=0,field;field=fields[i];i++){result[field.getName()]=field;}
return result;};_proto.getVisibleFields=function(){var fields=[];this.iterate(function(child){if(!child.isHidden()){fields=fields.concat(child);}});return fields;};_proto.getField=function(name){if(!name)return;var result;this.iterate(function(child){if(child.getName()==name){result=child;return this.BREAK;}},this);return result;};_proto.getInputs=function(){var result={};var fields=this.getFields();for(var i=0,field;field=fields[i];i++){result[field.getName()]=field.input;}
return result;};_proto.getInput=function(name){var field=this.getField(name);if(field){return field.input;}};_proto.getElements=function(){var elements=[];this.iterate(function(child){elements=elements.concat(child.getElements());},this);return elements;};_proto.getValues=function(){var result={};var fields=this.getFields();for(var i=0,field;field=fields[i];i++){result[field.getName()]=field.input.getValue();}
return result;};_proto.setValues=function(values){var inputs=this.getInputs();for(key in values){var input=inputs[key];if(input)input.setValue(values[key]);}};_proto.focus=function(name){var field=name?this.getField('name'):this.getVisibleFields()[0];if(field)field.focus();};_proto.select=function(name){var field=name?this.getField('name'):this.getVisibleFields()[0];if(field)field.select();};_proto.attachUI=function(appendTo){var fields=this.getFields();var rows=[];for(var i=0,field;field=fields[i];i++){if(field.data.type=='hidden')continue;rows=rows.concat(js.dom.createElements(field.data.label?'DT.form-field='+field.data.label:null,'DD.form-field',[field.data.description?'P.description='+field.data.description:null,'DIV.input',field.input.getElements()]));}
js.dom.appendChildren(appendTo,js.dom.createElements('DL.form',rows));};_proto.disable=function(){};_proto.enable=function(){};_proto.reset=function(){var fields=this.getFields();for(var i=0,field;field=fields[i];i++){field.reset();}};_proto.deserializeValues=function(values){var fields=this.getNamedFields();for(var key in values){var field=fields[key];if(field)field.deserialize(values[key]);}};_proto.serializeValues=function(){var result={};var fields=this.getFields();for(var i=0,field;field=fields[i];i++){result[field.getName()]=field.serialize();}
return result;};_proto.getDefaultValues=function(){var result={};var fields=this.getFields();for(var i=0,field;field=fields[i];i++){var value=field.data.default;if(!js.util.isDefined(value))value=field.serialize();result[field.getName()]=value;}
return result;};_proto.tieValues=function(dnode,bAutoCommit){var fields=this.getFields();for(var i=0,field;field=fields[i];i++){try{var key=field.getName();field.tieValue(dnode,key,bAutoCommit);}catch(ex){js.error.reportError(ex);js.console.log('Failed to create field:',key);}}};_proto.untieValues=function(){var fields=this.getFields();for(var i=0,field;field=fields[i];i++){field.untieValue();}};_proto.hasChanged=function(){var fields=this.getFields();for(var i=0,field;field=fields[i];i++){if(field.hasChanged())return true;}
return false;};});js.extend('ext.share.input',function(js){var _package=this;var CAction=js.action.ActionDispatcher;var CParameters=js.impl.Parameters;_package.InputBase=function(params){CParameters.call(this,params);CAction.call(this);this.elem=null;this.elements=null;this.value=this.emptyValue=null;this.els=[];};var _proto=_package.InputBase.prototype=js.lang.createMethods(CParameters,CAction);_proto.attach=function(elem){this.elem=elem;var el=new js.dom.EventListener(this.elem,'change',function(event){this.sync();this.executeClassAction('onChange',this);},this);this.els.push(el);return elem;};_proto.getElements=function(){if(!this.elements){this.elements=this.createElements();this.write();}
return this.elements;};_proto.createElements=function(){var cssClass=this.getParameter('type')||'text';var elem=js.dom.createElement('INPUT.'+cssClass,{'type':'text'});return[this.attach(elem)];};_proto.focus=function(){try{this.elem.focus();}catch(ex){}};_proto.select=function(){try{this.elem.select();}catch(ex){}};_proto.enable=function(){js.dom.removeAttribute(this.elem,'disabled');};_proto.disable=function(){js.dom.setAttribute(this.elem,'disabled','disabled');};_proto.isHidden=function(){return false;};_proto.detach=function(){for(var i in this.els){this.els[i].remove();}
this.els=[];};_proto.reset=function(){return this.setValue(this.emptyValue);};_proto.getValue=function(){this.read();return this.value;};_proto.getValueText=function(){return this.marshal(this.value);};_proto.setValue=function(value){this.value=value;this.write();return this;};_proto.sync=function(){this.read();this.write();return this;};_proto.read=function(){var ctrlValue=js.dom.getValue(this.elem);this.value=this.unmarshal(js.util.firstDefined(ctrlValue,''));return this;};_proto.write=function(){js.dom.setValue(this.elem,this.marshal(this.value));return this;};_proto.marshal=function(dataValue){var ctrlValue=dataValue;return ctrlValue;};_proto.unmarshal=function(ctrlValue){var dataValue=ctrlValue;return dataValue;};_proto.deserialize=function(storedValue){this.setValue(storedValue);return this;};_proto.serialize=function(){return this.getValue();};});js.extend('ext.share.input',function(js){var _package=this;var CInputBase=_package.InputBase;var _proto=js.lang.createMethods(CInputBase);_package.InputArray=function(params,elem){CInputBase.apply(this,[params,elem]);this.value=this.emptyValue=new Array();};_package.InputArray.prototype=_proto;_package.factory.set('array',_package.InputArray);_proto.createElements=function(){this.uiRoot=js.dom.createElement('DIV');return[this.uiRoot];};_proto.read=function(){return this;};_proto.write=function(){return this;};_proto.unmarshal=function(){return this.value;};_proto.marshal=function(){return this.value;};_proto.deserialize=function(storedValue){return this.setValue(storedValue||this.emptyValue);};_proto.serialize=function(){return this.getValue();};});js.extend('ext.share.input',function(js){var _package=this;var CInputBase=_package.InputBase;var _proto=js.lang.createMethods(CInputBase);_package.InputHidden=function(params){CInputBase.apply(this,[params]);this.value=this.emptyValue=new String();this.elements=this.createElements();};_package.InputHidden.prototype=_proto;_package.factory.set('hidden',_package.InputHidden);_proto.createElements=function(){return[this.attach(js.dom.createElement('INPUT',{'type':'hidden'}))];};_proto.isHidden=function(){return true;};});js.extend('ext.share.input',function(js){var _package=this;var CInputBase=_package.InputBase;var _proto=js.lang.createMethods(CInputBase);_package.InputText=function(params,elem){CInputBase.apply(this,[params,elem]);this.value=this.emptyValue=new String();};_package.InputText.prototype=_proto;_package.factory.set('text',_package.InputText);_proto.deserialize=function(storedValue){this.setValue(js.data.entities.encode(storedValue));return this;};_proto.serialize=function(){return js.data.entities.decode(this.getValue());};});js.extend('ext.share.input',function(js){var _package=this;var CInputBase=this.InputBase;var _proto=js.lang.createMethods(CInputBase);_package.InputBoolean=function(params){CInputBase.apply(this,[params]);var paramValue=this.getParameter('value');this.value=this.emptyValue=new Boolean(paramValue?paramValue:0);};_package.InputBoolean.prototype=_proto;_package.factory.set('bool',_package.InputBoolean);_package.factory.set('yesno',_package.InputBoolean);_package.factory.set('onoff',_package.InputBoolean);_proto.createElements=function(){var select=this.attach(js.dom.createElement('SELECT'));var displayTexts=this.getBooleanText();return js.dom.createElements(select,['OPTION='+displayTexts[1],{'value':1},'OPTION='+displayTexts[0],{'value':0}]);};_proto.getBooleanText=function(dataValue){var strTrue,strFalse;switch(this.getParameter('type')){case'yesno':strTrue='Yes';strFalse='No';break;case'onoff':strTrue='On';strFalse='Off';break;case'bool':default:strTrue='True';strFalse='False';}
return dataValue?dataValue.valueOf()?strTrue:strFalse:[strFalse,strTrue];};_proto.getValueText=function(){return this.getBooleanText(this.value);};_proto.marshal=function(dataValue){try{return dataValue.valueOf()?1:0;}catch(ex){js.console.log(ex);return 0;}};_proto.unmarshal=function(ctrlValue){return new Boolean(js.util.asInt(ctrlValue));};_proto.deserialize=function(storedValue){this.setValue(new Boolean(js.util.asInt(storedValue)));return this;};_proto.serialize=function(){return this.getValue().valueOf()?'1':'0';};});js.extend('ext.share.input',function(js){var _package=this;var CInputBase=this.InputBase;var _proto=js.lang.createMethods(CInputBase);_package.InputCheckbox=function(params){CInputBase.apply(this,[params]);this.value=this.emptyValue=new Boolean(false);this.uiCheckboxLabel=null;};_package.InputCheckbox.prototype=_proto;_package.factory.set('checkbox',_package.InputCheckbox);_proto.createElements=function(){var elems=[];var id=js.util.randomId('checkbox');var checkBox=this.attach(js.dom.createElement('INPUT.checkbox',{'id':id,'type':'checkbox'}));this.uiCheckboxLabel=js.dom.createElement('LABEL',{'for':id});var paramLabel=this.getParameter('label');if(paramLabel){js.dom.setValue(this.uiCheckboxLabel,paramLabel);}
return[checkBox,this.uiCheckboxLabel];};_proto.marshal=function(dataValue){return dataValue.valueOf();};_proto.unmarshal=function(ctrlValue){var bPrimitive=ctrlValue=='off'?false:ctrlValue?true:false;return new Boolean(bPrimitive);};_proto.deserialize=function(storedValue){this.setValue(new Boolean(storedValue));return this;};_proto.serialize=function(){return this.getValue().valueOf()?1:0;};});js.extend('ext.share.input',function(js){var _package=this;var CInputBase=_package.InputBase;_package.InputCheckboxes=function(params){CInputBase.apply(this,[params]);this.value=this.emptyValue='';this.inputs={};this.labels={};this.firstInput=undefined;this.elements=this.createElements();this.load(this.getParameter('options'));};var _proto=_package.InputCheckboxes.prototype=js.lang.createMethods(CInputBase);_package.factory.set('checkboxes',_package.InputCheckboxes);_proto.load=function(ds){if(!ds)return;if(js.util.isObject(ds)){this.createCheckboxes(ds);}else{env.hub.fetch(ds,[this.onLoad,this]);}};_proto.onLoad=function(dnode){this.createCheckboxes(dnode.toObject());};_proto.createCheckboxes=function(options){if(js.util.isAssociative(options)){for(var value in options){this.addCheckbox(value,options[value]);}}else if(js.util.isArray(options)){for(var i=0,opt;opt=options[i];i++){if(typeof(opt)==='string'){this.addCheckbox(opt,opt);}else{this.addCheckbox(opt.value,opt.text);}}}
if(this.value!==this.emptyValue)this.write();};_proto.createElements=function(){this.elem=js.dom.createElement('DIV.checkboxes');return[this.elem];}
_proto.addCheckbox=function(value,text){var checkboxInput=_package.factory.createObject('checkbox',{'label':text});checkboxInput.addActionListener('onChange',this.onInputChange,this);if(this.getParameter('layout')=="vertical"){js.dom.appendChild(this.elem,js.dom.createElement('DIV',checkboxInput.getElements()));}else{js.dom.appendChildren(this.elem,checkboxInput.getElements());}
this.inputs[value]=checkboxInput;this.labels[value]=text;if(!this.firstInput){this.firstInput=checkboxInput;}};_proto.onInputChange=function(action,input){this.read();this.executeClassAction('onChange',this);};_proto.getValueText=function(){var textValues=[];for(var value in this.inputs){var input=this.inputs[value];if(input.getValue().valueOf()){textValues.push(this.labels[value]);}}
return textValues.join(',');};_proto.deserialize=function(storedValue){this.setValue(storedValue.split(this.getParameter('delimeter',',')));return this;};_proto.serialize=function(){return this.value.join(this.getParameter('delimeter',','));};_proto.focus=function(){try{this.firstInput.focus();}catch(ex){}};_proto.select=function(){try{this.firstInput.select();}catch(ex){}};_proto.enable=function(){for(var key in this.inputs){this.inputs[key].enable();}};_proto.disable=function(){for(var key in this.inputs){this.inputs[key].disable();}};_proto.detach=function(){for(var key in this.inputs){this.inputs[key].detach();}};_proto.read=function(){var values=[];for(var value in this.inputs){var input=this.inputs[value];if(input.getValue().valueOf()){values.push(value);}}
this.value=values;return this;};_proto.write=function(){for(var key in this.inputs){var input=this.inputs[key];var bPrimitive=js.util.grep(key,this.value)!==null?true:false;input.setValue(new Boolean(bPrimitive));}};_proto.sync=function(){return this;};});js.extend('ext.share.input',function(js){var _package=this;var CInputBase=_package.InputBase;_package.InputRadioGroup=function(params){CInputBase.apply(this,[params]);this.inputs={};this.labels={};this.firstInput=undefined;this.groupName=js.util.randomId('radiogroup');this.elements=this.createElements();this.load(this.getParameter('options'));};var _proto=_package.InputRadioGroup.prototype=js.lang.createMethods(CInputBase);_package.factory.set('radio-group',_package.InputRadioGroup);_proto.load=function(ds){if(!ds)return;if(js.util.isObject(ds)){this.createRadios(ds);}else{env.hub.fetch(ds,[this.onLoad,this]);}};_proto.onLoad=function(dnode){this.createRadios(dnode.toObject());};_proto.createRadios=function(options){if(js.util.isAssociative(options)){for(var value in options){this.addRadio(value,options[value]);}}else if(js.util.isArray(options)){for(var i=0,opt;opt=options[i];i++){if(typeof(opt)==='string'){this.addRadio(opt,opt);}else{this.addRadio(opt.value,opt.text);}}}
if(this.value!==this.emptyValue)this.write();};_proto.createElements=function(){this.elem=js.dom.createElement('DIV.radio-group');return[this.elem];}
_proto.addRadio=function(value,text){var id=js.util.randomId('radio');var radioInput=js.dom.createElement('INPUT',{'id':id,'type':'radio','name':this.groupName,'onChange':[this.onInputChange,this]});this.els.push(new js.dom.EventListener(radioInput,'change',this.onInputChange,this));var label=js.dom.createElement('LABEL',{'for':id,'innerHTML':text});if(this.getParameter('layout')=="vertical"){js.dom.appendChild(this.elem,js.dom.createElement('DIV',[radioInput,label]));}else{js.dom.appendChildren(this.elem,[radioInput,label]);}
this.inputs[value]=radioInput;this.labels[value]=text;if(!this.firstInput){this.firstInput=radioInput;}};_proto.onInputChange=function(action,input){this.executeClassAction('onChange',this);};_proto.getValueText=function(){return this.labels[this.getValue()];};_proto.focus=function(){try{this.firstInput.focus();}catch(ex){}};_proto.select=function(){try{this.firstInput.select();}catch(ex){}};_proto.enable=function(){for(var key in this.inputs){var elem=this.inputs[key];js.dom.removeAttribute(elem,'disabled');}};_proto.disable=function(){for(var key in this.inputs){var elem=this.inputs[key];js.dom.setAttribute(elem,'disabled','disabled');}};_proto.read=function(){this.value=this.emptyValue;for(var key in this.inputs){var elem=this.inputs[key];var isChecked=js.dom.getValue(elem);if(js.dom.getValue(elem)){this.value=key;break;}}
return this;};_proto.write=function(){var elem=this.inputs[this.value];if(elem)js.dom.setValue(elem,true);};_proto.sync=function(){return this;};});js.extend('ext.share.input',function(js){var _package=this;var CInputBase=_package.InputBase;var _proto=js.lang.createMethods(CInputBase);_package.InputTextarea=function(params,elem){CInputBase.apply(this,[params,elem]);this.value=this.emptyValue=new String();};_package.InputTextarea.prototype=_proto;_package.factory.set('textarea',_package.InputTextarea);_proto.createElements=function(){var textarea=this.attach(js.dom.createElement('TEXTAREA'));var handle=js.dom.createElement('DIV#resize-handle',{'innerHTML':'='});var resize=new js.ext.share.ui.ResizeElement(textarea,handle);resize.setParameter('resize_width',false);return js.dom.createElements('DIV#input-textarea',[textarea,handle]);};_proto.deserialize=function(storedValue){this.setValue(js.data.entities.encode(storedValue));return this;};_proto.serialize=function(){return js.data.entities.decode(this.getValue());};});js.extend('ext.share.input',function(js){var _package=this;var CInputBase=this.InputBase;var _proto=js.lang.createMethods(CInputBase);var _defaultParameters={'digits':2};_package.InputDecimal=function(params){CInputBase.call(this,_defaultParameters);this.overlayParameters(params);this.value=this.emptyValue=new Number();};_package.InputDecimal.prototype=_proto;_package.factory.set('decimal',_package.InputDecimal);_proto.marshal=function(dataValue){return dataValue.toFixed(this.getParameter('digits'));};_proto.unmarshal=function(ctrlValue){return new Number(ctrlValue);};_proto.deserialize=function(storedValue){this.setValue(new Number(storedValue));return this;};_proto.serialize=function(){return this.getValue().toFixed(this.getParameter('digits'));};});js.extend('ext.share.input',function(js){var _package=this;var CInputBase=this.InputBase;var _proto=js.lang.createMethods(CInputBase);_package.InputDate=function(params){CInputBase.apply(this,[params]);this.format=this.getParameter('format')||'m/d/yyyy';this.invalidValue=new Date(0);this.value=this.emptyValue=new Date();};_package.InputDate.prototype=_proto;_package.factory.set('date',_package.InputDate);_proto.marshal=function(dataValue){try{return js.date.format(dataValue,this.format);}catch(ex){js.console.log(ex);return js.date.format(this.invalidValue,this.format);}};_proto.unmarshal=function(ctrlValue){if(!js.util.defined(ctrlValue))ctrlValue='';var now=new Date();var parts=ctrlValue.match(/(\d+)/g);var date;if(parts){var m=parts[0]||now.getMonth();var d=parts[1]||now.getDate();var y=parts[2]||now.getFullYear();var yyyy;y=js.util.pad(new String(y),2);var len=4-y.length;if(len<0)yyyy=y.substr(0,4);if(len==0)yyyy=y;if(len>0){var prefix=new String(now.getFullYear()).substr(0,len);yyyy=prefix+y;}
m=m-1;return new Date(yyyy,m,d);}else{return now;}};_proto.deserialize=function(storedValue){this.setValue(new Date(storedValue));return this;};_proto.serialize=function(){return this.getValue().toUTCString();};_proto.setValue=function(value){if(Object.prototype.toString.call(value)==="[object Date]"){if(isNaN(value.getTime())){value=this.invalidValue;}}else{value=this.emptyValue;}
return CInputBase.prototype.setValue.call(this,value);};});js.extend('ext.share.input',function(js){var _package=this;var CInputBase=this.InputBase;var _proto=js.lang.createMethods(CInputBase);_package.InputDateTime=function(params){CInputBase.apply(this,[params]);this.dateFormat=this.getParameter('dateFormat')||'m/d/yyyy';this.timeFormat=this.getParameter('timeFormat')||'h:MM TT';this.invalidValue=new Date(0);this.value=this.emptyValue=new Date();};_package.InputDateTime.prototype=_proto;_package.factory.set('datetime',_package.InputDateTime);_proto.createElements=function(){this.dateElement=this.attach(js.dom.createElement('INPUT.datetime.date',{'type':'text'}));this.timeElement=this.attach(js.dom.createElement('INPUT.datetime.time',{'type':'text'}));return[this.dateElement,this.timeElement];};_proto.read=function(){var dateStr=js.dom.getValue(this.dateElement);var timeStr=js.dom.getValue(this.timeElement);this.value=this.unmarshal(dateStr,timeStr);return this;};_proto.getValueText=function(){var dateString=this.marshal(this.value,this.dateFormat);var timeString=this.marshal(this.value,this.timeFormat);return dateString+' '+timeString;};_proto.write=function(){var dateString=this.marshal(this.value,this.dateFormat);var timeString=this.marshal(this.value,this.timeFormat);if(dateString!=js.dom.getValue(this.dateElement)){js.dom.setValue(this.dateElement,dateString);}
if(timeString!=js.dom.getValue(this.timeElement)){js.dom.setValue(this.timeElement,timeString);}
return this;};_proto.marshal=function(dataValue,format){try{return js.date.format(dataValue,format);}catch(ex){js.console.log(ex);return js.date.format(this.invalidValue,format);}};_proto.unmarshal=function(dateStr,timeStr){var date=this.parseDate(dateStr);var time=this.parseTime(timeStr);var datetime=new Date(date.getFullYear(),date.getMonth(),date.getDate(),time.getHours(),time.getMinutes(),0,0);return isNaN(datetime)?this.invalidValue:datetime;};_proto.parseDate=function(strValue){if(!js.util.defined(strValue))strValue='';var now=new Date();var parts=strValue.match(/(\d+)/g);var date;if(parts){var m=js.util.asInt(parts[0],true)||now.getMonth();var d=js.util.asInt(parts[1],true)||now.getDate();var y=js.util.asInt(parts[2],true)||now.getFullYear();var yyyy;y=js.util.pad(new String(y),2);var len=4-y.length;if(len<0)yyyy=y.substr(0,4);if(len==0)yyyy=y;if(len>0){var prefix=new String(now.getFullYear()).substr(0,len);yyyy=prefix+y;}
m=m-1;return new Date(yyyy,m,d);}else{return now;}};_proto.parseTime=function(strValue){if(!js.util.defined(strValue))strValue='';var time=new Date();var ampm=strValue.match(/([ap]m)/i);var parts=strValue.match(/(\d+)/g);var date;if(parts){var h=js.util.asInt(parts[0],true)||0;var m=js.util.asInt(parts[1],true)||0;if(ampm&&ampm[0].toLowerCase()=='pm')h+=12;time.setHours(h);time.setMinutes(m);}
return time;};_proto.deserialize=function(storedValue){this.setValue(new Date(storedValue));return this;};_proto.serialize=function(){return this.getValue().toUTCString();};_proto.setValue=function(value){if(Object.prototype.toString.call(value)==="[object Date]"){if(isNaN(value.getTime())){value=this.invalidValue;}}else{value=this.emptyValue;}
return CInputBase.prototype.setValue.call(this,value);};});js.extend('ext.share.input',function(js){var _package=this;var CInputBase=this.InputBase;var _proto=js.lang.createMethods(CInputBase);var _defaultParameters={'digits':2};_package.InputCurrency=function(params,digits){CInputBase.call(this,_defaultParameters);this.overlayParameters(params);this.value=this.emptyValue=new Number();};_package.InputCurrency.prototype=_proto;_package.factory.set('currency',_package.InputCurrency);_proto.marshal=function(dataValue){return'$'+dataValue.toFixed(this.getParameter('digits'));};_proto.unmarshal=function(ctrlValue){var parts=ctrlValue.match(/^([^\.\d+-])?\s*(.*?)\s*([A-Z]{2,3})?$/);if(parts){var symbol=parts[1];var amount=parts[2];var code=parts[3];return new Number(amount);}else{return new Number(ctrlValue);}};_proto.deserialize=function(storedValue){this.setValue(new Number(storedValue));return this;};_proto.serialize=function(){return this.getValue().toFixed(this.getParameter('digits'));};});js.extend('ext.share.input',function(js){var _package=this;var CInputBase=this.InputBase;var _proto=js.lang.createMethods(CInputBase);_package.InputInteger=function(params){CInputBase.apply(this,[params]);this.value=this.emptyValue=new Number();};_package.InputInteger.prototype=_proto;_package.factory.set('integer',_package.InputInteger);_proto.marshal=function(dataValue){return dataValue.toFixed();};_proto.unmarshal=function(ctrlValue){return new Number(ctrlValue);};_proto.deserialize=function(storedValue){this.setValue(new Number(storedValue));return this;};_proto.serialize=function(){return this.getValue().valueOf();};});js.extend('ext.share.input',function(js){var _package=this;var CInputBase=js.ext.share.input.InputBase;_package.InputSelect=function(params){CInputBase.apply(this,[params]);this.optionNodes={};this.elements=this.createElements();this.load(this.getParameter('options'));};var _proto=_package.InputSelect.prototype=js.lang.createMethods(CInputBase);_package.factory.set('select',_package.InputSelect);_proto.createElements=function(){return[this.attach(js.dom.createElement('SELECT'))];}
_proto.getValueText=function(){try{var ctrlValue=this.marshal(this.value);var text=this.optionNodes[ctrlValue];return js.util.isDefined(text)?text:'';}catch(ex){return'';}};_proto.load=function(ds){if(!ds)return;if(js.util.isObject(ds)){this.createOptions(ds);}else{env.hub.fetch(ds,[this.onLoad,this]);}};_proto.onLoad=function(dnode){this.createOptions(dnode.toObject());};_proto.createOptions=function(options){if(js.util.isAssociative(options)){for(var value in options){this.addItem(value,options[value]);}}else if(js.util.isArray(options)){for(var i=0,opt;opt=options[i];i++){if(typeof(opt)==='string'){this.addItem(opt,opt);}else{this.addItem(opt.value,opt.text);}}}
if(this.value!==this.emptyValue)this.write();};_proto.addItem=function(value,text){var option=js.dom.createElement('OPTION',{'value':value,'innerHTML':text});js.dom.appendChild(this.elem,option);this.optionNodes[value]=text;};_proto.clear=function(){this.optionNodes={};js.dom.removeChildren(this.elem);return this.setValue(this.emptyValue);};});js.extend('ext.share.input',function(js){var _package=this;var CInputBase=this.InputBase;var CListView=js.ext.share.data.view.ListView;var CListViewItem=js.ext.share.data.view.ListViewItem;var CParameters=js.impl.Parameters;function CSelect(params){CParameters.call(this,{'displayField':'name'});CListView.call(this);this.overlayParameters(params);};var Select=CSelect.prototype=js.lang.createPrototype(CParameters,CListView);Select.createElements=function(){return js.dom.createElements('SELECT',['OPTION',{'value':'','innerHTML':''}]);};Select.createLayer=function(mnode,layerName){if(!mnode.getDataNode().isDataContainer())return;var layerClass=mnode===this.model?js.data.NodeLayer:this.getItemClass()
return new layerClass(mnode,layerName,this);};function COption(){CListViewItem.apply(this,arguments);this.displayDatum=null;};var Option=COption.prototype=js.lang.createPrototype(CListViewItem);Option.getDisplayText=function(){return this.displayDatum?this.displayDatum.toString():'';};Option.createElements=function(){return js.dom.createElements('OPTION');};Option.onAdopted=function(){var k=this.view.getParameter('displayField')||'name';var elt=this.getElements()[0];js.dom.setAttribute(elt,'value',this.node.id);this.displayDatum=this.getDataNode().getValue(k);if(this.displayDatum){this.displayDatum.tie(elt,['innerHTML']);}else{js.dom.setValue(elt,'!Missing target field: '+k);}
CListViewItem.prototype.onAdopted.apply(this,arguments);};Option.onOrphaned=function(){CListViewItem.prototype.onOrphaned.apply(this,arguments);};_package.InputSelectFrom=function(params){CInputBase.apply(this,[params]);this.value=this.emptyValue=null;this.widget=new CSelect(params);this.widget.setItemClass(COption);this.widget.setLayerName('select-from');this.load();};var _proto=_package.InputSelectFrom.prototype=js.lang.createMethods(CInputBase);_package.factory.set('select-from',_package.InputSelectFrom);_proto.createElements=function(){this.uiSelect=this.widget.getElements()[0];var paramSize=this.getParameter('size');if(paramSize){js.dom.setAttribute(this.uiSelect,'size',paramSize);}
return[this.attach(this.uiSelect)];};_proto.getValueText=function(){try{var option=this.value.getLayer(this.widget.getLayerName());return option.getDisplayText();}catch(ex){return'';}};_proto.marshal=function(dataValue){var ctrlValue=dataValue?dataValue.id:'';return ctrlValue;};_proto.unmarshal=function(ctrlValue){try{var value=null;this.widget.getModel().walk(function(mnode){if(mnode.id==ctrlValue){value=mnode;return this.BREAK;}});return value;}catch(ex){return this.emptyValue;}};_proto.deserialize=function(storedValue){var value=this.emptyValue;try{this.widget.getModel().walk(function(mnode){if(mnode.getDataNode().getAddress()==storedValue){value=mnode;return this.BREAK;}});}catch(ex){}
this.setValue(value);return this;};_proto.serialize=function(){try{return this.getValue().getDataNode().getAddress();}catch(ex){return'';}};_proto.load=function(){var ds=this.getParameter('dataSource')||this.getParameter('options');if(!ds)return;env.hub.get(ds,[this.onLoad,this]);};_proto.onLoad=function(dnode){if(!dnode)throw new Error('InputSelectFrom: Cannot load data source');this.widget.load(dnode);if(this.value!==this.emptyValue)this.write();};});js.extend('ext.share.input',function(js){var _package=this;var CInputBase=this.InputBase;var _proto=js.lang.createMethods(CInputBase);_package.InputPassword=function(params){CInputBase.apply(this,[params]);};_package.InputPassword.prototype=_proto;_package.factory.set('password',_package.InputPassword);_proto.createElements=function(){return[this.attach(js.dom.createElement('INPUT.password',{'type':'password'}))];};});js.extend('ext.share.input',function(js){var _package=this;var CInputBase=this.InputBase;var _proto=js.lang.createMethods(CInputBase);var _defaultParameters={'digits':0};_package.InputPercent=function(params,digits){CInputBase.call(this,_defaultParameters);this.overlayParameters(params);this.value=this.emptyValue=new Number();};_package.InputPercent.prototype=_proto;_package.factory.set('percent',_package.InputPercent);_proto.marshal=function(dataValue){var value=new Number(dataValue.valueOf()*100);return value.toFixed(this.getParameter('digits'))+'%';};_proto.unmarshal=function(ctrlValue){var parts=ctrlValue.match(/^([\+\-\d\.]+)%?$/);var value;if(parts){var amount=parts[1];value=new Number(amount);}else{value=new Number(ctrlValue);}
return new Number(value/100);};_proto.deserialize=function(storedValue){this.setValue(new Number(storedValue));return this;};_proto.serialize=function(){return this.getValue().toFixed(this.getParameter('digits')+2);};});js.extend('web.admin.input',function(js){var _package=this;var CInputBase=js.ext.share.input.InputBase;_package.InputLatLng=function(params){CInputBase.apply(this,[params]);this.emptyValue=[0,0];this.value=[0,0];};var _proto=_package.InputLatLng.prototype=js.lang.createMethods(CInputBase);js.ext.share.input.factory.set('latlng',_package.InputLatLng);_proto.createElements=function(){this.latElement=this.attach(js.dom.createElement('INPUT.latlng.lat',{'type':'text'}));this.lngElement=this.attach(js.dom.createElement('INPUT.latlng.lng',{'type':'text'}));return[this.latElement,this.lngElement];};_proto.getValueText=function(){return this.serialize();};_proto.read=function(){var latStr=js.dom.getValue(this.latElement);var lngStr=js.dom.getValue(this.lngElement);this.value[0]=this.unmarshal(latStr);this.value[1]=this.unmarshal(lngStr);return this;};_proto.write=function(){var latStr=this.marshal(this.value[0]);var lngStr=this.marshal(this.value[1]);if(latStr!=js.dom.getValue(this.latElement)){js.dom.setValue(this.latElement,latStr);}
if(lngStr!=js.dom.getValue(this.lngElement)){js.dom.setValue(this.lngElement,lngStr);}
return this;};_proto.marshal=function(dataValue){return dataValue.toFixed(6);};_proto.unmarshal=function(strValue){if(!js.util.defined(strValue))strValue='';var value=NaN;var dmsFields=strValue.match(/(\d+)\D(\d+)\D([\d\.]+)\s*([NSEW])/i);if(dmsFields){var deg=dmsFields[1];var min=dmsFields[2];var sec=dmsFields[3];var hem=dmsFields[4].match(/[NE]/i)?1:-1;var dec=(deg*1)+(min/60)+(sec/3600);value=new Number(dec*hem);}else{value=parseFloat(strValue);}
return isNaN(value)?0:value;};_proto.deserialize=function(storedValue){var latlng=storedValue.split(',');var lat=parseFloat(latlng[0]);var lng=parseFloat(latlng[1]);if(isNaN(lat))lat=this.emptyValue[0];if(isNaN(lng))lng=this.emptyValue[1];this.setValue([lat,lng]);return this;};_proto.serialize=function(){var result=this.serializeValue(this.getValue());var empty=this.serializeValue(this.emptyValue);return result==empty?'':result;};_proto.serializeValue=function(value){var latStr=value[0].toFixed(6);var lngStr=value[1].toFixed(6);return latStr+','+lngStr;};_proto.setValue=function(value){if(!js.util.isArray(value)){value=js.util.clone(this.emptyValue);}
return CInputBase.prototype.setValue.call(this,value);};});js.extend('ext.share',function(js){var _package=this;var _base=js.action.ActionDispatcher;var _proto=js.lang.createMethods(_base);_package.FileSelector=function(switchlist){_base.apply(this);this.node=new js.data.Node();switchlist.addActionListener('onAdd',this.onAdd,this);switchlist.addActionListener('onRemove',this.onRemove,this);};_package.FileSelector.prototype=_proto;_proto.onAdd=function(action,switchable){switchable.addActionListener('onReady',this.doSelect,this);switchable.addActionListener('onHide',this.doDeselect,this);};_proto.onRemove=function(action,switchable){if(this.node.data&&this.node.data===switchable.getDataNode()){this.node.data=null;}};_proto.doSelect=function(action,switchable){this.node.data=switchable.getDataNode();this.executeAction('onSelect',this.node);};_proto.doDeselect=function(action,switchable){this.executeAction('onDeselect',this.node);this.node.data=null;};_proto.getSelected=function(){return this.node;};});js.extend('ext.share.filesystem',function(js){var CDataNode=js.data.Node;var CNode=this.Node=function(data,tree){CDataNode.apply(this);this.data=data;this.tree=tree;this.hasPopulated=false;this.alDataAction=this.data.addActionListener('*',this.onDataAction,this);};var _proto=this.Node.prototype=js.lang.createMethods(CDataNode);_proto.populate=function(){this.populateValues(this.data);};_proto.populateValues=function(data){if(!(data&&data.values)||this.hasPopulated)return;if(this.hasChildNodes()){var values=data.values();for(var i=0;i<values.length;i++){var value=values[i];var doInsert=true;var child=this.firstChild;while(child){if(child.data===value){doInsert=false;break;}
child=child.nextSibling;}
if(doInsert)this.insertChild(value);}}else{this.insertChildren(data.values());}
this.hasPopulated=true;};_proto.populateChildren=function(){for(var node=this.firstChild;node;node=node.nextSibling){node.populate();}};_proto.getDataNode=function(){return this.data;};_proto.getNodeByAddress=function(addr){if(!js.util.defined(addr))return;if(addr==this.data.getAddress())return this;return this.walk(function(n){var a=n.data.getAddress();if(addr.indexOf(a)!=0){return this.CONTINUE;}else if(a==addr){return n;}});};_proto.getNodeByData=function(data){return this.walk(function(n){if(n.data===data)return n;});};_proto.createNode=function(data){return new CNode(data,this.tree);};_proto.sortCompare=function(a,b){if(!(js.util.defined(a)&&js.util.defined(b)))return;var result=b.data.isDirectory()-a.data.isDirectory();return result==0?a.data.getKey().localeCompare(b.data.getKey()):result;};_proto.onDataAction=function(action,data){var args=js.util.args(arguments);switch(action.name){case'create':this.insertChild(data);break;case'usercreate':this.dispatchClassAction(action,this);break;case'update':if(action.updated.order){this.sort();}
this.dispatchAction(action,this);break;case'remove':if(data===this.getDataNode()){try{if(this.isSelected()){var newSelection=this.nextSibling||this.previousSibling;if(newSelection){newSelection.select();}else{this.deselect();}}}catch(ex){js.error.reportError(ex);}finally{this.parentNode.removeChild(this);this.tree.validateCwd();}}
break;case'status':this.dispatchAction(action,this,data);break;case'fetch':case'change':case'store':case'replace':default:if(false){var addr=data&&js.util.isFunction(data.getAddress)?data.getAddress():undefined;js.console.log('unhandled action "'+action.name+'" for: '+addr);}}};_proto.setAsCwd=function(){this.loadChildren();this.tree.setCwd(this);};_proto.expand=function(){if(this.canExpand()&&!this.isExpanded){this.loadChildren([function(data){this.isExpanded=true;this.dispatchAction('onExpand',this);},this]);}};_proto.loadChildren=function(cb){this.populateChildren();this.data.reload(cb);};_proto.collapse=function(){if(this.canCollapse()&&this.isExpanded){this.dispatchAction('onCollapse',this);this.isExpanded=false;}};_proto.toggleExpanded=function(){if(this.isExpanded){this.collapse();}else{this.expand();}};_proto.select=function(){this.tree.select(this);};_proto.deselect=function(){this.tree.deselect(this);};_proto.isSelected=function(){var me=this;function matchFunction(unk){return unk===me;}
return js.util.grep(matchFunction,this.tree.getSelection());};_proto.canDisplay=function(){var dnode=this.getDataNode();return dnode.isFile()||dnode.isDirectory()||dnode.getType()=='loading';};_proto.canExpand=function(){return this.data.isDirectory();};_proto.canCollapse=function(){return this.parentNode?true:false;};_proto.getName=function(){return this.data.getKey()||this.data.getAddress();};_proto.getType=function(){return this.data.getType();};_proto.getIconPath=function(){return this.data.getIcon();};_proto.getCrumbPath=function(){return this.getTargetAddress();};_proto.getTargetAddress=function(){return this.data.getAddress();};});js.extend('ext.share.filesystem',function(js){var CSelection=js.ext.share.Selection;var CTree=this.Tree=function(dnode,nodeClass){CSelection.apply(this);this.hub=dnode.getDataBridge();if(!nodeClass)nodeClass=js.ext.share.filesystem.Node;this.rootNode=new nodeClass(dnode,this);};var _proto=this.Tree.prototype=js.lang.createMethods(CSelection);_proto.expandNodeByAddress=function(addr,cb){this.hub.fetch(addr,[function(data){if(!data){if(cb)js.lang.callback(cb,this);return;}
var targetNode=this.rootNode.getNodeByAddress(data.getAddress());if(targetNode){var node=targetNode;while(node){node.expand();node=node.parentNode;}}
if(cb)js.lang.callback(cb,this,[targetNode]);},this]);};_proto.selectCwdByAddress=function(addr,cb){this.expandNodeByAddress(addr,[function(node){if(node)node.setAsCwd();if(cb)js.lang.callback(cb,this,[node]);},this]);};_proto.selectNodeByAddress=function(addr,cb){var selected=this.getSelected();if(selected){var selectedAddr=selected.data.getAddress();if(selectedAddr==addr)return;}
this.clearSelection();var paddr=js.data.addr_parent(addr);this.expandNodeByAddress(paddr,[function(pnode){if(!pnode){if(cb)js.lang.callback(cb,this);return;}
pnode.setAsCwd();var node=pnode.getNodeByAddress(addr);if(node)node.select();if(cb)js.lang.callback(cb,this,[node]);},this]);};_proto.validateCwd=function(){var node=this.getCwd();if(!node||node.parentNode)return;var addr=node.data.getAddress();while(!this.hub.getNodeByAddress(addr)){addr=js.data.addr_parent(addr);}
var node=this.rootNode.getNodeByAddress(addr);if(node)node.setAsCwd();};_proto.unload=function(){this.rootNode.removeAllChildren();};});js.extend('ext.share.filesystem.view',function(js){var CNodeLayer=js.data.NodeLayer;this.TreeViewLayer=function(node,name,view){this.view=view;CNodeLayer.apply(this,arguments);this.node.addActionListener('onExpand',this.onExpand,this);this.node.addActionListener('onCollapse',this.onCollapse,this);this.node.addActionListener('onSelect',this.onSelect,this);this.node.addActionListener('onSelectCwd',this.onSelectCwd,this);this.node.addActionListener('onDeselect',this.onDeselect,this);this.node.addActionListener('onDeselectCwd',this.onDeselectCwd,this);this.node.addActionListener('onUpdate',this.onUpdate,this);this.node.addActionListener('onStatus',this.onStatus,this);this.events=[];this.createUI();};var TreeViewLayer=this.TreeViewLayer.prototype=js.lang.createMethods(CNodeLayer);TreeViewLayer.onOrphaned=function(){CNodeLayer.prototype.onOrphaned.apply(this,arguments);this.removeUI();};TreeViewLayer.createUI=function(){this.extendUI();this.updateUI();};TreeViewLayer.extendUI=function(){};TreeViewLayer.updateUI=function(){};TreeViewLayer.insertUI=function(){};TreeViewLayer.removeUI=function(){};TreeViewLayer.onExpand=function(action,node){};TreeViewLayer.onCollapse=function(action,node){};TreeViewLayer.onSelect=function(action,node){};TreeViewLayer.onDeselect=function(action,node){};TreeViewLayer.onSelectCwd=function(action,node){};TreeViewLayer.onDeselectCwd=function(action,node){};TreeViewLayer.onUpdate=function(action,node){this.updateUI(action.updated);};TreeViewLayer.onAdopted=function(){CNodeLayer.prototype.onAdopted.call(this);this.insertUI();};TreeViewLayer.onReordered=function(){CNodeLayer.prototype.onReordered.call(this);this.insertUI();};TreeViewLayer.onStatus=function(action,node,stats){};});js.extend('ext.share.filesystem.view',function(js){var CParameters=js.impl.Parameters;this.TreeView=function(name,tree){CParameters.apply(this);this.name=name;this.tree=tree;tree.rootNode.addLayer(name,this);};var TreeView=this.TreeView.prototype=js.lang.createMethods(CParameters);TreeView.createLayer=function(node,name){if(node.canDisplay())return new this.Layer(node,name,this);};TreeView.getElements=function(){return[];};TreeView.Layer=js.ext.share.filesystem.view.TreeViewLayer;});js.extend('ext.share.filesystem.view',function(js){var CTreeView=js.ext.share.filesystem.view.TreeView;var CTreeViewLayer=js.ext.share.filesystem.view.TreeViewLayer;this.ListView=function(name,tree){this.tbody=js.dom.createElement('TBODY');this.thead=js.dom.createElement('THEAD',['TR',this.createHeaders()]);this.table=js.dom.createElement('TABLE.'+name+'.tree-list-view',[this.thead,this.tbody]);CTreeView.apply(this,arguments);};var ListView=this.ListView.prototype=js.lang.createMethods(CTreeView);ListView.getElements=function(){return[this.table];};ListView.createHeaders=function(){this.thIcon=js.dom.createElement('TH.icon');this.thName=js.dom.createElement('TH.name=Name');return[this.thIcon,this.thName]};ListView.Layer=function(node,name,view){this.nameSwapping=true;this.action='no-operation';this.selectEvent=null;CTreeViewLayer.apply(this,arguments);};var Layer=ListView.Layer.prototype=js.lang.createMethods(CTreeViewLayer);Layer.createColumns=function(){this.tdIcon=js.dom.createElement('TD.icon');this.tdName=js.dom.createElement('TD.name');return[this.tdIcon,this.tdName];};function _false(event){js.dom.stopEvent(event);return false;}
Layer.createUI=function(){this.columns=this.createColumns();this.tr=js.dom.createElement('TR',this.columns);this.events.push(new js.dom.EventListener(this.tr,'click',this.onUserSelect,this),new js.dom.EventListener(this.tr,'dblclick',this.onUserExpand,this),new js.dom.EventListener(this.tr,'select',_false),new js.dom.EventListener(this.tr,'selectstart',_false),new js.dom.EventListener(this.tr,'mousedown',_false),new js.dom.EventListener(this.tr,'dragstart',_false));this.uiIcon=js.dom.createElement('IMG.icon',{'width':'16','height':'16'});this.nameLinked=js.dom.createElement('A',{'onClick':[this.onUserExpand,this]});this.nameStatic=js.dom.createElement('SPAN');var name=this.nameSwapping?this.nameStatic:this.nameLinked;this.uiNameArea=js.dom.createElement('SPAN.name',[name]);js.dom.replaceChildren(this.tdIcon,[this.uiIcon]);js.dom.replaceChildren(this.tdName,[this.uiNameArea]);this.extendUI();this.updateUI();};Layer.extendUI=function(){};Layer.updateUI=function(){var addr=this.node.getTargetAddress();var name=this.node.getName();var icon=this.node.getIconPath();js.dom.setAttribute(this.nameLinked,'href',addr);js.dom.setAttribute(this.nameLinked,'title',addr);js.dom.setAttribute(this.nameLinked,'innerHTML',name);js.dom.setAttribute(this.nameStatic,'innerHTML',name);js.dom.setAttribute(this.uiIcon,'src',icon);};Layer.onSelectCwd=function(){var rows=[];var layer=this.firstChild;while(layer){rows.push(layer.tr);layer=layer.nextSibling;}
var tbody=this.view.tbody;js.dom.replaceChildren(tbody,rows);this.isExpanded=true;};Layer.insertUI=function(){if(this.view.tree.getCwd()===this.parentNode.node){try{if(this.nextSibling){js.dom.insertBefore(this.tr,this.nextSibling.tr);}else if(this.previousSibling){js.dom.insertAfter(this.tr,this.previousSibling.tr);}else{this.view.tbody.appendChild(this.tr);}}catch(ex){}}};Layer.removeUI=function(){js.dom.removeElement(this.tr);};Layer.onSelect=function(action,node){js.dom.addClassName(this.tr,'selected');if(this.nameSwapping){js.dom.replaceChildren(this.uiNameArea,[this.nameLinked]);}
if(!this.selectEvent)js.dom.scrollTo(this.tr);this.selectEvent=null;};Layer.onDeselect=function(action,node){js.dom.removeClassName(this.tr,'selected');if(this.nameSwapping){js.dom.replaceChildren(this.uiNameArea,[this.nameStatic]);}};Layer.onUserSelect=function(event){js.dom.stopEvent(event);this.selectEvent=event;if(!js.dom.hasClassName(this.tr,'selected')){this.node.select();}
if(this.node.data.getType()=='loading')return;this.node.data.fetch();};Layer.onUserExpand=function(event){js.dom.stopEvent(event);var action={'name':this.action,'event':event}
env.invokeHandler(action,this.node);};});js.extend('ext.share.filesystem.view',function(js){var CTreeView=js.ext.share.filesystem.view.TreeView;var CTreeViewLayer=js.ext.share.filesystem.view.TreeViewLayer;this.CrumbView=function(name,tree){this.div=js.dom.createElement('DIV.'+name+'.crumb-view');CTreeView.apply(this,arguments);};var CrumbView=this.CrumbView.prototype=js.lang.createMethods(CTreeView);CrumbView.getElements=function(){return[this.div];};CrumbView.Layer=function(node,name,view){CTreeViewLayer.apply(this,arguments);};var Layer=CrumbView.Layer.prototype=js.lang.createMethods(CTreeViewLayer);Layer.createUI=function(){this.parentElement=this.parentNode?this.parentNode.dd:this.view.div;this.uiIcon=js.dom.createElement('IMG.icon',{'width':16,'height':16});this.uiName=js.dom.createElement('SPAN.name');this.uiAnchor=js.dom.createElement('A',{'onClick':[this.onClick,this],'onMouseOver':[this.onMouseOver,this],'onMouseOut':[this.onMouseOut,this]},[this.uiIcon,this.uiName]);this.dt=js.dom.createElement('DT',[this.uiAnchor]);this.dd=js.dom.createElement('DD');this.dl=js.dom.createElement('DL',[this.dt,this.dd]);this.extendUI();this.updateUI();};Layer.updateUI=function(updated){var addr=this.node.getTargetAddress();var name=this.node.getName();js.dom.setValue(this.uiName,name);js.dom.setAttribute(this.uiAnchor,'href',addr);js.dom.setAttribute(this.uiAnchor,'title',addr);js.dom.setAttribute(this.uiIcon,'src',this.node.getIconPath());};Layer.removeUI=function(){js.dom.removeElement(this.dl);};Layer.onSelectCwd=function(){this.walk(function(child){child.setState('inactive');});this.show();};Layer.show=function(){this.setState('active');js.dom.replaceChildren(this.parentElement,[this.dl]);if(this.parentNode)this.parentNode.show();};Layer.setState=function(state){switch(state){case'inactive':js.dom.addClassName(this.dl,'inactive');js.dom.setOpacity(this.dt,.25);break;default:js.dom.removeClassName(this.dl,'inactive');js.dom.setOpacity(this.dt,1);}};Layer.onClick=function(event){js.dom.stopEvent(event);this.node.setAsCwd();};Layer.onMouseOver=function(event){};Layer.onMouseOut=function(event){};});js.extend('ext.share.filesystem.view',function(js){var _package=this;var CTreeViewLayer=js.ext.share.filesystem.view.TreeViewLayer;_package.SelectViewLayer=function(node,name,view){CTreeViewLayer.apply(this,arguments);this.isActive=false;this.selectEvent=null;};var _proto=_package.SelectViewLayer.prototype=js.lang.createMethods(CTreeViewLayer);_proto.onAdopt=function(child){CTreeViewLayer.prototype.onAdopt.apply(this,arguments);if(this.node.isExpanded){child.setState('active');child.setExpandedState();}};_proto.insertUI=function(){if(this.nextSibling){js.dom.insertBefore(this.dl,this.nextSibling.dl);}else if(this.previousSibling){js.dom.insertAfter(this.dl,this.previousSibling.dl);}else{js.dom.appendChild(this.parentElement,this.dl);}};_proto.createUI=function(){this.parentElement=this.parentNode?this.parentNode.dd:this.view.div;this.uiIcon=js.dom.createElement('IMG.icon.type',{'width':16,'height':16});this.uiName=js.dom.createElement('SPAN.name');this.uiAnchor=js.dom.createElement('A',{'onClick':[this.onClick,this],'onDblClick':[this.onDblClick,this]},[this.uiIcon,this.uiName]);var childNodes=[this.uiAnchor];if(this.node.canCollapse()){this.uiToggle=js.dom.createElement('IMG.icon.toggle',{'width':16,'height':16,'onClick':[this.onToggleClick,this]});childNodes.unshift(this.uiToggle);js.dom.addClassName(this.uiAnchor,'with-toggle');}
this.dt=js.dom.createElement('DT',childNodes);this.dd=js.dom.createElement('DD');this.dl=js.dom.createElement('DL',[this.dt,this.dd]);this.setState('inactive');if(!this.parentNode){js.dom.appendChild(this.parentElement,this.dl);}
this.extendUI();this.updateUI();};_proto.extendUI=function(){};_proto.updateUI=function(){var addr=this.node.getTargetAddress();js.dom.setValue(this.uiName,this.node.getName());js.dom.setAttribute(this.uiAnchor,'href',addr);js.dom.setAttribute(this.uiAnchor,'title',this.node.getCrumbPath());if(this.view.getParameter('showThumbnails')&&addr.match(/\.(jpe?g|gif|png)$/i)){js.dom.setAttribute(this.uiIcon,'src',addr+'?resize=16x16');}else{js.dom.setAttribute(this.uiIcon,'src',this.node.getIconPath());}
this.setExpandedState();};_proto.removeUI=function(){js.dom.removeElement(this.dl);};_proto.onExpand=function(){this.show();};_proto.onCollapse=function(){this.setExpandedState();var child=this.firstChild;while(child){child.setState('inactive');child=child.nextSibling;}};_proto.show=function(){this.setState('active');var child=this.firstChild;while(child){child.setState('active');child=child.nextSibling;}
if(this.parentNode)this.parentNode.show();};_proto.setState=function(state){this.setExpandedState();switch(state){case'inactive':js.dom.addClassName(this.dl,'inactive');this.isActive=false;break;default:this.isActive=true;js.dom.removeClassName(this.dl,'inactive');}};_proto.setExpandedState=function(){if(this.uiToggle){var iconName=this.node.canExpand()&&this.node.canCollapse()?this.node.isExpanded?'isexp.png':'canexp.png':'noexp.png';var src=js.hubb.getIconByName(iconName);js.dom.setAttribute(this.uiToggle,'src',src);}};_proto.onClick=function(event){js.dom.stopEvent(event);this.selectEvent=event;this.node.select();};_proto.onDblClick=function(event){js.dom.stopEvent(event);this.node.toggleExpanded();this.node.select();};_proto.onToggleClick=function(event){js.dom.stopEvent(event);this.node.toggleExpanded();};_proto.onSelect=function(action){js.dom.addClassName(this.dt,'selected');if(!this.selectEvent)js.dom.scrollTo(this.dt);this.selectEvent=null;};_proto.onDeselect=function(action){js.dom.removeClassName(this.dt,'selected');};});js.extend('ext.share.filesystem.view',function(js){var CTreeView=js.ext.share.filesystem.view.TreeView;this.SelectView=function(name,tree){this.div=js.dom.createElement('DIV.'+name+'.select-view');CTreeView.apply(this,arguments);};var _proto=this.SelectView.prototype=js.lang.createMethods(CTreeView);_proto.getElements=function(){return[this.div];};_proto.Layer=js.ext.share.filesystem.view.SelectViewLayer;});js.extend('ext.share.filesystem.input',function(js){var _package=this;var CInputBase=js.ext.share.input.InputBase;var CSelect=_package.Select=function(params){CInputBase.apply(this,[params]);this.elements=this.createElements();this.rootAddress=this.getParameter('rootAddress')||'/';this.value=this.emptyValue=null;this.selectOnLoad=null;this.alOnSelect=null;this.load();};var _proto=CSelect.prototype=js.lang.createMethods(CInputBase);js.ext.share.input.factory.set('select-filesystem-entry',CSelect);_proto.constructTree=function(dnode){return new js.ext.share.filesystem.Tree(dnode);};_proto.constructView=function(layerName,tree){return new js.ext.share.filesystem.view.SelectView(layerName,tree);};_proto.createElements=function(){this.uiRoot=js.dom.createElement('DIV');var paramStyles=this.getParameter('styles');if(paramStyles){js.dom.setStyles(this.uiRoot,paramStyles);}
return[this.uiRoot];};_proto.load=function(){if(this.hasLoaded)return;env.showLoading();env.hub.fetch(this.rootAddress,[function(dnode){if(!dnode)return;this.tree=this.constructTree(dnode);this.selectView=this.constructView('select-view',this.tree);this.selectView.setParameter('showThumbnails',this.getParameter('showThumbnails'));js.dom.replaceChildren(this.uiRoot,this.selectView.getElements());this.tree.rootNode.populate();this.tree.rootNode.setAsCwd();this.tree.rootNode.expand();this.hasLoaded=true;if(this.selectOnLoad){var addr=this.selectOnLoad;this.selectOnLoad=null;this.deserialize(addr);}else{this.listen();}
this.sync();env.hideLoading();},this]);};_proto.listen=function(){if(this.tree){this.alOnSelect=this.tree.addActionListener('onSelect',this.onSelect,this);}};_proto.mute=function(){if(this.alOnSelect){this.alOnSelect.remove();this.alOnSelect=null;}};_proto.onSelect=function(action,tnode){this.executeAction(action,tnode);this.executeClassAction('onChange',this);};_proto.read=function(){try{var selected=this.tree.getSelected();this.value=selected?selected.getDataNode():this.emptyValue;}catch(ex){}
return this;};_proto.write=function(){try{this.tree.selectNodeByAddress(this.value.getAddress());}catch(ex){}
return this;};_proto.deserialize=function(storedValue){try{if(!this.hasLoaded){this.selectOnLoad=storedValue;}else{var addr=this.localizeAddress(storedValue);if(addr){this.mute();this.tree.selectNodeByAddress(addr,[function(){this.listen();},this]);}else{this.tree.clearSelection();}}}catch(ex){js.error.reportError(ex);}
return this;};_proto.serialize=function(){var value=this.getValue();return value?value.getAddress():'';};_proto.localizeAddress=function(addr){if(addr&&addr.indexOf(this.rootAddress)!=0){addr=js.data.addr_join(this.rootAddress,addr);}
return addr;};});js.extend('ext.share.filesystem.input',function(js){var _package=this;var CInputBase=js.ext.share.input.InputBase;var _proto=js.lang.createMethods(CInputBase);_package.Image=function(params,elem){CInputBase.apply(this,[params,elem]);this.value=this.emptyValue=new String();};_package.Image.prototype=_proto;js.ext.share.input.factory.set('select-filesystem-image',_package.Image);_proto.createElements=function(){this.uiImage=js.dom.createElement('IMG.image-thumb',{'onClick':[this.onClickImage,this]});this.uiRoot=js.dom.createElement('DIV',[this.uiImage,'BUTTON=Browse',{'onClick':[this.onClickBrowse,this]}]);return[this.uiRoot];};_proto.read=function(){return this;};_proto.write=function(){var src=this.value&&(this.value.length>0)?this.value:'/res/icons/16x16/status/image-missing.png';var url=new js.http.Location(src);url.addParameter('resize','x50');js.dom.setAttribute(this.uiImage,'src',url.getHref());return this;};_proto.unmarshal=function(){return this.value;};_proto.marshal=function(){return this.value;};_proto.deserialize=function(storedValue){return this.setValue(storedValue||this.emptyValue);};_proto.serialize=function(){return this.getValue();};_proto.onClickBrowse=function(event){var selectDialog=env.dialogs.get('ext-share-dialog-filesystem-select');selectDialog.run({'value':this.value,'schema':{'fields':[{'type':'select-filesystem-entry','name':'dnode','input':{'rootAddress':this.getParameter('rootAddress'),'showThumbnails':true}}]}},[this.onSelectImage,this]);};_proto.onSelectImage=function(action,values){var selected=values.dnode;this.setValue(selected.getAddress());this.executeClassAction('onChange',this);};_proto.onClickImage=function(event){};});js.extend('ext.share.filesystem.input',function(js){var _package=this;var CInputBase=js.ext.share.input.InputArray;var _proto=js.lang.createMethods(CInputBase);_package.ImageList=function(params,elem){CInputBase.apply(this,[params,elem]);};_package.ImageList.prototype=_proto;js.ext.share.input.factory.set('image-list',_package.ImageList);});js.extend('ext.share.filesystem.input.editors',function(js){var _package=this;var CBaseView=js.ext.share.data.view.ListViewItem;_package.ImageItem=function(mnode,name,view){CBaseView.apply(this,arguments);this.als=[this.getDataNode().addActionListener('change',this.onDataChange,this)];this.updateElements();};var _proto=_package.ImageItem.prototype=js.lang.createPrototype(CBaseView);_proto.createElements=function(){this.uiImage=js.dom.createElement('IMG.image-item.'+this.layerName,{'onClick':[this.onClick,this]});return[this.uiImage];};_proto.updateElements=function(){var src=this.getDataNode().toString();var url=new js.http.Location(src);url.addParameter('resize','50x50');js.dom.setAttribute(this.uiImage,'src',url.getHref());};_proto.onDataChange=function(action,dnode){this.updateElements();};_proto.onClick=function(event){js.dom.stopEvent(event);this.node.select();};});js.extend('ext.share.filesystem.input.editors',function(js){var _package=this;var _defaultCss=null;function _initDefaultStyles(){if(_defaultCss)return;_defaultCss=new js.dom.StyleSheet({'position':'first'});_defaultCss.createRulesFromData([{"selector":"DIV.image-caption","rule":{"display":"none"}},{"selector":"DIV.image-caption.active","rule":{"display":"block"}}]);}
_package.ImageCaption=function(){_initDefaultStyles();this.hub=js.hubb.getInstance();this.imageUrl=null;this.listeners=[];this.createElements();};var _proto=_package.ImageCaption.prototype=js.lang.createPrototype();_proto.createElements=function(){this.statusIcon=new js.lsn.ui.StatusIcon();this.uiCaption=js.dom.createElement('INPUT.image-caption');this.uiSave=js.dom.createElement('BUTTON=Save',{'onClick':[this.onSaveClick,this]});this.uiRoot=js.dom.createElement('DIV.image-caption',['LABEL=Caption: ',this.uiCaption,this.uiSave,this.statusIcon.getRootElement()]);};_proto.getElements=function(){return[this.uiRoot];};_proto.setSelector=function(mnode){this.clearListeners();this.listeners.push(mnode.rootNode.addActionListener('select',[this.onSelect,this]),mnode.rootNode.addActionListener('deselect',[this.onDeselect,this]));};_proto.clearListeners=function(){while(this.listeners.length){listener=this.listeners.pop();listener.remove();}};_proto.onSelect=function(action,mnode){js.console.log("Selected: ",mnode);this.imageUrl=mnode.getDataNode().getValue();this.hub.fetch(this.imageUrl,[this.onImageFetch,this]);};_proto.onDeselect=function(action,mnode){js.console.log("Deselected: ",mnode);this.deactivate();};_proto.activate=function(dnode){this.target=this.getCaptionNode(dnode);this.statusIcon.showReady();js.dom.toggleClassName(this.uiRoot,'active',true);this.targetChangeListener=this.target.tie(this.uiCaption,['value']);};_proto.deactivate=function(){this.target=null;this.targetChangeListener.remove();js.dom.toggleClassName(this.uiRoot,'active',false);};_proto.onSaveClick=function(event){if(this.target){this.statusIcon.showActive();this.hub.store(this.target.getAddress(),js.dom.getValue(this.uiCaption),[function(dnode){if(dnode){this.statusIcon.showComplete();}else{this.statusIcon.showError();}},this]);}};_proto.onImageFetch=function(dnode){var addr=dnode.getAddress();if(this.imageUrl==addr){this.activate(dnode);};};_proto.getCaptionNode=function(dnode){var possibleKeys=['Description','ImageDescription','Caption-Abstract','Comment','UserComment','XPComment'];var exif=dnode.getValue('EXIF');for(var i=0,key;key=possibleKeys[i];i++){var sv=exif.getValue(key);if(sv)return sv;}
var sv=exif.setValue('Description',new js.hubb.ScalarNode(''));return sv;};});js.extend('ext.share.filesystem.input.editors',function(js){var _package=this;var CImageItem=_package.ImageItem;var CHandlerPool=js.action.HandlerPool;var _defaultCss=null;function _initDefaultStyles(){if(_defaultCss)return;_defaultCss=new js.dom.StyleSheet({'position':'first'});_defaultCss.createRulesFromData([{"selector":".list-view.image-list","rule":{"height":"80px"}},{"selector":"img.image-list.image-item","rule":{"border":"2px solid transparent"}},{"selector":"img.image-list.image-item.selected","rule":{"border":"2px dotted red"}}]);}
_package.ImageList=function(){CHandlerPool.call(this,env);this.listView=new js.ext.share.data.view.ListView();this.listView.setLayerName('image-list');this.listView.setItemClass(CImageItem);this.listMenu=new js.ext.share.ui.menu.PanelMenu(this);this.listMenu.load({"items":[{"type":"item","text":"Add Image","tooltip":"Add an image to this list","action":"add-image","icon":"/res/icons/16x16/nodes/file-png.png"},{"type":"item","target":"selection","text":"Delete","tooltip":"Delete an image from the list","action":"delete-image","icon":"/res/icons/16x16/actions/edit-delete2.png"},{"type":"item","text":"Move left","target":"selection","tooltip":"Change the order in which this item appears","action":"data-reorder-previous","icon":"/res/icons/16x16/actions/arrowLeft.png","matchTypes":["^data-"]},{"type":"item","text":"Move right","target":"selection","tooltip":"Change the order in which this item appears","action":"data-reorder-next","icon":"/res/icons/16x16/actions/arrowRight.png","matchTypes":["^data-"]}]});this.captionEditor=new js.ext.share.filesystem.input.editors.ImageCaption();};var _proto=_package.ImageList.prototype=js.lang.createPrototype(CHandlerPool);_proto.load=function(dnode){var mnode=this.listView.load(dnode);this.listMenu.setSelector(mnode);this.captionEditor.setSelector(mnode);};_proto.unload=function(){this.captionEditor.clearListeners();};_proto.getMenuElements=function(){return this.listMenu.getElements();};_proto.getElements=function(){return this.listView.getElements().concat(this.captionEditor.getElements());};});js.extend('ext.share.input.fields',function(js){var _package=this;var CFormField=js.ext.share.input.fields.FormField;_package.ImageList=function(data){this.uiRoot=js.dom.createElement('DIV');this.uiMenu=js.dom.createElement('DIV');CFormField.apply(this,[data]);};var _proto=_package.ImageList.prototype=js.lang.createMethods(CFormField);js.ext.share.input.fields.factory.set('image-list',_package.ImageList);_proto.onAdopted=function(){if(!this.childNodes){this.appendChildren(this.data.fields);}};_proto.getElements=function(){return[this.uiRoot];};_proto.isHidden=function(){return false;};_proto.focus=function(){};_proto.select=function(){};_proto.getMenuElements=function(){return[this.uiMenu];};_proto.tieValue=function(dnode,key,bAutoCommit){var storedValue=dnode.getValue(key);if(!storedValue){js.dom.replaceChildren(this.uiRoot,js.dom.createElements('P.error=Missing storage (no code to vivify)'));return;}
var editor=new js.ext.share.filesystem.input.editors.ImageList();js.dom.replaceChildren(this.uiRoot,editor.getElements());js.dom.replaceChildren(this.uiMenu,editor.getMenuElements());editor.registerHandler('add-image',this.onBrowseImage,this);editor.registerHandler('delete-image',this.onDeleteImage,this);editor.load(storedValue);return this.input.setValue(storedValue);};_proto.onBrowseImage=function(action,target){var selectDialog=env.dialogs.get('ext-share-dialog-filesystem-select');selectDialog.run({'schema':{'fields':[{'type':'select-filesystem-entry','name':'dnode','input':{'rootAddress':this.input.getParameter('rootAddress'),'showThumbnails':true}}]}},[this.onAddImage,this]);};_proto.onAddImage=function(action,values){var selected=values.dnode;var imageAddress=selected.getAddress();var arrayNode=this.input.value;var addr=arrayNode.getAddress()+'/<next>';arrayNode.getDataBridge().store(addr,imageAddress);};_proto.onDeleteImage=function(action,target){var addr=target.getDataNode().getAddress();var message='Are you sure you want to remove: '+addr;env.status.confirm(message,[function(result){if(result){var arrayNode=this.input.value;arrayNode.getDataBridge().remove(addr);}},this]);};});js.extend('ext.share.ui',function(js){var _package=this;var CBase=js.dom.ActionAdaptor;_package.ActionAdaptor=function(){CBase.apply(this,arguments);};var _proto=_package.ActionAdaptor.prototype=js.lang.createMethods(CBase);_proto.attach=function(elem){var action=null;switch(elem.tagName){case'A':var href=js.dom.getAttribute(elem,'href');if(href){action=new js.http.Location(href).getHash();}
break;case'BUTTON':action=js.dom.getAttribute(elem,'value');break;}
if(action){this.createListener(elem,action);}
return false;};});js.extend('ext.share.ui',function(js){var _hidden={'display':'none','visibility':'hidden'};var _visible={'display':'block','visibility':'visible'};var CActionDispatcher=js.action.ActionDispatcher;this.Switchable=function(name,elemId){CActionDispatcher.apply(this);this.name=name;this.elemMarker=null;this.elemId=elemId;this.elem=null;};var _proto=this.Switchable.prototype=js.lang.createMethods(CActionDispatcher);_proto.getName=function(){return this.name;};_proto.getElement=function(){return this.elem||js.dom.getElement(this.elemId);};_proto.reload=function(){this.executeClassAction('onReload',this,arguments);};_proto.show=function(appendTo,cb){if(!appendTo)appendTo=js.dom.getBody();if(!this.elem){this.elem=js.dom.getElement(this.elemId);if(this.elem.parentNode){this.elemMarker=js.dom.createElement('#comment');js.dom.insertBefore(this.marker,this.elem);}
js.dom.appendChild(appendTo,this.elem);}else{js.dom.setOpacity(this.elem,1);js.dom.setStyles(this.elem,_visible);}
this.executeClassAction('onShow',this);if(cb)js.lang.callback(cb);};_proto.hide=function(cb){if(this.elemMarker){js.dom.insertAfter(this.elem,this.marker);}else{js.dom.setOpacity(this.elem,0);js.dom.setStyles(this.elem,_hidden);}
this.executeClassAction('onHide',this);if(cb)js.lang.callback(cb);};_proto.load=function(){this.executeClassAction('onLoad',this,arguments);this.executeClassAction('onReady',this);};});js.extend('ext.share.ui',function(js){var CActionDispatcher=js.action.ActionDispatcher;var IItem=['getName','load','show','hide'];this.SwitchList=function(appendToId){CActionDispatcher.apply(this);this.appendToId=appendToId;this.selected=null;this.items=[];};var SwitchList=this.SwitchList.prototype=js.lang.createMethods(CActionDispatcher);SwitchList.add=function(item){js.lang.assert(js.lang.hasMethods(item,IItem),'item must be an IItem');this.items.push(item);item.addActionListener('onClose',this.onItemClose,this);this.executeAction('onAdd',item);return item;};SwitchList.onItemClose=function(action,item){this.remove(item);};SwitchList.remove=function(item){for(var i=0;i<this.items.length;i++){if(item===this.items[i]){this.items.splice(i,1);if(item===this.selected){this.deselect();this.executeAction('onRemove',item);var j=i;var next;while(j>=0&&!next){next=this.getAt(j--);}
if(next)this.select(next);}else{this.executeAction('onRemove',item);}
return i;}}};SwitchList.getAt=function(index){return this.items[index];};SwitchList.get=function(name){for(var i=0,item;item=this.items[i];i++){if(item.getName()==name)return item;}};SwitchList.select=function(){var args=js.util.args(arguments);var item=args.shift();var selected=this.getSelected();if(selected===item){if(selected){var func=selected.reload||selected.load;func.apply(selected,args);}}else{this.deselect();this.selected=item;item.show(js.dom.getElement(this.appendToId),[function(){this.executeAction('onSelect',item);item.load.apply(item,args);},this]);}
return this.selected;};SwitchList.deselect=function(){var item=this.getSelected();if(item){item.hide();this.selected=null;this.executeAction('onDeselect',item);return item;}else{return null;}};SwitchList.getSelected=function(){return this.selected;};});js.extend('ext.share.ui',function(js){var _package=this;_package.Tab=function(selector,target){this.selector=selector;this.target=target;this.allowClose=true;this.createUI();};var _proto=_package.Tab.prototype=js.lang.createMethods();_proto.getTarget=function(){return this.target;};_proto.getElements=function(){return[this.uiRoot];};_proto.createUI=function(){this.uiIcon=js.dom.createElement('IMG');this.uiMark=js.dom.createElement('SPAN.mark.cell=New Tab');this.uiAnchor=js.dom.createElement('A.cell',{'onClick':[this.onClick,this]},['SPAN.icon.cell',[this.uiIcon],this.uiMark]);this.uiClose=js.dom.createElement('A.close-tab',{'title':'Close this tab','onClick':[this.onClickClose,this]});this.uiRoot=js.dom.createElement('LI',[this.uiAnchor,this.uiClose]);};_proto.removeUI=function(action,target){js.dom.removeElement(this.uiRoot);};_proto.onSelect=function(action){js.dom.addClassName(this.uiAnchor,'sel');};_proto.onDeselect=function(action){js.dom.removeClassName(this.uiAnchor,'sel');};_proto.onClick=function(event){js.dom.stopEvent(event);this.selector.select(this.target);};_proto.onClickClose=function(event){js.dom.stopEvent(event);this.target.close();};});js.extend('ext.share.ui',function(js){var _package=this;_package.TabList=function(selector){this.selector=selector;this.uiRoot=null;this.tabs=[];this.createUI();this.selector.addActionListener('onAdd',this.onSelectorAdd,this);this.selector.addActionListener('onRemove',this.onSelectorRemove,this);this.selector.addActionListener('onSelect',this.onSelectorSelect,this);this.selector.addActionListener('onDeselect',this.onSelectorDeselect,this);};var _proto=_package.TabList.prototype=js.lang.createMethods();_proto.Tab=_package.Tab;_proto.getElements=function(){return[this.uiRoot];};_proto.createUI=function(){this.uiRoot=js.dom.createElement('OL.tablist');};_proto.get=function(target){for(var i=0;i<this.tabs.length;i++){if(this.tabs[i].getTarget()===target){return this.tabs[i];}}};_proto.add=function(tab){this.tabs.push(tab);js.dom.appendChildren(this.uiRoot,tab.getElements());return tab;};_proto.remove=function(tab){for(var i=0;i<this.tabs.length;i++){if(this.tabs[i]===tab){this.tabs.splice(i,1);tab.removeUI();return tab;}}};_proto.onSelectorAdd=function(action,target){var tab=new this.Tab(this.selector,target);this.add(tab);};_proto.onSelectorRemove=function(action,target){var tab=this.get(target);if(tab)this.remove(tab);};_proto.onSelectorSelect=function(action,target){var tab=this.get(target);if(tab)tab.onSelect(action,target);};_proto.onSelectorDeselect=function(action,target){var tab=this.get(target);if(tab)tab.onDeselect(action,target);};});js.extend('ext.share.ui.menu',function(js){var _package=this;var CDialog=js.lsn.ui.Dialog;_package.PopupMenu=function(){CDialog.apply(this,arguments);this.fxDuration=10;this.onShowEvent=null;};var _proto=_package.PopupMenu.prototype=js.lang.createMethods(CDialog);_proto.createUI=function(){this.position='absolute';this.uiRoot=js.dom.createElement('DIV.popup-menu',{'style':{'position':this.position,'z-index':'-1','top':'0','left':'0','margin':'0'}});js.dom.setOpacity(this.uiRoot,0);new js.dom.EventListener(this.uiRoot,'onClick',this.hide,this,[],true);return this.uiRoot;};_proto.show=function(event){this.onShowEvent=event;CDialog.prototype.show.call(this);};_proto.hide=function(event){CDialog.prototype.hide.call(this);};_proto.setPosition=function(){var elem=this.getRoot();var vp=env.layout.getViewport();var pointer=js.dom.getEventPointer(this.onShowEvent);var t=pointer.y-10;var l=pointer.x-10;var h=js.dom.getContentHeight(elem);var w=js.dom.getContentWidth(elem);var b=t+h;var r=l+w;t+=Math.min(vp.height-b,0)
l+=Math.min(vp.width-r,0)
t=Math.max(t,0);l=Math.max(l,0);js.dom.setStyle(elem,'top',t+'px');js.dom.setStyle(elem,'left',l+'px');};_proto.onDialogLoad=function(action){var mask=this.makeMasked();mask.setOpacity(0);};_proto.onDialogReady=function(action){this.autoHideListener=new js.dom.EventListener(this.mask.getRoot(),'onMouseOver',this.hide,this);};_proto.onDialogHide=function(action){this.autoHideListener.remove();};});js.extend('ext.share.ui.menu',function(js){var Package=this;var CNode=js.data.Node;Package.PanelNode=function CPanelNode(data,context,selector){CNode.call(this,data);this.als=[];this.createUI();this.setContext(context);this.setSelector(selector);};var PanelNode=Package.PanelNode.prototype=js.lang.createMethods(CNode);PanelNode.setContext=function(context){this.context=context;this.walk(function(child){child.setContext(context);});};PanelNode.setSelector=function(selector){while(this.als.length){var al=this.als.pop();al.remove();}
this.selector=selector;if(this.selector&&this.data&&this.data.target){switch(this.data.target){case'selection':this.setAvailable(false);this.als.push(this.selector.addActionListener('onSelect',this.onSelectTarget,this),this.selector.addActionListener('onDeselect',this.onDeselectTarget,this));break;case'cwd':this.als.push(this.selector.addActionListener('onChangeDirectory',this.onSelectTarget,this));break;default:throw new TypeError('invalid panel-menu target');}}
this.walk(function(child){child.setSelector(selector);});};PanelNode.createNode=function(data){js.lang.assert(this!==this.rootNode);return this.rootNode.createNode.apply(this.rootNode,arguments);};PanelNode.createLayer=function(node,name){for(var child=node.firstChild;child;child=child.nextSibling){this.loadItem(child.data,this.context,this.selector);}
return this;};PanelNode.load=function(items,context,selector){if(!items)return;var result=null;for(var i=0,item;item=items[i];i++){var child=this.loadItem(item,context,selector);if(!result)result=child;}
return result;};PanelNode.loadItem=function(item,context,selector){if(!item)return;var child=this.appendChild(item,context,selector);child.attachUI();child.load(item.items);return child;};PanelNode.attachUI=function(){js.dom.appendChildren(this.parentNode.getAppendage(),this.getElements());};PanelNode.onOrphan=function(node){js.dom.removeElements(node.getElements());node.removeAllChildren();};PanelNode.getAppendage=function(){return this.getElements()[0];};PanelNode.onSelectTarget=function(action,item){this.setAvailable(this.canDisplay(item));};PanelNode.onDeselectTarget=function(action,item){this.setAvailable(false);};PanelNode.canDisplay=function(item){return true;};PanelNode.setAvailable=function(isAvailable){var elements=this.getElements();if(isAvailable){for(var i=0,elem;elem=elements[i];i++){js.dom.removeClassName(elem,'panel-menu-unavailable');}}else{for(var i=0,elem;elem=elements[i];i++){js.dom.addClassName(elem,'panel-menu-unavailable');}}};});js.extend('ext.share.ui.menu',function(js){var Package=this;Package.CategoryNode=function CCategoryNode(data,context,selector){Package.PanelNode.apply(this,arguments);};var CategoryNode=Package.CategoryNode.prototype=js.lang.createMethods(Package.PanelNode);CategoryNode.createUI=function(){this.ol=js.dom.createElement('OL.action-menu');this.dt=js.dom.createElement('DT='+this.data.heading);this.dd=js.dom.createElement('DD',[this.ol]);};CategoryNode.getElements=function(){return this.data.heading?[this.dt,this.dd]:[this.dd];};CategoryNode.getAppendage=function(){return this.ol;};CategoryNode.canDisplay=function(target){try{for(var child=this.firstChild;child;child=child.nextSibling){if(child.canDisplay(target))return true;}}catch(ex){return false;}
return false;};});js.extend('ext.share.ui.menu',function(js){var Package=this;Package.ActionNode=function CActionNode(data,context,selector){Package.PanelNode.apply(this,arguments);};var ActionNode=Package.ActionNode.prototype=js.lang.createMethods(Package.PanelNode);ActionNode.createUI=function(){var innerElements=[];if(this.data.icon){innerElements.push(js.dom.createElement('IMG.icon',{'src':this.data.icon,'width':'16','height':'16'}));}
innerElements.push(js.dom.createElement('SPAN',{'innerHTML':this.data.text}));this.li=js.dom.createElement('LI',['A.action',{'onClick':[this.onItemClick,this],'title':this.data.tooltip||''},innerElements]);};ActionNode.getElements=function(){return[this.li];};ActionNode.getAppendage=function(){return this.li;};ActionNode.canDisplay=function(node){try{if(js.util.isFunction(this.data.match)){return this.data.match(node);}else if(js.util.defined(this.data.matchTypes)){var type=node.getType().toString();var matchTypes=this.data.matchTypes||[];var ok=false;for(var i=0;!ok&&i<matchTypes.length;i++){ok=type.match(matchTypes[i]);}
return ok?true:false;}else{return true;}}catch(ex){return false;}};ActionNode.onItemClick=function(event){js.dom.stopEvent(event);this.context.invokeHandler(this.getAction(),this.getActionTarget(),event);this.dispatchAction('onClick',this);};ActionNode.getAction=function(){var parts=this.data.action.split(':',1);return parts[0];};ActionNode.getActionTarget=function(){if(this.selector){var node=this;var target;while(!target&&node&&node!==this.rootNode){target=node.data.target;node=node.parentNode;}
if(target=='cwd'){return this.selector.getCwd()}else if(target=='selection'){return this.selector.getSelected();}}
var i=this.data.action.indexOf(':');var param=i<0?null:this.data.action.substr(i+1);return param;};});js.extend('ext.share.ui.menu',function(js){var Package=this;var CActionNode=Package.ActionNode;var CInitiator=js.ext.share.Initiator;Package.FileActionNode=function(data,context,selector){if(!js.util.isa(data,CInitiator)){data=new CInitiator(data);}
CActionNode.apply(this,arguments);};var FileActionNode=Package.FileActionNode.prototype=js.lang.createMethods(CActionNode);FileActionNode.canDisplay=function(node){try{return this.data.match(node);}catch(ex){return false;}};});js.extend('ext.share.ui.menu',function(js){var Package=this;var CActionNode=Package.ActionNode;Package.DataActionNode=function(data,context,selector){CActionNode.apply(this,arguments);};var DataActionNode=Package.DataActionNode.prototype=js.lang.createMethods(CActionNode);DataActionNode.canDisplay=function(node){try{var type=node.getDataNode().getType();var matchTypes=this.data.matchTypes;var ok=false;for(var i=0;!ok&&i<matchTypes.length;i++){ok=type.match(matchTypes[i]);}
return ok?true:false;}catch(ex){return false;}};});js.extend('ext.share.ui.menu',function(js){var Package=this;Package.PanelMenu=function CPanelMenu(context,selector){Package.PanelNode.call(this,null,context,selector);this.factory={'category':Package.CategoryNode,'file-action':Package.FileActionNode,'data-action':Package.DataActionNode,'item':Package.ActionNode};};var PanelMenu=Package.PanelMenu.prototype=js.lang.createMethods(Package.PanelNode);PanelMenu.registerType=function(name,klass){return this.factory[name]=klass;};PanelMenu.createNode=function(data,context,selector){var klass=this.factory[data.type];if(!klass){throw'Unsupported menu-data type: '+data.type;}
var node=new klass(data,context||this.context,selector||this.selector);node.addActionListener('onclick',function(action,node){this.dispatchAction('onItemClick',node);},this);return node;};PanelMenu.load=function(data){this.data=data.name;Package.PanelNode.prototype.load.call(this,data.items);};PanelMenu.unload=function(){this.removeAllChildren();};PanelMenu.createUI=function(){this.dl=js.dom.createElement('DL.panel-menu');};PanelMenu.removeUI=function(){js.dom.removeElements(this.getElements());};PanelMenu.getElements=function(){return[this.dl];};PanelMenu.getAppendage=function(){return this.dl;};});js.extend('ext.share.ui',function(js){var _package=this;var CDialog=js.lsn.ui.Dialog;_package.Overlay=function(){CDialog.apply(this,arguments);this.layoutClass='overlay-area';js.dom.addClassNames(this.getRoot(),this.layoutClass);};var _proto=_package.Overlay.prototype=js.lang.createMethods(CDialog);_proto.setPosition=function(){}
_proto.onDialogLoad=function(action){if(!this.uiParent){var screen=env.screens.getSelected();this.setParentElement(screen?screen.uiRoot:null);}
var mask=this.makeMasked();js.dom.addClassName(mask.getRoot(),'overlay-mask');};});js.extend('ext.share.ui',function(js){var _package=this;var CDialog=js.lsn.ui.Dialog;_package.Dialog=function(){CDialog.apply(this,arguments);this.hasClosed=false;this.addActionListener('onDialogLoad',this.initMoveable,this);this.addActionListener('onDialogShow',this.initContext,this);this.addActionListener('onDialogHide',this.onClose,this);env.layout.addActionListener('onPageResize',this.doResize,this);};var _proto=_package.Dialog.prototype=js.lang.createMethods(CDialog);_proto.doResize=function(action){this.center();};_proto.onClose=function(){this.hasClosed=true;};_proto.initMoveable=function(action){if(!this.uiParent){var screen=env.screens.getSelected();this.setParentElement(screen?screen.uiRoot:null);}
var handle=this.getElementById('move-handle');if(handle)this.makeMoveable(handle);};_proto.initContext=function(action){if(js.window.parent!==js.window)return;var screen=env.screens.getSelected();if(screen)this.setParentElement(screen.uiRoot);};});js.extend('ext.share.ui',function(js){var _package=this;var CDialog=js.ext.share.ui.Dialog;var CPerlModule=js.http.PerlModule;_package.RunDialog=function(){CPerlModule.apply(this);CDialog.apply(this,arguments);this.als=[];};var _proto=_package.RunDialog.prototype=js.lang.createMethods(CDialog,CPerlModule);_proto.getValues=function(){var inputs=this.getElementById('inputs');return js.dom.getValues(inputs);};_proto.serializeValues=function(){var inputs=this.getElementById('inputs');return js.dom.getValues(inputs);};_proto.submit=function(subName,params,cb){var values=js.util.overlay(this.serializeValues(),params);CPerlModule.prototype.submit.call(this,subName,values,[function(result,req,cb){if(result){var commands=result.getObject('commands');if(commands){env.hub.batch(commands);}}else{alert(req.xhr.responseText);}
if(cb)js.lang.callback(cb,this,[result,req]);this.executeAction('onServerResponse');},this,[cb]]);};_proto.onSend=function(req){env.showLoading();};_proto.onRecv=function(req){env.hideLoading();};_proto.onDialogShow=function(params){this.clearState();this.args=js.util.args(arguments);};_proto.run=function(params,cb){this.show(params);this.als.push(this.addActionListener('onOk',this.onOk,this));this.als.push(this.addActionListener('onApply',this.onApply,this));this.als.push(this.addActionListener('onCancel',this.onCancel,this));if(cb){this.als.push(this.addActionListener('onSubmit',cb));}};_proto.clearState=function(){delete this.args;while(this.als.length){this.als.pop().remove();}};_proto.onApply=function(action){this.executeAction('onSubmit',this.getValues());};_proto.onOk=function(action){this.onApply(action);this.hide();};_proto.onCancel=function(action){this.hide();};});js.extend('ext.share.ui',function(js){var _package=this;var CDialog=js.ext.share.ui.RunDialog;var CForm=js.ext.share.input.Form;_package.DialogForm=function(){CDialog.apply(this,arguments);this.form=new CForm();};var _proto=_package.DialogForm.prototype=js.lang.createMethods(CDialog);_proto.getValues=function(){return this.form.getValues();};_proto.serializeValues=function(){return this.form.serializeValues();};_proto.onDialogReady=function(){this.form.select();};});js.extend('ext.share.ui',function(js){var _package=this;var CDialog=js.lsn.ui.Dialog;_package.DialogStatus=function(){CDialog.apply(this,arguments);this.addActionListener('onDialogLoad',this.initDialog,this);env.layout.addActionListener('onPageResize',this.doResize,this);};var _proto=_package.DialogStatus.prototype=js.lang.createMethods(CDialog);_proto.doResize=function(action){this.center();};_proto.initDialog=function(action){this.makeModal();};});js.extend('ext.share.ui',function(js){var _package=this;var CParameters=js.impl.Parameters;var _defaultParameters={'min_height':0,'min_width':0,'resize_height':true,'resize_width':true};_package.ResizeElement=function(targetElement,handleElement){CParameters.call(this,js.util.clone(_defaultParameters));this.targetElement=js.dom.getElement(targetElement);this.handleElement=js.dom.getElement(handleElement);this.mask=new js.lsn.Mask({opacity:0,cursor:'s-resize'});this.dims={h:js.dom.getHeight(this.targetElement),w:js.dom.getWidth(this.targetElement)};this.dragHandle=new js.lsn.DragHandle(handleElement,{'onMouseMove':[this.onMouseMove,this],'onMouseDown':[this.onMouseDown,this],'onMouseUp':[this.onMouseUp,this]});js.dom.setStyle(handleElement,'cursor','s-resize');};var _proto=_package.ResizeElement.prototype=js.lang.createMethods(CParameters);_proto.onMouseMove=function(event,dh){js.dom.stopEvent(event);if(this.getParameter('resize_height')){var h=Math.max(this.dims.h+dh.delta_y,this.getParameter('min_height'));js.dom.setStyle(this.targetElement,'height',h+'px');}
if(this.getParameter('resize_width')){var w=Math.max(this.dims.w+dh.delta_x,this.getParameter('min_width'));js.dom.setStyle(this.targetElement,'width',w+'px');}};_proto.onMouseDown=function(event,dh){js.dom.stopEvent(event);this.dims.h=js.dom.getHeight(this.targetElement);this.dims.w=js.dom.getWidth(this.targetElement);if(!this.getParameter('min_height')){this.setParameter('min_height',this.dims.h);}
if(!this.getParameter('min_width')){this.setParameter('min_width',this.dims.w);}
this.mask.show();};_proto.onMouseUp=function(event,dh){js.dom.stopEvent(event);this.mask.hide();};});js.extend('ext.share',function(js){var CActionDispatcher=js.action.ActionDispatcher;var CHandlerPool=js.action.HandlerPool;this.Screen=function(props){js.util.overlay(this,props);CActionDispatcher.apply(this);CHandlerPool.apply(this);this.fxDuration=50;this.fxShow=null;this.fxHide=null;this.uiRoot=null;};var _proto=this.Screen.prototype=js.lang.createMethods(CActionDispatcher,CHandlerPool);_proto.getName=function(){return this.addr;};_proto.show=function(appendTo,cb){if(!this.uiRoot){this.uiRoot=js.dom.getElement(this.elem);this.fxShow=new js.fx.effects.Opacify(this.uiRoot,0,1,this.fxDuration);this.fxHide=new js.fx.effects.Opacify(this.uiRoot,1,0,this.fxDuration);}
js.dom.setOpacity(this.uiRoot,0);js.dom.removeClassName(this.uiRoot,'screen-hidden');this.fxShow.start([function(){this.dispatchClassAction('onShow',this);env.dispatchAction('onUpdateTitle',this.name);if(cb)js.lang.callback(cb);},this]);};_proto.hide=function(cb){this.fxHide.start([function(){js.dom.addClassName(this.uiRoot,'screen-hidden');this.dispatchClassAction('onHide',this);if(cb)js.lang.callback(cb);},this]);};_proto.load=function(params){this.dispatchClassAction('onLoad',this,[params]);};});js.extend('ext.share',function(js){var CActionDispatcher=js.action.ActionDispatcher;var CLayout=js.lsn.layout.ViewportLayout;var CPrompt=js.lsn.ui.Prompt;var CHandlerPool=js.action.HandlerPool;var CSharedArray=js.ext.share.SharedArray;this.Environment=function(){CActionDispatcher.apply(this);CHandlerPool.apply(this);this.layout=new CLayout();this.status=new CPrompt();this.screens=new js.ext.share.ui.SwitchList();this.dialogs=new js.ext.share.ObjectCache();this.initiators=new js.ext.share.SortedNode();this.hub=js.hubb.getInstance();this.schemas=new js.ext.share.data.model.SchemaLoader();this.layout.addActionListener('onPageLoad',this.onPageLoad,this);this.localStorage=new js.dom.LocalStorage();js.ext.share.data.loadHandlers(this);};var _proto=this.Environment.prototype=js.lang.createMethods(CActionDispatcher,CHandlerPool);_proto.registerHandler=function(name,handler,initiator){var handler=CHandlerPool.prototype.registerHandler.call(this,name,handler);if(initiator)this.registerInitiator(initiator);return handler;};_proto.registerInitiator=function(initiator){this.initiators.insertChild(initiator);};_proto.onPageLoad=function(action){var l=new js.http.Location();var addr=l.pathname.replace(/[^\/]+$/,'');var screen=this.screens.get(addr)||this.screens.getAt(0);if(screen){this.screens.select(screen);}};_proto.showLoading=function(){try{this.dialogs.get('status-loading').show();}catch(ex){}};_proto.hideLoading=function(){try{this.dialogs.get('status-loading').hide();}catch(ex){}};_proto.openBrowserTab=function(url,name,features){js.window.open(url,name,features);};_proto.openExtension=function(){};_proto.setPreference=function(realm,key,value){var obj=this.localStorage.getObject(realm)||{};obj[key]=value;this.localStorage.setObject(realm,obj);return value;};_proto.getPreference=function(realm,key){var obj=this.localStorage.getObject(realm)||{};return obj[key];};_proto.removePreference=function(realm,key){var obj=this.localStorage.getObject(realm)||{};delete obj[key];};});