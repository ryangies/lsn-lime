// Livesite (c) Livesite Networks, LLC.

js.extend('ext.editors.text',function(js){var _package=this;var _strings=[#:json ./strings.hf];var _helper=js.ext.share.contrib.codemirror;var _defaultParams={'mode':'text/plain','lineNumbers':true,'lineWrapping':false,'smartIndent':false,'electricChars':false,'autoClearEmptyLines':true,'extraKeys':{'Tab':'indentMore','Shift-Tab':'indentLess'},'document':js.document};var CAction=js.action.ActionDispatcher;var CEditor=_package.Editor=function(name){CAction.apply(this);this.name=name;this.conflict=false;this.editor=null;this.dnode=null;this.uiRoot=null;this.alUpdate=null;this.alBeforeUnload=env.layout.addActionListener('onPageBeforeUnload',this.onBeforeUnload,this);};var _proto=CEditor.prototype=js.lang.createMethods(CAction);_proto.onBeforeUnload=function(action,event){if(!this.dnode)return;if(!this.hasChanged())return;var addr=this.dnode.getAddress();var msg=_string.on_abandon+"("+addr+")";if(event)event.returnValue=msg;return msg;};_proto.getDataNode=function(){return this.dnode;};_proto.getUI=function(){return this.uiRoot||this.createUI();};_proto.createUI=function(){var cb=js.lang.createCallback(function(wrapper){this.uiRoot=wrapper;},this);var params=js.util.overlay({},_defaultParams);this.editor=CodeMirror(cb,params);var eltScroller=this.editor.getScrollerElement();var eltWrapper=this.uiRoot;js.dom.addClassName(eltWrapper,'layout1-area4');js.dom.addClassName(eltScroller,'layout1-area4-height');return this.uiRoot;};_proto.getValue=function(){return this.editor.getValue();};_proto.setValue=function(value){if(value===this.marshal()){return;}
this.cursor=this.editor.getCursor();var result=this.editor.setValue(value);this.editor.setCursor(this.cursor);this.editor.clearHistory();delete this.cursor;return result;};_proto.reload=function(){if(this.hasChanged()){env.status.confirm(_strings.on_discard,[function(result){if(result)this.doReload();},this]);return;}
this.doReload();};_proto.doReload=function(){var dnode=this.dnode;this.cursor=this.editor.getCursor();this.unload();this.load(dnode);};_proto.focus=function(){if(this.editor){this.editor.refresh();this.editor.focus();}};_proto.close=function(){try{if(this.hasChanged()){env.status.confirm(_strings.on_discard,[function(result){if(result)this.doClose();},this]);return;}}catch(ex){js.error.reportError(ex);}finally{this.doClose();}};_proto.doClose=function(){this.unload();this.hide();this.executeClassAction('onClose',this);};_proto.getName=function(){return this.name;};_proto.getTargetAddress=function(){try{return this.dnode.getAddress();}catch(ex){return null;}};_proto.show=function(appendTo,cb){appendTo.appendChild(this.getUI());js.dom.setOpacity(this.uiRoot,1);this.focus();this.executeClassAction('onShow',this);if(cb)js.lang.callback(cb);};_proto.hide=function(cb){js.dom.setOpacity(this.uiRoot,0);this.executeClassAction('onHide',this);if(cb)js.lang.callback(cb);};_proto.load=function(dnode){if(dnode&&dnode!==this.dnode){this.unload();env.showLoading();dnode.reload([this.onDataLoad,this]);}else{this.executeClassAction('onReady',this);}};_proto.unload=function(){this.dnode=null;if(this.editor)this.editor.setValue('');if(this.alUpdate)this.alUpdate.remove();if(this.alRemove)this.alRemove.remove();};_proto.onDataLoad=function(dnode){env.hideLoading();this.unmarshal(dnode);_helper.loadMode(_helper.getModeByType(dnode.getType(),dnode.getKey()),this.editor);this.alUpdate=dnode.addActionListener('update',this.onNodeUpdated,this);this.alRemove=dnode.addActionListener('remove',this.onNodeRemoved,this);this.executeClassAction('onLoad',this);this.executeClassAction('onReady',this);};_proto.onReady=function(){if(this.cursor){this.editor.setCursor(this.cursor);delete this.cursor;}
this.focus();};_proto.unmarshal=function(dnode){var content=dnode.getContent();var value=js.util.defined(content)?content:'';this.setValue(value);this.baseContent=this.marshal();this.conflict=false;this.dnode=dnode;};_proto.marshal=function(){return this.editor.getValue();};_proto.onNodeUpdated=function(action,dnode){if(!this.hasChanged()){this.unmarshal(dnode);}else{this.conflict=true;env.status.confirm(_strings.on_conflict,[function(result){if(result){this.unmarshal(dnode);}else{this.dispatchAction('conflict',dnode);}},this]);}};_proto.onNodeRemoved=function(action,dnode){this.doClose();};_proto.hasChanged=function(){var content=this.marshal();return this.baseContent!==content;};_proto.store=function(){if(this.conflict){env.status.confirm(_strings.on_overwrite,[this.doStore,this]);}else{this.doStore(true);}};_proto.doStore=function(confirmed){if(!confirmed)return;var cursor=this.editor.getCursor();var value=this.marshal();var addr=this.dnode.getAddress();this.baseContent=value;env.showLoading();this.dnode.getDataBridge().store(addr,value,[this.onStore,this,[cursor]]);};_proto.onStore=function(dnode,cursor){env.hideLoading();if(dnode){env.status.notify(_strings.on_saved);this.dispatchAction('saved',dnode);this.editor.setCursor(cursor);this.editor.focus();}else{env.status.alert(_strings.on_notsaved);this.dispatchAction('notsaved',dnode);}};});js.extend('ext.editors.text.ui',function(js){var _package=this;var CTab=js.ext.share.ui.Tab;_package.Tab=function(selector,target){CTab.apply(this,arguments);this.alOpen=target.addActionListener('onLoad',this.onTargetOpen,this);};var _proto=_package.Tab.prototype=js.lang.createMethods(CTab);_proto.onTargetOpen=function(action,target){if(!target)return;var dnode=target.getDataNode();if(this.alUpdate)this.alUpdate.remove();this.alUpdate=dnode.addActionListener('update',this.updateUI,this);this.updateUI(null,dnode);};_proto.updateUI=function(action,dnode){var addr=dnode.getAddress();js.dom.setAttribute(this.uiAnchor,'href',addr);js.dom.setAttribute(this.uiAnchor,'title',addr);js.dom.setAttribute(this.uiIcon,'src',dnode.getIcon());js.dom.setValue(this.uiMark,dnode.getKey());};_proto.removeUI=function(action,target){CTab.prototype.removeUI.call(this);if(this.alOpen)this.alOpen.remove();if(this.alUpdate)this.alUpdate.remove();};});js.extend('ext.editors.text',function(js){var CScreen=js.ext.share.Screen;var CHandlerPool=js.action.HandlerPool;this.Screen=function(){CHandlerPool.apply(this);CScreen.apply(this,arguments);this.hasInitialized=false;this.editors=new js.ext.share.ui.SwitchList('ext-editors-text-screen');this.tabs=new js.ext.share.ui.TabList(this.editors);this.tabs.Tab=js.ext.editors.text.ui.Tab;this.fileSelector=new js.ext.share.FileSelector(this.editors);this.kp=new js.dom.KeyPress();this.kp.addHandler('ctrl+s',this.onKeyPress,this,['ext-editors-text-file-save']);};var _proto=this.Screen.prototype=js.lang.createMethods(CHandlerPool,CScreen);_proto.initialize=function(){this.menu=new js.ext.share.ui.menu.PanelMenu(env,this.editors);this.menu.load([#:json ./menu.hf]);this.fileMenu=this.menu.loadItem([#:json ./file-menu.hf],env,this.fileSelector);env.initiators.addLayer('ext-editors-text-menu',this.fileMenu);js.dom.appendChildren('ext-editors-text-menu',this.menu.getElements());js.dom.replaceChildren('ext-editors-text-tabs',this.tabs.getElements());this.fileMenu.attachUI();this.hasInitialized=true;};_proto.load=function(params){if(!this.hasInitialized){this.initialize();this.restoreState([this.load,this,params]);return;}
if(params&&params.dnode){var dnode=params.dnode;var name=dnode.getAddress();var editor=this.editors.get(name);if(!editor){editor=new js.ext.editors.text.Editor(name);editor.addActionListener('onClose',this.onEditorClose,this);editor.addActionListener('onLoad',this.onEditorLoad,this);this.editors.add(editor);}
if(!params.background){this.editors.select(editor,dnode);}}};_proto.onEditorClose=function(action,editor){this.editors.remove(editor);this.saveState();};_proto.onEditorLoad=function(action,editor){this.saveState();};_proto.show=function(){CScreen.prototype.show.apply(this,arguments);this.kp.attach(js.window);var editor=this.editors.getSelected();if(editor)editor.focus();};_proto.hide=function(){this.kp.detach(js.window);CScreen.prototype.hide.apply(this,arguments);};_proto.onKeyPress=function(event,actionName){js.dom.stopEvent(event);env.invokeHandler(actionName,this.editors.getSelected());};_proto.saveState=function(){var openFiles=[];for(var i=0;i<this.editors.items.length;i++){var editor=this.editors.items[i];var addr=editor.getTargetAddress();if(addr)openFiles.push(addr);}
env.setPreference('ext-editors-text','open-files',openFiles);var editor=this.editors.getSelected();if(editor){var selected=editor.getTargetAddress();env.setPreference('ext-editors-text','selected',selected);}else{env.removePreference('ext-editors-text');}};_proto.restoreState=function(cb){var openFiles=env.getPreference('ext-editors-text','open-files');if(openFiles&&openFiles.length){var selected=env.getPreference('ext-editors-text','selected');var batch=[];for(var i=0;i<openFiles.length;i++){batch.push(['fetch',openFiles[i]]);}
env.hub.batch(batch,[function(results){for(var i=0;i<results.length;i++){var dnode=results[i].getResult();this.load({'dnode':dnode,'background':false});}
if(cb)js.lang.callback(cb);},this]);}else{if(cb)js.lang.callback(cb);}};});js.extend('ext.editors.text',function(js){env.registerHandler('ext-editors-text-file-save',function(action,editor){editor.store();editor.focus();});env.registerHandler('ext-editors-text-file-reload',function(action,editor){editor.reload();editor.focus();});env.registerHandler('ext-editors-text-file-close',function(action,editor){editor.close();});var _styleOptions={};_styleOptions['html']={'indent_size':2,'indent_char':' ','max_char':100,'brace_style':'expand','unformatted':['a','sub','sup','b','i','u']};_styleOptions['css']={'indent_size':2,'indent_char':' ','max_char':100};_styleOptions['js']={'indent_size':2,'indent_char':' ','max_char':100};env.registerHandler('ext-editors-text-buffer-beautify',function(action,editor){var dnode=editor.getDataNode();var type=dnode.getType();var buffer=editor.getValue();var result=buffer;if(/^file-text-ht/.test(type)){result=js.ext.share.contrib.beautifyHTML(buffer,_styleOptions['html']);}else if(/^file-text-css$/.test(type)){result=js.ext.share.contrib.beautifyCSS(buffer,_styleOptions['css']);}else if(/^file-text-js$/.test(type)){result=js.ext.share.contrib.beautifyJS(buffer,_styleOptions['js']);}else{env.status.alert('No beautifier available for: '+type);editor.focus();return;}
editor.setValue(result);editor.focus();});});